<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAPS 측정 체험하기</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans KR', 'sans-serif'], // 기본 sans 폰트를 Noto Sans KR로 지정
                    },
                    // 아동 친화적 색상 확장 (필요시)
                    colors: {
                        quiz: {
                            'bg': '#FFF9E6', // 연한 크림색 배경 (body)
                            'card-bg': '#FFFFFF',
                            'title': '#FF7043', // 주황색 계열 제목
                            'question': '#374151', // 질문 텍스트 (진회색)
                            'option-border': '#81C784', // 연두색 테두리 (선택지)
                            'option-bg': '#F1F8E9', // 매우 연한 연두색 (선택지 배경)
                            'option-hover-border': '#FFB74D',
                            'option-hover-bg': '#FFF3E0',
                            'option-selected-border': '#FF8A65', // 선택 시 테두리 (주황)
                            'option-selected-bg': '#FFE0B2', // 선택 시 배경 (살구)
                            'button-bg': '#66BB6A', // 녹색 계열 버튼
                            'button-text': '#FFFFFF',
                            'button-hover-bg': '#57A05A',
                            'feedback-correct-text': '#2E7D32',
                            'feedback-correct-bg': '#C8E6C9',
                            'feedback-incorrect-text': '#C62828',
                            'feedback-incorrect-bg': '#FFCDD2',
                            'feedback-info-text': '#FFA000',
                            'feedback-info-bg': '#FFF3E0',
                        }
                    },
                    // 텍스트 그림자 유틸리티 (커스텀 플러그인 없이 임의 값 사용)
                    textShadow: {
                        'DEFAULT': '2px 2px rgba(0,0,0,0.1)',
                        'title': '2px 2px #FFD180', // 제목용 그림자
                    },
                }
            },
            // group-has-* 유틸리티를 사용하기 위해 실험적 기능 활성화 (v3 방식, v4에서는 JIT에 통합될 수 있음)
            // Tailwind v4는 JIT가 기본이며, :has()는 CSS 표준 기능으로 점차 지원 확대
            // Play CDN에서는 일부 최신 JIT 기능이 제한될 수 있으나, group-has 구문은 시도해볼 가치가 있음
             variants: {
                extend: {
                    display: ['group-has'], // 예시: group-has-[:checked]:block
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        /* Tailwind CSS에서 직접 지원하지 않는 복잡한 패턴이나 효과를 위한 최소한의 CSS */
        body {
            /* 기본 배경색은 Tailwind config에서 quiz.bg로 설정 */
            /* 패턴이 필요하다면 여기에 추가할 수 있지만, 최대한 Tailwind 유틸리티 bg-[url(...)] 또는 bg-gradient-to-r 등을 활용 */
        }
        /* 임의의 텍스트 그림자 클래스 생성 (config에서 처리하지 못할 경우) */
        .text-shadow-title {
            text-shadow: 2px 2px theme('colors.quiz.title-shadow', '#FFD180'); /* config에서 색상 참조 시도 */
        }

        /* Tailwind v4 JIT는 arbitrary properties를 잘 지원하므로, 아래와 같이 HTML 내에서 직접 사용 가능: */
        /* class="[text-shadow:2px_2px_var(--tw-shadow-color)] shadow-yellow-300" */

        /* Pill 스크롤 컨테이너 스타일 */
        .pill-scroll-wrapper {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; /* iOS smooth scroll */
        }

        /* 스크롤바 스타일 (데스크탑) */
        .pill-scroll-wrapper::-webkit-scrollbar {
            height: 4px;
        }

        .pill-scroll-wrapper::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 2px;
        }

        .pill-scroll-wrapper::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 2px;
        }

        .pill-scroll-wrapper::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* 그라데이션 그림자 (스크롤 가능 표시) */
        .pill-scroll-container::before,
        .pill-scroll-container::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 20px;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pill-scroll-container::before {
            left: 0;
            background: linear-gradient(to right, #f9fafb, transparent);
        }

        .pill-scroll-container::after {
            right: 0;
            background: linear-gradient(to left, #f9fafb, transparent);
        }

        /* 모바일/태블릿에서 그라데이션 표시 */
        @media (max-width: 1024px) {
            .pill-scroll-container::before,
            .pill-scroll-container::after {
                opacity: 1;
            }
        }

    </style>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-6">
        <div class="max-w-4xl mx-auto">
            <!-- 페이지 헤더 -->
            <div class="mb-6 flex justify-between items-start">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">PAPS 측정 체험하기</h1>
                <div class="flex gap-3">
                    <!-- Excel Export 버튼 -->
                    <button id="export-excel-btn" class="hidden sm:inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-file-excel mr-2"></i>Excel 다운로드
                    </button>
                    <button id="export-excel-btn-mobile" class="inline-flex sm:hidden items-center justify-center w-10 h-10 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" aria-label="Excel 다운로드" disabled>
                        <i class="fas fa-file-excel text-lg"></i>
                    </button>
                    
                    <!-- Desktop/Tablet 버전 (텍스트 포함) -->
                    <a href="/" class="hidden sm:inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                        <i class="fas fa-home mr-2"></i>홈페이지로 돌아가기
                    </a>
                    <!-- Mobile 버전 (아이콘만) -->
                    <a href="/" class="inline-flex sm:hidden items-center justify-center w-10 h-10 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors" aria-label="홈페이지로 돌아가기">
                        <i class="fas fa-home text-lg"></i>
                    </a>
                </div>
                {% comment %} <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <p class="text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>체험 안내:</strong> 실제 PAPS 측정 기능을 체험해보세요. 입력한 데이터는 브라우저를 닫을 때까지 유지됩니다.
                    </p>
                    <p class="text-blue-600 text-sm mt-1">
                        현재 설정: 초등학교 4학년 기준으로 등급이 계산됩니다.
                    </p>
                </div> {% endcomment %}
            </div>

            <!-- 종목 선택 드롭다운 (Hidden) -->
            <div class="mb-6 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-running mr-2"></i>측정 종목 선택
                </label>
                <select id="activity-selector"
                        name="activity"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        hx-get="{% url 'physical_education:demo_activity' %}"
                        hx-trigger="change"
                        hx-target="#activity-content"
                        hx-include="this">
                    {% for activity in activities %}
                    <option value="{{ activity.name }}"
                            {% if activity == default_activity %}selected{% endif %}>
                        {{ activity.get_name_display }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- 종목 선택 Pill Buttons -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    <i class="fas fa-running mr-2"></i>측정할 종목을 선택하세요:
                </label>
                
                <!-- Desktop version (wrapped pills) -->
                <div class="hidden lg:flex flex-wrap gap-2">
                    {% for activity in activities %}
                    <button class="pill-btn px-4 py-2 rounded-full font-medium transition-colors {% if activity == default_activity %}bg-blue-600 text-white selected{% else %}bg-slate-100 text-slate-700{% endif %}"
                            data-activity="{{ activity.name }}"
                            hx-get="{% url 'physical_education:demo_activity' %}"
                            hx-trigger="click"
                            hx-target="#activity-content"
                            hx-vals='{"activity": "{{ activity.name }}"}'>
                        {{ activity.get_name_display }}
                    </button>
                    {% endfor %}
                </div>

                <!-- Mobile/Tablet version (horizontal scroll) -->
                <div class="pill-scroll-container relative lg:hidden">
                    <div class="pill-scroll-wrapper overflow-x-auto">
                        <div class="flex gap-2 w-max py-1">
                            {% for activity in activities %}
                            <button class="pill-btn px-4 py-2 rounded-full font-medium transition-colors {% if activity == default_activity %}bg-blue-600 text-white selected{% else %}bg-slate-100 text-slate-700{% endif %}"
                                    data-activity="{{ activity.name }}"
                                    hx-get="{% url 'physical_education:demo_activity' %}"
                                    hx-trigger="click"
                                    hx-target="#activity-content"
                                    hx-vals='{"activity": "{{ activity.name }}"}'>
                                {{ activity.get_name_display }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 종목별 측정 화면 (기존 템플릿 그대로 로드) -->
            <div id="activity-content">
                {% if default_activity %}
                    <div hx-get="{% url 'physical_education:demo_activity' %}?activity={{ default_activity.name }}"
                         hx-trigger="load"
                         hx-swap="outerHTML">
                        <div class="text-center py-8">
                            <div class="animate-pulse">
                                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                                <div class="text-gray-500">로딩 중...</div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-dumbbell text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">위에서 종목을 선택하면 측정을 시작할 수 있습니다.</p>
                    </div>
                {% endif %}
            </div>

            <!-- 도움말 섹션 -->
            <div class="mt-8 bg-gray-50 p-6 rounded-lg border">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">
                    <i class="fas fa-question-circle mr-2"></i>체험 가이드
                </h3>
                <div class="space-y-2 text-sm text-gray-600">
                    <div class="flex items-start">
                        <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                        <span>각 종목별로 실제 측정과 동일한 입력 화면을 제공합니다</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                        <span>입력한 데이터는 자동으로 등급이 계산되어 표시됩니다</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                        <span>새로고침을 하더라도 입력한 데이터가 유지됩니다</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-500 mt-1 mr-2"></i>
                        <span>체험 데이터는 실제 데이터베이스에 저장되지 않습니다</span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // 체험 모드 플래그 설정
        window.IS_DEMO = true;
        
        // 선택된 pill로 스크롤하는 함수
        function scrollToSelectedPill() {
            const container = document.querySelector('.pill-scroll-wrapper');
            const selectedPill = document.querySelector('.pill-btn.selected');
            
            if (container && selectedPill) {
                // 선택된 pill을 왼쪽 끝으로 스크롤 (16px 패딩 포함)
                const scrollLeft = selectedPill.offsetLeft - 16;
                container.scrollLeft = scrollLeft;
                
                console.log('Auto-scrolled to selected pill:', selectedPill.textContent);
            }
        }
        
        // Pill 버튼 선택 상태 관리
        function updatePillSelection(selectedPill) {
            // 모든 pill 버튼에서 selected 클래스 제거
            document.querySelectorAll('.pill-btn').forEach(pill => {
                pill.classList.remove('selected', 'bg-blue-600', 'text-white');
                pill.classList.add('bg-slate-100', 'text-slate-700');
            });
            
            // 선택된 pill에 selected 클래스 추가
            selectedPill.classList.add('selected', 'bg-blue-600', 'text-white');
            selectedPill.classList.remove('bg-slate-100', 'text-slate-700');
            
            // 선택된 pill로 스크롤
            setTimeout(() => {
                scrollToSelectedPill();
            }, 100);
        }

        // Pill 버튼 클릭 이벤트 리스너
        document.addEventListener('click', function(evt) {
            if (evt.target.classList.contains('pill-btn')) {
                updatePillSelection(evt.target);
            }
        });

        // 페이지 로드 시 자동 스크롤
        document.addEventListener('DOMContentLoaded', function() {
            // DOM이 완전히 로드된 후 스크롤
            setTimeout(scrollToSelectedPill, 100);
        });
        
        // HTMX 요청 완료 후 처리
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'activity-content') {
                // 종목이 로드되었을 때의 추가 처리
                console.log('체험 종목 로드 완료');
                
                // 초기 로드 시에도 스크롤 실행 (약간의 지연 후)
                setTimeout(scrollToSelectedPill, 150);
            }
        });

        // HTMX 요청 중 로딩 표시
        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            if (evt.detail.target.id === 'activity-content') {
                evt.detail.target.innerHTML = `
                    <div class="text-center py-8">
                        <div class="animate-pulse">
                            <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                            <div class="text-gray-500">종목 로딩 중...</div>
                        </div>
                    </div>
                `;
            }
        });

        // HTMX 에러 처리
        document.body.addEventListener('htmx:responseError', function(evt) {
            console.error('HTMX 요청 실패:', evt.detail);
            evt.detail.target.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                    <div class="text-red-600">종목을 불러오는데 실패했습니다. 다시 시도해주세요.</div>
                </div>
            `;
        });

        // ============== Excel Export 관련 기능 ==============
        
        // Excel Export 버튼 상태 확인 및 업데이트
        function updateExcelExportButtonState() {
            const exportBtn = document.getElementById('export-excel-btn');
            const exportBtnMobile = document.getElementById('export-excel-btn-mobile');
            
            // 세션 스토리지에서 측정 데이터 확인 (체험 데이터는 서버 세션에 저장되므로)
            // 실제로는 서버에 AJAX 요청을 보내서 데이터 존재 여부를 확인해야 하지만,
            // 여기서는 페이지 로드 시 버튼을 활성화하고 사용자가 직접 클릭하게 함
            if (exportBtn && exportBtnMobile) {
                exportBtn.disabled = false;
                exportBtnMobile.disabled = false;
            }
        }
        
        // Excel Export 버튼 클릭 이벤트
        function handleExcelExport() {
            const exportBtn = document.getElementById('export-excel-btn');
            const exportBtnMobile = document.getElementById('export-excel-btn-mobile');
            
            // 로딩 상태로 변경
            if (exportBtn) {
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Excel 생성 중...';
            }
            if (exportBtnMobile) {
                exportBtnMobile.disabled = true;
                exportBtnMobile.innerHTML = '<i class="fas fa-spinner fa-spin text-lg"></i>';
            }
            
            // Excel export API 호출
            fetch('{% url "physical_education:demo_export_excel" %}', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            })
            .then(response => {
                if (response.ok) {
                    // Excel 파일인 경우 다운로드 처리
                    if (response.headers.get('content-type').includes('spreadsheetml.sheet')) {
                        return response.blob();
                    } else {
                        // JSON 에러 응답인 경우
                        return response.json();
                    }
                } else {
                    throw new Error('서버 응답 오류: ' + response.status);
                }
            })
            .then(data => {
                if (data instanceof Blob) {
                    // Blob인 경우 파일 다운로드
                    const url = window.URL.createObjectURL(data);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `PAPS_체험판_측정데이터_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showMessage('success', 'Excel 파일이 다운로드되었습니다.');
                } else {
                    // JSON 에러 응답인 경우
                    showMessage('error', data.error || 'Excel 파일 생성에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Excel export 오류:', error);
                showMessage('error', 'Excel 파일 다운로드 중 오류가 발생했습니다.');
            })
            .finally(() => {
                // 버튼 원래 상태로 복구
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = '<i class="fas fa-file-excel mr-2"></i>Excel 다운로드';
                }
                if (exportBtnMobile) {
                    exportBtnMobile.disabled = false;
                    exportBtnMobile.innerHTML = '<i class="fas fa-file-excel text-lg"></i>';
                }
            });
        }
        
        // 메시지 표시 함수
        function showMessage(type, message) {
            // 간단한 alert 대신 좀 더 나은 알림을 만들 수 있지만, 일단 alert 사용
            if (type === 'success') {
                alert('✅ ' + message);
            } else if (type === 'error') {
                alert('❌ ' + message);
            } else {
                alert(message);
            }
        }
        
        // Excel Export 버튼 이벤트 리스너 등록
        document.addEventListener('DOMContentLoaded', function() {
            const exportBtn = document.getElementById('export-excel-btn');
            const exportBtnMobile = document.getElementById('export-excel-btn-mobile');
            
            if (exportBtn) {
                exportBtn.addEventListener('click', handleExcelExport);
            }
            if (exportBtnMobile) {
                exportBtnMobile.addEventListener('click', handleExcelExport);
            }
            
            // 페이지 로드 시 버튼 상태 업데이트
            updateExcelExportButtonState();
        });
    </script>
</body>
</html>