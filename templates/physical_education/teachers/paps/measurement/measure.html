{% extends "teacher/base.html" %} {% load static %} {% block title %}PAPS
측정하기{% endblock %} {% block content %}
<div class="flex min-h-screen mobile-nav-padding">
  <!-- 공통 사이드바 -->
  {% include "physical_education/teachers/partials/sidebar.html" %}

  <!-- 메인 컨텐츠 -->
  <div class="flex-1 lg:ml-64">
    <div class="max-w-3xl mx-auto px-4 lg:px-6">
      <!-- 페이지 내용 -->
      <div class="py-4 lg:py-6">
        <!-- 페이지 헤더 -->
        <div class="mb-6">
          <h1 class="text-2xl font-bold text-gray-900 mb-2">PAPS 측정하기</h1>
          <p class="text-gray-600">측정 관련 기능을 이용하세요</p>
        </div>

        <!-- 3단계 스텝 인터페이스 -->
        <div class="max-w-4xl mx-auto">
          <!-- 진행 상태 표시 -->
          <div class="mb-8">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <!-- Step 1: 측정 대상 선택 -->
                <div class="flex items-center">
                  <div class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-600 text-white text-sm font-medium step-indicator" data-step="1">
                    1
                  </div>
                  <span class="ml-2 text-sm font-medium text-gray-900 hidden sm:block">측정 대상 선택</span>
                </div>
                
                <!-- 연결선 1-2 -->
                <div class="flex-1 h-0.5 bg-gray-300 step-connector" data-step="1-2"></div>
                
                <!-- Step 2: 학급 및 종목 선택 -->
                <div class="flex items-center">
                  <div class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-300 text-gray-500 text-sm font-medium step-indicator" data-step="2">
                    2
                  </div>
                  <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:block">학급 및 종목 선택</span>
                </div>
                
                <!-- 연결선 2-3 -->
                <div class="flex-1 h-0.5 bg-gray-300 step-connector" data-step="2-3"></div>
                
                <!-- Step 3: 측정 화면 -->
                <div class="flex items-center">
                  <div class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-300 text-gray-500 text-sm font-medium step-indicator" data-step="3">
                    3
                  </div>
                  <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:block">측정 화면</span>
                </div>
              </div>
              
              <!-- 모바일용 현재 단계 표시 -->
              <div class="sm:hidden">
                <span class="text-sm text-gray-600">
                  <span id="current-step-mobile">1</span> / 3
                </span>
              </div>
            </div>
          </div>
          
          <!-- 단계별 콘텐츠 -->
          <div class="relative">
            <!-- Step 1: 측정 대상 선택 -->
            <div id="step-1" class="step-content">
              <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-xl font-semibold text-gray-900">측정 대상 선택</h2>
                  <div class="text-sm text-gray-500">1단계</div>
                </div>
                
                <!-- 측정 대상 선택 내용 -->
                <div class="space-y-6">
                  <!-- 1. 학년도 선택 -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">학년도 선택</label>
                    <select id="school-year-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <option value="">학년도를 선택하세요</option>
                      {% for year in school_years %}
                        <option value="{{ year }}">{{ year }}년도</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <!-- 2. 측정회차 선택 -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">측정회차 선택</label>
                    <select id="session-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                      <option value="">먼저 학년도를 선택하세요</option>
                    </select>
                  </div>
                  
                  <!-- 3. 학년 선택 -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">학년 선택</label>
                    <select id="grade-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                      <option value="">먼저 측정회차를 선택해주세요</option>
                    </select>
                  </div>
                </div>
                
                <!-- 1단계 네비게이션 -->
                <div class="flex justify-end mt-8 pt-6 border-t border-gray-200">
                  <button id="next-btn-step1" class="px-6 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    다음 단계
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Step 2: 학급 및 종목 선택 -->
            <div id="step-2" class="step-content hidden">
              <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-xl font-semibold text-gray-900">학급 및 종목 선택</h2>
                  <div class="text-sm text-gray-500">2단계</div>
                </div>
                
                <!-- 학급과 측정종목 선택 -->
                <div class="space-y-6">
                  <!-- 선택된 정보 표시 -->
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center">
                      <i class="fas fa-check-circle text-blue-600 mr-2"></i>
                      <span class="text-sm text-blue-800">선택된 대상: </span>
                      <span class="font-medium text-blue-900" id="selected-target-info">-</span>
                    </div>
                  </div>

                  <!-- 학급과 측정종목 선택 (수평 정렬) -->
                  <div class="flex space-x-4">
                    <!-- 학급 선택 -->
                    <div class="flex-1">
                      <label class="block text-sm font-medium text-gray-700 mb-2">학급 선택</label>
                      <select id="class-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">학급을 선택하세요</option>
                      </select>
                    </div>
                    
                    <!-- 측정종목 선택 -->
                    <div class="flex-1">
                      <label class="block text-sm font-medium text-gray-700 mb-2">측정종목 선택</label>
                      <select id="activity-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">측정종목을 선택하세요</option>
                      </select>
                    </div>
                  </div>
                </div>
                
                <!-- 2단계 네비게이션 -->
                <div class="flex justify-between mt-8 pt-6 border-t border-gray-200">
                  <button id="prev-btn-step2" class="px-6 py-2 bg-gray-100 text-gray-700 text-sm rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    이전 단계
                  </button>
                  <button id="next-btn-step2" class="px-6 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    다음 단계
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Step 3: 측정 화면 -->
            <div id="step-3" class="step-content hidden">
              <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-xl font-semibold text-gray-900">측정 화면</h2>
                  <div class="text-sm text-gray-500">3단계</div>
                </div>
                
                <!-- 선택된 정보 표시 -->
                <div class="space-y-6">
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center">
                      <i class="fas fa-check-circle text-blue-600 mr-2"></i>
                      <span class="text-sm text-blue-800">선택된 대상: </span>
                      <span class="font-medium text-blue-900" id="selected-target-info-step3">-</span>
                    </div>
                  </div>
                  
                  <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="space-y-2">
                      <div class="flex items-center">
                        <i class="fas fa-users text-green-600 mr-2"></i>
                        <span class="text-sm text-green-800">선택된 학급: </span>
                        <span class="font-medium text-green-900" id="selected-class-info">-</span>
                      </div>
                      <div class="flex items-center">
                        <i class="fas fa-running text-green-600 mr-2"></i>
                        <span class="text-sm text-green-800">선택된 종목: </span>
                        <span class="font-medium text-green-900" id="selected-activity-info">-</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- 측정 화면 컨테이너 (추후 종목별 템플릿이 포함될 예정) -->
                <div class="mt-6">
                  <div id="measurement-container" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                    <div class="text-gray-500">
                      <i class="fas fa-chart-line text-4xl mb-4"></i>
                      <h3 class="text-lg font-medium mb-2">측정 화면 준비 중</h3>
                      <p class="text-sm">선택된 종목에 따른 측정 화면이 여기에 표시됩니다.</p>
                      <p class="text-sm text-gray-400 mt-1">종목별 측정 템플릿 개발 완료 후 활성화 예정</p>
                    </div>
                  </div>
                </div>
                
                <!-- 3단계 네비게이션 -->
                <div class="flex justify-start mt-8 pt-6 border-t border-gray-200">
                  <button id="prev-btn-step3" class="px-6 py-2 bg-gray-100 text-gray-700 text-sm rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    이전 단계
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ================ JSON 데이터 파싱 ================
const papsData = {
    classes: {{ classes_json|safe }},
    sessions: {{ sessions_json|safe }},
    categories: {{ categories_json|safe }},
    activities: {{ activities_json|safe }},
    sessionActivities: {{ session_activities_json|safe }}
};

// 콘솔에서 데이터 확인 가능
console.log('PAPS 데이터:', papsData);

document.addEventListener('DOMContentLoaded', function() {
    
    // ================ 상태 관리 시스템 ================
    const AppState = {
        currentStep: 1,
        selectedSchoolYear: null,
        selectedSession: null,
        selectedGrade: null,
        selectedClass: null,
        selectedActivity: null,
        
        // 상태 업데이트
        setStep(step) {
            this.currentStep = step;
            this.updateUI();
            this.updateHash();
            this.saveToStorage();
        },
        
        setSelection(schoolYear, session, grade) {
            this.selectedSchoolYear = schoolYear;
            this.selectedSession = session;
            this.selectedGrade = grade;
            this.saveToStorage();
        },
        
        setClassAndActivity(classId, activityId) {
            this.selectedClass = classId;
            this.selectedActivity = activityId;
            this.saveToStorage();
        },
        
        // 로컬스토리지에 상태 저장
        saveToStorage() {
            localStorage.setItem('paps_measure_state', JSON.stringify({
                currentStep: this.currentStep,
                selectedSchoolYear: this.selectedSchoolYear,
                selectedSession: this.selectedSession,
                selectedGrade: this.selectedGrade,
                selectedClass: this.selectedClass,
                selectedActivity: this.selectedActivity
            }));
        },
        
        // 로컬스토리지에서 상태 복원
        loadFromStorage() {
            try {
                const saved = localStorage.getItem('paps_measure_state');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.currentStep = data.currentStep || 1;
                    this.selectedSchoolYear = data.selectedSchoolYear;
                    this.selectedSession = data.selectedSession;
                    this.selectedGrade = data.selectedGrade;
                    this.selectedClass = data.selectedClass;
                    this.selectedActivity = data.selectedActivity;
                }
            } catch (e) {
                console.error('상태 복원 중 오류:', e);
            }
        },
        
        // 상태 초기화
        reset() {
            this.currentStep = 1;
            this.selectedSchoolYear = null;
            this.selectedSession = null;
            this.selectedGrade = null;
            this.selectedClass = null;
            this.selectedActivity = null;
            this.updateUI();
            this.updateHash();
            this.saveToStorage();
        },
        
        // URL 해시 업데이트
        updateHash() {
            const newHash = `#step-${this.currentStep}`;
            if (window.location.hash !== newHash) {
                window.location.hash = newHash;
            }
        },
        
        // 해시에서 단계 추출
        getStepFromHash() {
            const hash = window.location.hash;
            const match = hash.match(/#step-(\d+)/);
            return match ? parseInt(match[1]) : 1;
        },
        
        // UI 업데이트
        updateUI() {
            this.updateStepIndicators();
            this.updateStepContent();
            this.updateMobileStepCounter();
        },
        
        updateStepIndicators() {
            for (let i = 1; i <= 3; i++) {
                const indicator = document.querySelector(`.step-indicator[data-step="${i}"]`);
                const label = indicator?.nextElementSibling;
                
                if (i < this.currentStep) {
                    // 완료된 단계
                    indicator?.classList.remove('bg-gray-300', 'text-gray-500', 'bg-blue-600');
                    indicator?.classList.add('bg-green-600', 'text-white');
                    label?.classList.remove('text-gray-500');
                    label?.classList.add('text-gray-900');
                    
                    // 연결선 업데이트
                    const connector = document.querySelector(`.step-connector[data-step="${i}-${i+1}"]`);
                    connector?.classList.remove('bg-gray-300');
                    connector?.classList.add('bg-green-600');
                } else if (i === this.currentStep) {
                    // 현재 단계
                    indicator?.classList.remove('bg-gray-300', 'text-gray-500', 'bg-green-600');
                    indicator?.classList.add('bg-blue-600', 'text-white');
                    label?.classList.remove('text-gray-500');
                    label?.classList.add('text-gray-900');
                } else {
                    // 미래 단계
                    indicator?.classList.remove('bg-blue-600', 'text-white', 'bg-green-600');
                    indicator?.classList.add('bg-gray-300', 'text-gray-500');
                    label?.classList.remove('text-gray-900');
                    label?.classList.add('text-gray-500');
                    
                    // 연결선 업데이트
                    const connector = document.querySelector(`.step-connector[data-step="${i-1}-${i}"]`);
                    connector?.classList.remove('bg-green-600');
                    connector?.classList.add('bg-gray-300');
                }
            }
        },
        
        updateStepContent() {
            for (let i = 1; i <= 3; i++) {
                const content = document.getElementById(`step-${i}`);
                if (content) {
                    content.classList.toggle('hidden', i !== this.currentStep);
                }
            }
        },
        
        updateMobileStepCounter() {
            const counter = document.getElementById('current-step-mobile');
            if (counter) {
                counter.textContent = this.currentStep;
            }
        }
    };
    
    // ================ 이벤트 리스너 설정 ================
    
    // 해시 변경 이벤트 처리
    window.addEventListener('hashchange', function() {
        const step = AppState.getStepFromHash();
        if (step >= 1 && step <= 3) {
            AppState.currentStep = step;
            AppState.updateUI();
            AppState.saveToStorage();
        }
    });
    
    // 학년도 선택 이벤트
    document.getElementById('school-year-select').addEventListener('change', function() {
        const selectedYear = parseInt(this.value);
        AppState.selectedSchoolYear = selectedYear;
        
        if (selectedYear) {
            // 해당 학년도의 측정회차만 필터링
            const filteredSessions = papsData.sessions.filter(s => s.school_year === selectedYear);
            
            // 측정회차 select 업데이트
            const sessionSelect = document.getElementById('session-select');
            let options = '<option value="">측정회차를 선택하세요</option>';
            
            filteredSessions.forEach(session => {
                options += `<option value="${session.id}">${session.name}</option>`;
            });
            
            sessionSelect.innerHTML = options;
            sessionSelect.disabled = false;
        } else {
            // 학년도 미선택시 하위 select 초기화
            resetSessionSelect();
            resetGradeSelect();
        }
        
        validateStep1();
    });
    
    // 측정회차 선택 이벤트
    document.getElementById('session-select').addEventListener('change', function() {
        const selectedSessionId = this.value;
        AppState.selectedSession = selectedSessionId;
        
        if (selectedSessionId) {
            // sessionActivities에서 해당 session_id의 unique 학년 추출
            const sessionActivities = papsData.sessionActivities.filter(
                sa => sa.session_id === selectedSessionId
            );
            
            // unique 학년 추출 및 정렬
            const uniqueGrades = [...new Set(sessionActivities.map(sa => sa.grade))].sort((a, b) => a - b);
            
            // 학년 select 업데이트
            const gradeSelect = document.getElementById('grade-select');
            let options = '<option value="">학년을 선택하세요</option>';
            
            uniqueGrades.forEach(grade => {
                const gradeDisplay = getGradeDisplay(grade);
                options += `<option value="${grade}">${gradeDisplay}</option>`;
            });
            
            gradeSelect.innerHTML = options;
            gradeSelect.disabled = false;
        } else {
            resetGradeSelect();
        }
        
        validateStep1();
    });
    
    // 학년 선택 이벤트
    document.getElementById('grade-select').addEventListener('change', function() {
        AppState.selectedGrade = this.value;
        validateStep1();
    });
    
    // 다음 단계 버튼
    document.getElementById('next-btn-step1').addEventListener('click', function() {
        if (validateStep1()) {
            AppState.setStep(2);
            updateSelectedInfo();
            loadClassOptions();
            loadActivityOptions();
        }
    });
    
    // 이전 단계 버튼
    document.getElementById('prev-btn-step2').addEventListener('click', function() {
        AppState.setStep(1);
    });
    
    // 학급 선택 이벤트
    document.getElementById('class-select').addEventListener('change', function() {
        const selectedClass = this.value;
        AppState.selectedClass = selectedClass;
        
        validateStep2();
    });
    
    // 측정종목 선택 이벤트
    document.getElementById('activity-select').addEventListener('change', function() {
        AppState.selectedActivity = this.value;
        validateStep2();
    });
    
    // 2단계 다음 단계 버튼
    document.getElementById('next-btn-step2').addEventListener('click', function() {
        if (validateStep2()) {
            AppState.setStep(3);
            updateStep3Info();
        }
    });
    
    // 3단계 이전 단계 버튼
    document.getElementById('prev-btn-step3').addEventListener('click', function() {
        AppState.setStep(2);
    });
    
    
    // ================ 유틸리티 함수 ================
    
    function resetSessionSelect() {
        const sessionSelect = document.getElementById('session-select');
        sessionSelect.innerHTML = '<option value="">먼저 학년도를 선택하세요</option>';
        sessionSelect.disabled = true;
        AppState.selectedSession = null;
    }
    
    function resetGradeSelect() {
        const gradeSelect = document.getElementById('grade-select');
        gradeSelect.innerHTML = '<option value="">먼저 측정회차를 선택해주세요</option>';
        gradeSelect.disabled = true;
        AppState.selectedGrade = null;
    }
    
    function getGradeDisplay(grade) {
        if (grade <= 6) return `초${grade}`;
        else if (grade <= 9) return `중${grade - 6}`;
        else return `고${grade - 9}`;
    }
    
    // 2단계 관련 함수들
    function loadClassOptions() {
        if (!AppState.selectedGrade) return;
        
        // 선택된 학년에 해당하는 학급만 필터링
        const filteredClasses = papsData.classes.filter(cls => 
            cls.grade === parseInt(AppState.selectedGrade)
        );
        
        const classSelect = document.getElementById('class-select');
        let options = '<option value="">학급을 선택하세요</option>';
        
        filteredClasses.forEach(cls => {
            options += `<option value="${cls.id}">${cls.name}</option>`;
        });
        
        classSelect.innerHTML = options;
        classSelect.disabled = false;
    }
    
    function loadActivityOptions() {
        if (!AppState.selectedSession || !AppState.selectedGrade) return;
        
        // 선택된 측정회차와 학년에 해당하는 활동들 필터링
        const sessionActivities = papsData.sessionActivities.filter(sa => 
            sa.session_id === AppState.selectedSession && 
            sa.grade === parseInt(AppState.selectedGrade)
        );
        
        const activitySelect = document.getElementById('activity-select');
        let options = '<option value="">측정종목을 선택하세요</option>';
        
        // 카테고리별로 그룹화
        const categorizedActivities = {};
        sessionActivities.forEach(sa => {
            const activity = papsData.activities.find(act => act.id === sa.activity_id);
            const category = papsData.categories.find(cat => cat.id === sa.category_id);
            
            if (activity && category) {
                if (!categorizedActivities[category.display_name]) {
                    categorizedActivities[category.display_name] = [];
                }
                categorizedActivities[category.display_name].push({
                    id: activity.id,
                    name: activity.display_name
                });
            }
        });
        
        // optgroup으로 카테고리별 표시
        Object.keys(categorizedActivities).forEach(categoryName => {
            options += `<optgroup label="${categoryName}">`;
            categorizedActivities[categoryName].forEach(activity => {
                options += `<option value="${activity.id}">${activity.name}</option>`;
            });
            options += '</optgroup>';
        });
        
        activitySelect.innerHTML = options;
    }
    
    function resetActivitySelect() {
        const activitySelect = document.getElementById('activity-select');
        activitySelect.innerHTML = '<option value="">측정종목을 선택하세요</option>';
        AppState.selectedActivity = null;
    }
    
    function validateStep2() {
        const isValid = AppState.selectedClass && AppState.selectedActivity;
        const nextBtn = document.getElementById('next-btn-step2');
        
        if (nextBtn) {
            nextBtn.disabled = !isValid;
        }
        
        return isValid;
    }
    
    function validateStep1() {
        const isValid = AppState.selectedSchoolYear && AppState.selectedSession && AppState.selectedGrade;
        const nextBtn = document.getElementById('next-btn-step1');
        
        nextBtn.disabled = !isValid;
        
        return isValid;
    }
    
    function updateSelectedInfo() {
        const infoElement = document.getElementById('selected-target-info');
        if (AppState.selectedSchoolYear && AppState.selectedSession && AppState.selectedGrade) {
            const selectedSessionData = papsData.sessions.find(s => s.id === AppState.selectedSession);
            const gradeDisplay = getGradeDisplay(parseInt(AppState.selectedGrade));
            
            if (selectedSessionData) {
                const info = `${AppState.selectedSchoolYear}년도 ${selectedSessionData.session_type_display} - ${gradeDisplay}`;
                infoElement.textContent = info;
            }
        }
    }
    
    function updateStep3Info() {
        // 3단계에서 선택된 대상 정보 업데이트
        const targetInfoElement = document.getElementById('selected-target-info-step3');
        if (AppState.selectedSchoolYear && AppState.selectedSession && AppState.selectedGrade) {
            const selectedSessionData = papsData.sessions.find(s => s.id === AppState.selectedSession);
            const gradeDisplay = getGradeDisplay(parseInt(AppState.selectedGrade));
            
            if (selectedSessionData) {
                const info = `${AppState.selectedSchoolYear}년도 ${selectedSessionData.session_type_display} - ${gradeDisplay}`;
                targetInfoElement.textContent = info;
            }
        }
        
        // 선택된 학급 정보 업데이트
        const classInfoElement = document.getElementById('selected-class-info');
        if (AppState.selectedClass) {
            const selectedClassData = papsData.classes.find(cls => cls.id === parseInt(AppState.selectedClass));
            if (selectedClassData) {
                classInfoElement.textContent = selectedClassData.name;
            }
        }
        
        // 선택된 종목 정보 업데이트
        const activityInfoElement = document.getElementById('selected-activity-info');
        if (AppState.selectedActivity) {
            const selectedActivityData = papsData.activities.find(act => act.id === parseInt(AppState.selectedActivity));
            if (selectedActivityData) {
                activityInfoElement.textContent = selectedActivityData.display_name;
            }
        }
    }
    
    // ================ 초기화 ================
    
    // 상태 복원
    AppState.loadFromStorage();
    
    // 해시에서 단계 확인
    const hashStep = AppState.getStepFromHash();
    if (hashStep !== AppState.currentStep) {
        AppState.currentStep = hashStep;
    }
    
    // 상태 복원 로직
    if (AppState.selectedSchoolYear) {
        document.getElementById('school-year-select').value = AppState.selectedSchoolYear;
        // 학년도 선택 이벤트 트리거
        document.getElementById('school-year-select').dispatchEvent(new Event('change'));
    }
    
    if (AppState.selectedSession && AppState.selectedSchoolYear) {
        setTimeout(() => {
            document.getElementById('session-select').value = AppState.selectedSession;
            // 측정회차 선택 이벤트 트리거
            document.getElementById('session-select').dispatchEvent(new Event('change'));
        }, 100);
    }
    
    if (AppState.selectedGrade && AppState.selectedSession) {
        setTimeout(() => {
            document.getElementById('grade-select').value = AppState.selectedGrade;
            validateStep1();
        }, 200);
    }
    
    if (AppState.currentStep === 2) {
        updateSelectedInfo();
        loadClassOptions();
        loadActivityOptions();
        
        // 2단계 상태 복원
        if (AppState.selectedClass) {
            setTimeout(() => {
                document.getElementById('class-select').value = AppState.selectedClass;
            }, 300);
        }
        
        if (AppState.selectedActivity) {
            setTimeout(() => {
                document.getElementById('activity-select').value = AppState.selectedActivity;
                validateStep2();
            }, 400);
        }
    }
    
    if (AppState.currentStep === 3) {
        updateSelectedInfo();
        loadClassOptions();
        loadActivityOptions();
        updateStep3Info();
        
        // 3단계 상태 복원 - 2단계 선택값들 복원
        if (AppState.selectedClass) {
            setTimeout(() => {
                document.getElementById('class-select').value = AppState.selectedClass;
            }, 300);
        }
        
        if (AppState.selectedActivity) {
            setTimeout(() => {
                document.getElementById('activity-select').value = AppState.selectedActivity;
            }, 400);
        }
    }
    
    // UI 초기화
    AppState.updateUI();
    
    // 현재 단계에 따른 초기 검증
    if (AppState.currentStep === 1) {
        validateStep1();
    } else if (AppState.currentStep === 2) {
        validateStep2();
    } else if (AppState.currentStep === 3) {
        // 3단계는 별도 검증 없이 정보만 표시
        updateStep3Info();
    }
});
</script>
{% endblock %}
