{% extends "teacher/base.html" %} {% load static %} {% block title %}PAPS
측정하기{% endblock %} {% block content %}
<div class="flex min-h-screen">
  <!-- 공통 사이드바 -->
  {% include "physical_education/teachers/partials/sidebar.html" %}

  <!-- 메인 컨텐츠 -->
  <div class="flex-1 lg:ml-64">
    <div class="max-w-3xl mx-auto px-4 lg:px-6">
      <!-- 페이지 내용 -->
      <div class="py-4 lg:py-6">

        <!-- 새로운 통합 선택 인터페이스 -->
        <div class="max-w-4xl mx-auto">
          
          <!-- 상단 진행 표시기 -->
          <div class="mb-8">
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center gap-3">
                <!-- 햄버거 메뉴 버튼 (모바일/태블릿) -->
                <button id="page-mobile-sidebar-toggle" 
                        class="lg:hidden p-2 rounded-md bg-green-100 text-green-600 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors"
                        aria-expanded="false"
                        aria-controls="sidebar"
                        aria-label="메뉴 열기">
                  <i class="fas fa-bars text-lg"></i>
                </button>
                <h1 class="text-2xl font-bold text-gray-900">PAPS 측정하기</h1>
              </div>
              <span id="progress-count" class="text-lg text-gray-600">0/5</span>
            </div>
            
            <!-- 5단계 진행 표시 -->
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <!-- Step 1: 학년도 -->
                <div class="flex items-center">
                  <sl-badge id="badge-1" variant="neutral" pill>1</sl-badge>
                  <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:block">학년도</span>
                </div>
                
                <!-- 연결선 1-2 -->
                <div id="line-1" class="flex-1 h-0.5 bg-gray-300"></div>
                
                <!-- Step 2: 회차 -->
                <div class="flex items-center">
                  <sl-badge id="badge-2" variant="neutral" pill>2</sl-badge>
                  <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:block">회차</span>
                </div>
                
                <!-- 연결선 2-3 -->
                <div id="line-2" class="flex-1 h-0.5 bg-gray-300"></div>
                
                <!-- Step 3: 학년 -->
                <div class="flex items-center">
                  <sl-badge id="badge-3" variant="neutral" pill>3</sl-badge>
                  <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:block">학년</span>
                </div>
                
                <!-- 연결선 3-4 -->
                <div id="line-3" class="flex-1 h-0.5 bg-gray-300"></div>
                
                <!-- Step 4: 학급 -->
                <div class="flex items-center">
                  <sl-badge id="badge-4" variant="neutral" pill>4</sl-badge>
                  <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:block">학급</span>
                </div>
                
                <!-- 연결선 4-5 -->
                <div id="line-4" class="flex-1 h-0.5 bg-gray-300"></div>
                
                <!-- Step 5: 종목 -->
                <div class="flex items-center">
                  <sl-badge id="badge-5" variant="neutral" pill>5</sl-badge>
                  <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:block">종목</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 선택 섹션들 -->
          <div class="space-y-4">
            
            <!-- 학년도 선택 -->
            <sl-details id="year-section" class="selection-section" open>
              <div slot="summary" class="section-header">
                <div class="section-info">
                  <h3 class="section-title">학년도 선택</h3>
                  <p class="section-subtitle">측정 관련 기능을 이용하세요</p>
                  <p class="selected-value" style="display:none">선택됨: <span></span></p>
                </div>
                <div class="section-status">
                  <sl-icon name="check-circle-fill" class="check-icon" style="display:none"></sl-icon>
                </div>
              </div>
              
              <!-- 학년도 옵션 -->
              <div class="option-container">
                {% for year in school_years %}
                <sl-button variant="default" outline class="option-item" data-value="{{ year }}" data-type="schoolYear">
                  {{ year }}년도
                </sl-button>
                {% endfor %}
              </div>
            </sl-details>
            
            <!-- 회차 선택 -->
            <sl-details id="session-section" class="selection-section" disabled>
              <div slot="summary" class="section-header">
                <div class="section-info">
                  <h3 class="section-title">회차 선택</h3>
                  <p class="section-subtitle">학년도에 해당하는 회차를 선택하세요</p>
                  <p class="selected-value" style="display:none">선택됨: <span></span></p>
                </div>
                <div class="section-status">
                  <sl-icon name="check-circle-fill" class="check-icon" style="display:none"></sl-icon>
                </div>
              </div>
              
              <!-- 회차 옵션 (동적 로드) -->
              <div class="option-container" id="session-options">
              </div>
            </sl-details>
            
            <!-- 학년 선택 -->
            <sl-details id="grade-section" class="selection-section" disabled>
              <div slot="summary" class="section-header">
                <div class="section-info">
                  <h3 class="section-title">학년 선택</h3>
                  <p class="section-subtitle">측정할 학년을 선택하세요</p>
                  <p class="selected-value" style="display:none">선택됨: <span></span></p>
                </div>
                <div class="section-status">
                  <sl-icon name="check-circle-fill" class="check-icon" style="display:none"></sl-icon>
                </div>
              </div>
              
              <!-- 학년 옵션 (동적 로드) -->
              <div class="option-container" id="grade-options">
              </div>
            </sl-details>
            
            <!-- 학급 선택 -->
            <sl-details id="class-section" class="selection-section" disabled>
              <div slot="summary" class="section-header">
                <div class="section-info">
                  <h3 class="section-title">학급 선택</h3>
                  <p class="section-subtitle">측정할 학급을 선택하세요</p>
                  <p class="selected-value" style="display:none">선택됨: <span></span></p>
                </div>
                <div class="section-status">
                  <sl-icon name="check-circle-fill" class="check-icon" style="display:none"></sl-icon>
                </div>
              </div>
              
              <!-- 학급 옵션 (동적 로드) -->
              <div class="option-container" id="class-options">
              </div>
            </sl-details>
            
            <!-- 종목 선택 -->
            <sl-details id="activity-section" class="selection-section" disabled>
              <div slot="summary" class="section-header">
                <div class="section-info">
                  <h3 class="section-title">종목 선택</h3>
                  <p class="section-subtitle">측정할 종목을 선택하세요</p>
                  <p class="selected-value" style="display:none">선택됨: <span></span></p>
                </div>
                <div class="section-status">
                  <sl-icon name="check-circle-fill" class="check-icon" style="display:none"></sl-icon>
                </div>
              </div>
              
              <!-- 종목 옵션 (동적 로드) -->
              <div class="option-container" id="activity-options">
              </div>
            </sl-details>
            
          </div>
          
          <!-- 하단 시작 버튼 -->
          <div class="mt-8">
            <sl-button 
              id="submit-button"
              hx-get=""
              hx-trigger="click"
              hx-push-url="true"
              hx-target="body"
              hx-swap="innerHTML"
              hx-vals=""
              variant="primary" 
              size="large" 
              class="submit-button"
              disabled>
              조건 선택 (0/5)
            </sl-button>
          </div>
          
        </div>
      </div>
    </div>
  </div>
</div>

<!-- HTMX 로딩 인디케이터 -->
<div id="loading-indicator" class="htmx-indicator fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 shadow-xl">
        <div class="flex items-center space-x-3">
            <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
            <span class="text-lg font-medium">측정 화면을 불러오는 중...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.min.css" />

<style>
/* HTMX 로딩 인디케이터 스타일 */
.htmx-indicator {
    display: none;
}

#loading-indicator {
    display: none !important;
    pointer-events: none;
}

.htmx-request .htmx-indicator {
    display: flex !important;
}

.htmx-request #loading-indicator {
    display: flex !important;
    pointer-events: auto;
}

.htmx-request .initial-content {
    display: none;
}

/* 페이지 전환 시 부드러운 효과 */
body {
    transition: opacity 0.2s ease-in-out;
}

.htmx-request body {
    opacity: 0.9;
}

/* 트랜지션 효과 */
#measurement-container {
    transition: opacity 0.3s ease;
}

#measurement-container.htmx-request {
    opacity: 0.7;
}

/* ========== 새로운 UI 스타일 ========== */

/* 진행 표시기 스타일 */
.step-indicators {
    padding: 16px 0;
}

/* sl-badge 커스터마이징 */
sl-badge {
    --sl-font-size-medium: 14px;
    --sl-spacing-medium: 8px;
}

sl-badge[variant="primary"] {
    --sl-color-primary-600: #3b82f6;
}

/* 연결선 스타일 */
.step-indicators .flex-1 {
    transition: background-color 0.3s ease;
}

.step-indicators .flex-1.completed {
    background-color: #3b82f6 !important;
}

/* 선택 섹션 카드 스타일 */
.selection-section {
    margin-bottom: 16px;
}

.selection-section::part(base) {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    background: white;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.selection-section::part(header) {
    padding: 20px;
    border-bottom: none;
}

.selection-section::part(content) {
    padding: 0 20px 20px 20px;
}

/* 섹션 헤더 레이아웃 */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.section-info {
    flex: 1;
}

.section-title {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 4px 0;
}

.section-subtitle {
    font-size: 14px;
    color: #6b7280;
    margin: 0;
}

.selected-value {
    font-size: 14px;
    color: #10b981;
    margin: 4px 0 0 0;
    font-weight: 500;
}

.section-status {
    display: flex;
    align-items: center;
    gap: 8px;
}

.check-icon::part(svg) {
    color: #10b981;
    font-size: 20px;
}

/* Spacing between content and expand/collapse icon */
.selection-section::part(summary-icon) {
    margin-left: 16px;
}


/* 비활성화 상태 */
.selection-section[disabled]::part(base) {
    opacity: 0.5;
    pointer-events: none;
}

.selection-section[disabled]::part(base) {
    background: #f9fafb;
    border-color: #e5e7eb;
}

/* 선택된 상태 */
.selection-section.selected::part(base) {
    border-left: 4px solid #10b981;
    background: #f0fdf4;
}

/* 옵션 컨테이너 */
.option-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* 옵션 버튼 스타일 */

.option-item::part(base) {
    width: 100%;
    justify-content: flex-start;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: white;
    color: #374151;
    font-size: 16px;
}

.option-item:hover::part(base) {
    background: #f9fafb;
    border-color: #d1d5db;
}

.option-item.selected::part(base) {
    background: #dbeafe;
    border-color: #3b82f6;
    color: #1e40af;
}

/* 하단 버튼 스타일 */

.submit-button {
    width: 100%;
    font-size: 18px;
    font-weight: 600;
    border-radius: 12px;
}

.submit-button::part(base) {
    width: 100%;
    font-size: 18px;
    font-weight: 600;
    border-radius: 12px;
}

.submit-button[disabled]::part(base) {
    background: #93c5fd;
    border-color: #93c5fd;
    color: white;
    opacity: 1;
}

.submit-button:not([disabled])::part(base) {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
}

.submit-button:not([disabled]):hover::part(base) {
    background: #2563eb;
    border-color: #2563eb;
}

/* 모바일 반응형 */
@media (max-width: 640px) {
    .step-indicators .hidden {
        display: none !important;
    }
    
    .step-indicators .space-x-4 {
        gap: 8px;
    }
}

/* 호버 효과 */
.selection-section:not([disabled]):hover::part(base) {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* 포커스 효과 */
.selection-section:focus-within::part(base) {
    ring: 2px solid #3b82f6;
    ring-opacity: 0.5;
}

/* 애니메이션 */
.selection-section::part(content) {
    transition: all 0.2s ease-in-out;
}

.check-icon {
    animation: checkmark 0.3s ease-in-out;
}

@keyframes checkmark {
    0% {
        transform: scale(0);
        opacity: 0;
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<!-- HTMX 라이브러리 -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace-autoloader.min.js"></script>

<script>
// ================ JSON 데이터 파싱 ================
const papsData = {
    classes: {{ classes_json|safe }},
    sessions: {{ sessions_json|safe }},
    categories: {{ categories_json|safe }},
    activities: {{ activities_json|safe }},
    sessionActivities: {{ session_activities_json|safe }}
};

document.addEventListener('DOMContentLoaded', function() {
    
    // ================ 새로운 측정 선택 시스템 ================
    
    class MeasurementSelector {
        constructor() {
            // 선택 상태 관리
            this.selections = {
                schoolYear: null,
                session: null,
                grade: null,
                class: null,
                activity: null
            };
            
            // DOM 요소 참조
            this.elements = {
                progressCount: document.getElementById('progress-count'),
                submitButton: document.getElementById('submit-button'),
                sections: {
                    year: document.getElementById('year-section'),
                    session: document.getElementById('session-section'),
                    grade: document.getElementById('grade-section'),
                    class: document.getElementById('class-section'),
                    activity: document.getElementById('activity-section')
                },
                optionContainers: {
                    session: document.getElementById('session-options'),
                    grade: document.getElementById('grade-options'),
                    class: document.getElementById('class-options'),
                    activity: document.getElementById('activity-options')
                }
            };
            
            // 이벤트 리스너 설정
            this.setupEventListeners();
            
            // 초기 상태 설정
            this.updateProgress();
        }
        
        setupEventListeners() {
            // 모든 옵션 버튼 클릭 이벤트
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('option-item')) {
                    const type = e.target.dataset.type;
                    const value = e.target.dataset.value;
                    this.handleSelection(type, value, e.target);
                }
            });
            
            // 하단 시작 버튼 클릭 이벤트 제거 - htmx가 처리
            
            // sl-details 열기/닫기 이벤트
            Object.values(this.elements.sections).forEach(section => {
                section.addEventListener('sl-show', this.handleSectionOpen.bind(this));
                section.addEventListener('sl-hide', this.handleSectionClose.bind(this));
            });
            
        }
        
        handleSelection(type, value, buttonElement) {
            // 이전 선택 값 저장 (리셋 전에 확인용)
            const previousValue = this.selections[type];
            
            // 이전 선택 버튼 상태 초기화
            const container = buttonElement.parentElement;
            container.querySelectorAll('.option-item').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 현재 버튼 선택 상태로 변경
            buttonElement.classList.add('selected');
            
            // 값이 변경된 경우에만 종속된 하위 항목들 초기화
            if (previousValue !== value) {
                this.resetDependentSelections(type);
            }
            
            // 선택 값 저장
            this.selections[type] = value;
            
            // UI 업데이트
            this.updateSectionUI(type, value);
            
            // 값이 변경된 경우에만 다음 섹션 활성화 및 진행 상태 업데이트
            if (previousValue !== value) {
                // 다음 섹션 활성화
                this.enableNextSections(type);
                
                // 진행 상태 업데이트
                this.updateProgress();
            }
            
            // 섹션 자동 닫기 및 다음 열기
            setTimeout(() => {
                if (previousValue !== value) {
                    // 값이 변경된 경우: 현재 섹션 닫고 다음 섹션 열기
                    this.autoNavigate(type);
                } else {
                    // 값이 동일한 경우: 현재 섹션만 닫기
                    const currentSection = this.getCurrentSection(type);
                    if (currentSection && currentSection.open) {
                        currentSection.hide();
                    }
                }
            }, 500);
        }
        
        updateSectionUI(type, value) {
            const sectionMap = {
                schoolYear: 'year',
                session: 'session', 
                grade: 'grade',
                class: 'class',
                activity: 'activity'
            };
            
            const sectionId = sectionMap[type];
            const section = this.elements.sections[sectionId];
            
            if (!section) return;
            
            // 선택된 상태로 변경
            section.classList.add('selected');
            
            // 체크 아이콘 표시
            const checkIcon = section.querySelector('.check-icon');
            const selectedValue = section.querySelector('.selected-value');
            const selectedSpan = selectedValue.querySelector('span');
            
            checkIcon.style.display = 'block';
            selectedValue.style.display = 'block';
            
            // 선택된 값 표시 텍스트 설정
            let displayText = '';
            switch(type) {
                case 'schoolYear':
                    displayText = `${value}년도`;
                    break;
                case 'session':
                    const sessionData = papsData.sessions.find(s => s.id === value);
                    displayText = sessionData ? sessionData.name : value;
                    break;
                case 'grade':
                    displayText = this.getGradeDisplay(parseInt(value));
                    break;
                case 'class':
                    const classData = papsData.classes.find(c => c.id === parseInt(value));
                    displayText = classData ? classData.name : value;
                    break;
                case 'activity':
                    const activityData = papsData.activities.find(a => a.id === value);
                    displayText = activityData ? activityData.display_name : value;
                    break;
            }
            
            selectedSpan.textContent = displayText;
        }
        
        enableNextSections(type) {
            switch(type) {
                case 'schoolYear':
                    this.loadSessions();
                    this.elements.sections.session.disabled = false;
                    break;
                case 'session':
                    this.loadGrades();
                    this.elements.sections.grade.disabled = false;
                    break;
                case 'grade':
                    this.loadClasses();
                    this.loadActivities();
                    this.elements.sections.class.disabled = false;
                    this.elements.sections.activity.disabled = false;
                    break;
            }
        }
        
        resetDependentSelections(type) {
            // 종속 관계에 따라 하위 항목들 초기화
            const dependencyMap = {
                schoolYear: ['session', 'grade', 'class', 'activity'],
                session: ['grade', 'class', 'activity'],
                grade: ['class', 'activity'],
                class: [],
                activity: []
            };
            
            const dependentTypes = dependencyMap[type] || [];
            
            dependentTypes.forEach(dependentType => {
                // 선택 값 초기화
                this.selections[dependentType] = null;
                
                // UI 상태 초기화
                this.resetSectionUI(dependentType);
                
                // 섹션 비활성화
                this.disableSection(dependentType);
                
                // 옵션 컨테이너 비우기
                this.clearOptionContainer(dependentType);
            });
        }
        
        resetSectionUI(type) {
            const sectionMap = {
                schoolYear: 'year',
                session: 'session',
                grade: 'grade',
                class: 'class',
                activity: 'activity'
            };
            
            const sectionId = sectionMap[type];
            const section = this.elements.sections[sectionId];
            
            if (!section) return;
            
            // 선택된 상태 클래스 제거
            section.classList.remove('selected');
            
            // 체크 아이콘 숨기기
            const checkIcon = section.querySelector('.check-icon');
            const selectedValue = section.querySelector('.selected-value');
            
            if (checkIcon) checkIcon.style.display = 'none';
            if (selectedValue) selectedValue.style.display = 'none';
        }
        
        disableSection(type) {
            const sectionMap = {
                schoolYear: 'year',
                session: 'session',
                grade: 'grade',
                class: 'class',
                activity: 'activity'
            };
            
            const sectionId = sectionMap[type];
            const section = this.elements.sections[sectionId];
            
            if (section) {
                section.disabled = true;
            }
        }
        
        clearOptionContainer(type) {
            const containerMap = {
                session: 'session',
                grade: 'grade',
                class: 'class',
                activity: 'activity'
            };
            
            const containerId = containerMap[type];
            const container = this.elements.optionContainers[containerId];
            
            if (container) {
                container.innerHTML = '';
            }
        }
        
        
        loadSessions() {
            const selectedYear = parseInt(this.selections.schoolYear);
            const filteredSessions = papsData.sessions.filter(s => s.school_year === selectedYear);
            
            const container = this.elements.optionContainers.session;
            container.innerHTML = '';
            
            filteredSessions.forEach(session => {
                const button = document.createElement('sl-button');
                button.setAttribute('variant', 'default');
                button.setAttribute('outline', '');
                button.className = 'option-item';
                button.dataset.value = session.id;
                button.dataset.type = 'session';
                button.textContent = session.name;
                container.appendChild(button);
            });
        }
        
        loadGrades() {
            const selectedSession = this.selections.session;
            const sessionActivities = papsData.sessionActivities.filter(
                sa => sa.session_id === selectedSession
            );
            
            const uniqueGrades = [...new Set(sessionActivities.map(sa => sa.grade))].sort((a, b) => a - b);
            
            const container = this.elements.optionContainers.grade;
            container.innerHTML = '';
            
            uniqueGrades.forEach(grade => {
                const button = document.createElement('sl-button');
                button.setAttribute('variant', 'default');
                button.setAttribute('outline', '');
                button.className = 'option-item';
                button.dataset.value = grade;
                button.dataset.type = 'grade';
                button.textContent = this.getGradeDisplay(grade);
                container.appendChild(button);
            });
        }
        
        loadClasses() {
            const selectedGrade = parseInt(this.selections.grade);
            const filteredClasses = papsData.classes.filter(cls => cls.grade === selectedGrade);
            
            const container = this.elements.optionContainers.class;
            container.innerHTML = '';
            
            filteredClasses.forEach(cls => {
                const button = document.createElement('sl-button');
                button.setAttribute('variant', 'default');
                button.setAttribute('outline', '');
                button.className = 'option-item';
                button.dataset.value = cls.id;
                button.dataset.type = 'class';
                button.textContent = cls.name;
                container.appendChild(button);
            });
        }
        
        loadActivities() {
            const selectedSession = this.selections.session;
            const selectedGrade = parseInt(this.selections.grade);
            
            const sessionActivities = papsData.sessionActivities.filter(sa => 
                sa.session_id === selectedSession && sa.grade === selectedGrade
            );
            
            const container = this.elements.optionContainers.activity;
            container.innerHTML = '';
            
            const categorizedActivities = {};
            sessionActivities.forEach(sa => {
                const activity = papsData.activities.find(act => act.id === sa.activity_id);
                const category = papsData.categories.find(cat => cat.id === sa.category_id);
                
                if (activity && category) {
                    if (!categorizedActivities[category.display_name]) {
                        categorizedActivities[category.display_name] = [];
                    }
                    categorizedActivities[category.display_name].push({
                        id: activity.id,
                        name: activity.display_name
                    });
                }
            });
            
            // 카테고리별로 버튼 생성
            Object.keys(categorizedActivities).forEach(categoryName => {
                // 카테고리 헤더
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'text-sm font-medium text-gray-700 mt-4 mb-2';
                categoryHeader.textContent = categoryName;
                container.appendChild(categoryHeader);
                
                // 활동 버튼들
                categorizedActivities[categoryName].forEach(activity => {
                    const button = document.createElement('sl-button');
                    button.setAttribute('variant', 'default');
                    button.setAttribute('outline', '');
                    button.className = 'option-item';
                    button.dataset.value = activity.id;
                    button.dataset.type = 'activity';
                    button.textContent = activity.name;
                    container.appendChild(button);
                });
            });
        }
        
        updateProgress() {
            const selectedCount = Object.values(this.selections).filter(v => v !== null).length;
            
            // 상단 카운터 업데이트
            this.elements.progressCount.textContent = `${selectedCount}/5`;
            
            // 단계 표시기 업데이트
            this.updateStepIndicators(selectedCount);
            
            // 하단 버튼 업데이트
            this.updateSubmitButton(selectedCount);
        }
        
        updateStepIndicators(selectedCount) {
            for (let i = 1; i <= 5; i++) {
                const badge = document.getElementById(`badge-${i}`);
                const line = document.getElementById(`line-${i}`);
                
                if (i <= selectedCount) {
                    badge.setAttribute('variant', 'primary');
                    if (line) line.classList.add('completed');
                } else {
                    badge.setAttribute('variant', 'neutral');
                    if (line) line.classList.remove('completed');
                }
            }
        }
        
        updateSubmitButton(selectedCount) {
            if (selectedCount === 5) {
                // URL과 파라미터 설정
                const measurementUrl = `/physical_education/teachers/paps/measurement/measure/${this.selections.activity}/`;
                const params = {
                    school_year: this.selections.schoolYear,
                    session_id: this.selections.session,
                    grade: this.selections.grade,
                    class_id: this.selections.class
                };
                
                // htmx 속성 설정
                this.elements.submitButton.setAttribute('hx-get', measurementUrl);
                this.elements.submitButton.setAttribute('hx-push-url', measurementUrl);
                this.elements.submitButton.setAttribute('hx-vals', JSON.stringify(params));
                htmx.process(this.elements.submitButton);
                
                // 버튼 상태 변경
                this.elements.submitButton.textContent = '측정 시작하기';
                this.elements.submitButton.disabled = false;
            } else {
                // htmx 속성 초기화
                this.elements.submitButton.setAttribute('hx-get', '');
                this.elements.submitButton.setAttribute('hx-vals', '');
                
                // 버튼 상태 변경
                this.elements.submitButton.textContent = `조건 선택 (${selectedCount}/5)`;
                this.elements.submitButton.disabled = true;
            }
        }
        
        
        autoNavigate(type) {
            const currentSection = this.getCurrentSection(type);
            const nextSection = this.getNextSection(type);
            
            // 현재 섹션 닫기
            if (currentSection && currentSection.open) {
                currentSection.hide();
            }
            
            // 다음 섹션 열기 (활성화된 경우만)
            if (nextSection && !nextSection.disabled) {
                setTimeout(() => {
                    nextSection.show();
                }, 200);
            }
        }
        
        getCurrentSection(type) {
            const sectionMap = {
                schoolYear: 'year',
                session: 'session',
                grade: 'grade', 
                class: 'class',
                activity: 'activity'
            };
            return this.elements.sections[sectionMap[type]];
        }
        
        getNextSection(type) {
            const nextMap = {
                schoolYear: 'session',
                session: 'grade',
                grade: 'class', // 학년 선택 후에는 학급을 먼저 표시
                class: 'activity',
                activity: null
            };
            const nextSectionId = nextMap[type];
            return nextSectionId ? this.elements.sections[nextSectionId] : null;
        }
        
        handleSectionOpen(e) {
            // 다른 섹션들 닫기 (아코디언 효과)
            Object.values(this.elements.sections).forEach(section => {
                if (section !== e.target && section.open) {
                    section.hide();
                }
            });
        }
        
        handleSectionClose(e) {
            // 필요시 추가 처리
        }
        
        
        getGradeDisplay(grade) {
            if (grade <= 6) return `초${grade}`;
            else if (grade <= 9) return `중${grade - 6}`;
            else return `고${grade - 9}`;
        }
        
        // 기존 StateManager와 호환성을 위한 데이터 제공
        getFormData() {
            return {
                school_year: this.selections.schoolYear,
                session_id: this.selections.session,
                grade: this.selections.grade,
                class_id: this.selections.class,
                activity_id: this.selections.activity
            };
        }

        reconnectDom() {
            // DOM 요소 참조 재설정
            this.elements = {
                progressCount: document.getElementById('progress-count'),
                submitButton: document.getElementById('submit-button'),
                sections: {
                    year: document.getElementById('year-section'),
                    session: document.getElementById('session-section'),
                    grade: document.getElementById('grade-section'),
                    class: document.getElementById('class-section'),
                    activity: document.getElementById('activity-section')
                },
                optionContainers: {
                    session: document.getElementById('session-options'),
                    grade: document.getElementById('grade-options'),
                    class: document.getElementById('class-options'),
                    activity: document.getElementById('activity-options')
                }
            }

            // 이벤트 리스너 재등록
            this.setupEventListeners();
            
            // 저장된 상태로 UI 복원
            //this.rebuildUIFromState();
        }
        
    }
    
    // ================ 인스턴스 생성 ================
    const measurementSelector = new MeasurementSelector();
    
    // 전역 접근을 위한 변수 설정 (기존 코드와의 호환성)
    window.measurementSelector = measurementSelector;
    
    // HTMX 이벤트 처리
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        console.log('HTMX 페이지 전환 시작');
    });
    
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        console.log('HTMX 페이지 전환 완료');
    });
    
    document.body.addEventListener('htmx:responseError', function(evt) {
        console.error('HTMX 오류 발생:', evt.detail);
        alert('페이지를 불러오는 중 오류가 발생했습니다.');
    });

    document.body.addEventListener('htmx:historyRestore', function(evt) {
        if (document.getElementById('year-section')) {
            if (window.measurementSelector) {
                window.measurementSelector.reconnectDom();
            } else {
                window.measurementSelector = new MeasurementSelector();
            }
        }
    })
});
</script>
{% endblock %}