{% extends "teacher/base.html" %} {% load static %} {% block title %}PAPS
측정하기{% endblock %} {% block content %}
<div class="flex min-h-screen">
  <!-- 공통 사이드바 -->
  {% include "physical_education/teachers/partials/sidebar.html" %}

  <!-- 메인 컨텐츠 -->
  <div class="flex-1 lg:ml-64">
    <div class="max-w-3xl mx-auto px-4 lg:px-6">
      <!-- 페이지 내용 -->
      <div class="py-4 lg:py-6">
        <!-- 페이지 헤더 -->
        <div class="mb-6">
          <div class="flex items-start gap-3">
            <!-- 햄버거 메뉴 버튼 (모바일/태블릿) -->
            <button id="page-mobile-sidebar-toggle" 
                    class="lg:hidden p-2 rounded-md bg-green-100 text-green-600 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors"
                    aria-expanded="false"
                    aria-controls="sidebar"
                    aria-label="메뉴 열기">
              <i class="fas fa-bars text-lg"></i>
            </button>
            
            <!-- 페이지 제목 -->
            <div class="flex-1">
              <h1 class="text-2xl font-bold text-gray-900 mb-2">PAPS 측정하기</h1>
              <p class="text-gray-600">측정 관련 기능을 이용하세요</p>
            </div>
          </div>
        </div>

        <!-- 3단계 스텝 인터페이스 -->
        <div class="max-w-4xl mx-auto">
          <!-- 진행 상태 표시 -->
          <div class="mb-8">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <!-- Step 1: 측정 대상 선택 -->
                <div class="flex items-center">
                  <div class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-600 text-white text-sm font-medium step-indicator" data-step="1">
                    1
                  </div>
                  <span class="ml-2 text-sm font-medium text-gray-900 hidden sm:block">측정 대상 선택</span>
                </div>
                
                <!-- 연결선 1-2 -->
                <div class="flex-1 h-0.5 bg-gray-300 step-connector" data-step="1-2"></div>
                
                <!-- Step 2: 학급 및 종목 선택 -->
                <div class="flex items-center">
                  <div class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-300 text-gray-500 text-sm font-medium step-indicator" data-step="2">
                    2
                  </div>
                  <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:block">학급 및 종목 선택</span>
                </div>
                
                <!-- 연결선 2-3 -->
                <div class="flex-1 h-0.5 bg-gray-300 step-connector" data-step="2-3"></div>
                
                <!-- Step 3: 측정 화면 -->
                <div class="flex items-center">
                  <div class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-300 text-gray-500 text-sm font-medium step-indicator" data-step="3">
                    3
                  </div>
                  <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:block">측정 화면</span>
                </div>
              </div>
              
              <!-- 모바일용 현재 단계 표시 -->
              <div class="sm:hidden">
                <span class="text-sm text-gray-600">
                  <span id="current-step-mobile">1</span> / 3
                </span>
              </div>
            </div>
          </div>
          
          <!-- 단계별 콘텐츠 -->
          <div class="relative">
            <!-- Step 1: 측정 대상 선택 -->
            <div id="step-1" class="step-content">
              <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-xl font-semibold text-gray-900">측정 대상 선택</h2>
                  <div class="text-sm text-gray-500">1단계</div>
                </div>
                
                <!-- 측정 대상 선택 폼 -->
                <form id="step1-form" class="space-y-6">
                  <!-- 1. 학년도 선택 -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">학년도 선택</label>
                    <select id="school-year-select" name="school_year" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <option value="">학년도를 선택하세요</option>
                      {% for year in school_years %}
                        <option value="{{ year }}">{{ year }}년도</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <!-- 2. 측정회차 선택 -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">측정회차 선택</label>
                    <select id="session-select" name="session_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                      <option value="">먼저 학년도를 선택하세요</option>
                    </select>
                  </div>
                  
                  <!-- 3. 학년 선택 -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">학년 선택</label>
                    <select id="grade-select" name="grade" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                      <option value="">먼저 측정회차를 선택해주세요</option>
                    </select>
                  </div>
                </form>
                
                <!-- 1단계 네비게이션 -->
                <div class="flex justify-end mt-8 pt-6 border-t border-gray-200">
                  <button id="next-btn-step1" class="px-6 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    다음 단계
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Step 2: 학급 및 종목 선택 -->
            <div id="step-2" class="step-content hidden">
              <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-xl font-semibold text-gray-900">학급 및 종목 선택</h2>
                  <div class="text-sm text-gray-500">2단계</div>
                </div>
                
                <!-- 학급과 측정종목 선택 폼 -->
                <form id="step2-form" class="space-y-6">
                  <!-- 선택된 정보 표시 -->
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center">
                      <i class="fas fa-check-circle text-blue-600 mr-2"></i>
                      <span class="text-sm text-blue-800">선택된 대상: </span>
                      <span class="font-medium text-blue-900" id="selected-target-info">-</span>
                    </div>
                  </div>

                  <!-- 학급과 측정종목 선택 (수평 정렬) -->
                  <div class="flex space-x-4">
                    <!-- 학급 선택 -->
                    <div class="flex-1">
                      <label class="block text-sm font-medium text-gray-700 mb-2">학급 선택</label>
                      <select id="class-select" name="class_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">학급을 선택하세요</option>
                      </select>
                    </div>
                    
                    <!-- 측정종목 선택 -->
                    <div class="flex-1">
                      <label class="block text-sm font-medium text-gray-700 mb-2">측정종목 선택</label>
                      <select id="activity-select" name="activity_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">측정종목을 선택하세요</option>
                      </select>
                    </div>
                  </div>
                </form>
                
                <!-- 2단계 네비게이션 -->
                <div class="flex justify-between mt-8 pt-6 border-t border-gray-200">
                  <button id="prev-btn-step2" class="px-6 py-2 bg-gray-100 text-gray-700 text-sm rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    이전 단계
                  </button>
                  <button id="next-btn-step2" class="px-6 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    다음 단계
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Step 3: 측정 화면 -->
            <div id="step-3" class="step-content hidden">
              <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-xl font-semibold text-gray-900">측정 화면</h2>
                  <div class="text-sm text-gray-500">3단계</div>
                </div>
                
                <!-- 선택된 정보 표시 -->
                <div class="space-y-6">
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center">
                      <i class="fas fa-check-circle text-blue-600 mr-2"></i>
                      <span class="text-sm text-blue-800">선택된 대상: </span>
                      <span class="font-medium text-blue-900" id="selected-target-info-step3">-</span>
                    </div>
                  </div>
                  
                  <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="space-y-2">
                      <div class="flex items-center">
                        <i class="fas fa-users text-green-600 mr-2"></i>
                        <span class="text-sm text-green-800">선택된 학급: </span>
                        <span class="font-medium text-green-900" id="selected-class-info">-</span>
                      </div>
                      <div class="flex items-center">
                        <i class="fas fa-running text-green-600 mr-2"></i>
                        <span class="text-sm text-green-800">선택된 종목: </span>
                        <span class="font-medium text-green-900" id="selected-activity-info">-</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- 측정 화면 컨테이너 - HTMX로 동적 로드 -->
                <div class="mt-6">
                  <div id="measurement-container" 
                       hx-trigger="load-measurement from:body"
                       hx-get="/physical_education/paps/load-measurement/"
                       hx-include="#step1-form, #step2-form"
                       hx-indicator="#loading-indicator">
                    
                    <!-- 로딩 인디케이터 -->
                    <div id="loading-indicator" class="htmx-indicator border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                      <div class="text-gray-500">
                        <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium mb-2">측정 화면 로딩 중...</h3>
                      </div>
                    </div>
                    
                    <!-- 초기 상태 -->
                    <div class="initial-content border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                      <div class="text-gray-500">
                        <i class="fas fa-chart-line text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium mb-2">측정 화면 준비 중</h3>
                        <p class="text-sm">선택된 종목에 따른 측정 화면이 여기에 표시됩니다.</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- 3단계 네비게이션 -->
                <div class="flex justify-start mt-8 pt-6 border-t border-gray-200">
                  <button id="prev-btn-step3" class="px-6 py-2 bg-gray-100 text-gray-700 text-sm rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    이전 단계
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* HTMX 로딩 인디케이터 스타일 */
.htmx-indicator {
    display: none;
}

.htmx-request .htmx-indicator {
    display: block;
}

.htmx-request .initial-content {
    display: none;
}

/* 트랜지션 효과 */
#measurement-container {
    transition: opacity 0.3s ease;
}

#measurement-container.htmx-request {
    opacity: 0.7;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- HTMX 라이브러리 -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<script>
// ================ JSON 데이터 파싱 ================
const papsData = {
    classes: {{ classes_json|safe }},
    sessions: {{ sessions_json|safe }},
    categories: {{ categories_json|safe }},
    activities: {{ activities_json|safe }},
    sessionActivities: {{ session_activities_json|safe }}
};

document.addEventListener('DOMContentLoaded', function() {
    
    // ================ 개선된 상태 관리 시스템 ================
    class StateManager {
        constructor() {
            this.state = {
                currentStep: 1,
                selectedSchoolYear: null,
                selectedSession: null,
                selectedGrade: null,
                selectedClass: null,
                selectedActivity: null
            };
            
            this.listeners = new Map();
            this.storageKey = 'paps_measure_state';
        }
        
        // 상태 업데이트
        setState(updates) {
            const oldState = { ...this.state };
            this.state = { ...this.state, ...updates };
            
            // 변경된 키들만 리스너 호출
            Object.keys(updates).forEach(key => {
                if (oldState[key] !== this.state[key]) {
                    this.notify(key, this.state[key]);
                }
            });
            
            this.persist();
        }
        
        // 리스너 등록
        subscribe(key, callback) {
            if (!this.listeners.has(key)) {
                this.listeners.set(key, new Set());
            }
            this.listeners.get(key).add(callback);
        }
        
        // 리스너 알림
        notify(key, value) {
            this.listeners.get(key)?.forEach(callback => callback(value));
        }
        
        // sessionStorage에 저장
        persist() {
            sessionStorage.setItem(this.storageKey, JSON.stringify(this.state));
        }
        
        // sessionStorage에서 복원
        restore() {
            try {
                const saved = sessionStorage.getItem(this.storageKey);
                if (saved) {
                    this.state = JSON.parse(saved);
                    return true;
                }
            } catch (e) {
                console.error('상태 복원 중 오류:', e);
            }
            return false;
        }
        
        // 상태 초기화
        reset() {
            this.state = {
                currentStep: 1,
                selectedSchoolYear: null,
                selectedSession: null,
                selectedGrade: null,
                selectedClass: null,
                selectedActivity: null
            };
            this.persist();
            this.updateUI();
        }
        
        // URL 해시 업데이트
        updateHash() {
            const newHash = `#step-${this.state.currentStep}`;
            if (window.location.hash !== newHash) {
                history.replaceState(null, null, newHash);
            }
        }
        
        // 해시에서 단계 추출
        getStepFromHash() {
            const hash = window.location.hash;
            const match = hash.match(/#step-(\d+)/);
            return match ? parseInt(match[1]) : 1;
        }
        
        // UI 업데이트
        updateUI() {
            this.updateStepIndicators();
            this.updateStepContent();
            this.updateMobileStepCounter();
            this.updateHash();
        }
        
        updateStepIndicators() {
            for (let i = 1; i <= 3; i++) {
                const indicator = document.querySelector(`.step-indicator[data-step="${i}"]`);
                const label = indicator?.nextElementSibling;
                
                if (i < this.state.currentStep) {
                    // 완료된 단계
                    indicator?.classList.remove('bg-gray-300', 'text-gray-500', 'bg-blue-600');
                    indicator?.classList.add('bg-green-600', 'text-white');
                    label?.classList.remove('text-gray-500');
                    label?.classList.add('text-gray-900');
                    
                    // 연결선 업데이트
                    const connector = document.querySelector(`.step-connector[data-step="${i}-${i+1}"]`);
                    connector?.classList.remove('bg-gray-300');
                    connector?.classList.add('bg-green-600');
                } else if (i === this.state.currentStep) {
                    // 현재 단계
                    indicator?.classList.remove('bg-gray-300', 'text-gray-500', 'bg-green-600');
                    indicator?.classList.add('bg-blue-600', 'text-white');
                    label?.classList.remove('text-gray-500');
                    label?.classList.add('text-gray-900');
                } else {
                    // 미래 단계
                    indicator?.classList.remove('bg-blue-600', 'text-white', 'bg-green-600');
                    indicator?.classList.add('bg-gray-300', 'text-gray-500');
                    label?.classList.remove('text-gray-900');
                    label?.classList.add('text-gray-500');
                    
                    // 연결선 업데이트
                    const connector = document.querySelector(`.step-connector[data-step="${i-1}-${i}"]`);
                    connector?.classList.remove('bg-green-600');
                    connector?.classList.add('bg-gray-300');
                }
            }
        }
        
        updateStepContent() {
            document.querySelectorAll('.step-content').forEach((content, index) => {
                content.classList.toggle('hidden', index + 1 !== this.state.currentStep);
            });
        }
        
        updateMobileStepCounter() {
            const counter = document.getElementById('current-step-mobile');
            if (counter) {
                counter.textContent = this.state.currentStep;
            }
        }
        
        // 단계 이동
        goToStep(step) {
            if (step >= 1 && step <= 3) {
                this.setState({ currentStep: step });
                this.updateUI();
            }
        }
    }
    
    // 상태 관리자 인스턴스 생성
    const AppState = new StateManager();
    
    // ================ 폼 데이터 관리 ================
    class FormManager {
        constructor() {
            this.forms = {
                step1: document.getElementById('step1-form'),
                step2: document.getElementById('step2-form')
            };
        }
        
        // 폼 데이터 수집
        getFormData(formId) {
            const form = this.forms[formId];
            if (!form) return {};
            
            const formData = new FormData(form);
            return Object.fromEntries(formData.entries());
        }
        
        // 폼 데이터 복원
        restoreFormData(formId, data) {
            const form = this.forms[formId];
            if (!form) return;
            
            Object.entries(data).forEach(([key, value]) => {
                const element = form.querySelector(`[name="${key}"]`);
                if (element && value) {
                    element.value = value;
                }
            });
        }
        
        // 모든 폼 데이터 수집
        getAllFormData() {
            return {
                ...this.getFormData('step1'),
                ...this.getFormData('step2')
            };
        }
    }
    
    const formManager = new FormManager();
    
    // ================ 이벤트 핸들러 ================
    
    // 이벤트 위임을 통한 select 변경 처리
    document.getElementById('step1-form').addEventListener('change', function(e) {
        const target = e.target;
        
        if (target.id === 'school-year-select') {
            handleSchoolYearChange(target.value);
        } else if (target.id === 'session-select') {
            handleSessionChange(target.value);
        } else if (target.id === 'grade-select') {
            handleGradeChange(target.value);
        }
    });
    
    document.getElementById('step2-form').addEventListener('change', function(e) {
        const target = e.target;
        
        if (target.id === 'class-select') {
            AppState.setState({ selectedClass: target.value });
        } else if (target.id === 'activity-select') {
            AppState.setState({ selectedActivity: target.value });
        }
        
        validateStep2();
    });
    
    // 학년도 변경 핸들러
    function handleSchoolYearChange(value) {
        const selectedYear = value ? parseInt(value) : null;
        AppState.setState({ selectedSchoolYear: selectedYear });
        
        if (selectedYear) {
            const filteredSessions = papsData.sessions.filter(s => s.school_year === selectedYear);
            updateSessionOptions(filteredSessions);
        } else {
            resetSessionSelect();
            resetGradeSelect();
        }
        
        validateStep1();
    }
    
    // 측정회차 변경 핸들러
    function handleSessionChange(value) {
        AppState.setState({ selectedSession: value });
        
        if (value) {
            const sessionActivities = papsData.sessionActivities.filter(
                sa => sa.session_id === value
            );
            
            const uniqueGrades = [...new Set(sessionActivities.map(sa => sa.grade))].sort((a, b) => a - b);
            updateGradeOptions(uniqueGrades);
        } else {
            resetGradeSelect();
        }
        
        validateStep1();
    }
    
    // 학년 변경 핸들러
    function handleGradeChange(value) {
        AppState.setState({ selectedGrade: value });
        validateStep1();
    }
    
    // ================ UI 업데이트 함수 ================
    
    function updateSessionOptions(sessions) {
        const sessionSelect = document.getElementById('session-select');
        let options = '<option value="">측정회차를 선택하세요</option>';
        
        sessions.forEach(session => {
            options += `<option value="${session.id}">${session.name}</option>`;
        });
        
        sessionSelect.innerHTML = options;
        sessionSelect.disabled = false;
    }
    
    function updateGradeOptions(grades) {
        const gradeSelect = document.getElementById('grade-select');
        let options = '<option value="">학년을 선택하세요</option>';
        
        grades.forEach(grade => {
            const gradeDisplay = getGradeDisplay(grade);
            options += `<option value="${grade}">${gradeDisplay}</option>`;
        });
        
        gradeSelect.innerHTML = options;
        gradeSelect.disabled = false;
    }
    
    function resetSessionSelect() {
        const sessionSelect = document.getElementById('session-select');
        sessionSelect.innerHTML = '<option value="">먼저 학년도를 선택하세요</option>';
        sessionSelect.disabled = true;
        AppState.setState({ selectedSession: null });
    }
    
    function resetGradeSelect() {
        const gradeSelect = document.getElementById('grade-select');
        gradeSelect.innerHTML = '<option value="">먼저 측정회차를 선택해주세요</option>';
        gradeSelect.disabled = true;
        AppState.setState({ selectedGrade: null });
    }
    
    // ================ 네비게이션 버튼 이벤트 ================
    
    document.getElementById('next-btn-step1').addEventListener('click', function() {
        if (validateStep1()) {
            AppState.goToStep(2);
            updateSelectedInfo();
            loadStep2Options();
        }
    });
    
    document.getElementById('prev-btn-step2').addEventListener('click', function() {
        AppState.goToStep(1);
    });
    
    document.getElementById('next-btn-step2').addEventListener('click', function() {
        if (validateStep2()) {
            AppState.goToStep(3);
            updateStep3Info();
            
            // HTMX 트리거 발생
            setTimeout(() => {
                document.body.dispatchEvent(new CustomEvent('load-measurement'));
            }, 100);
        }
    });
    
    document.getElementById('prev-btn-step3').addEventListener('click', function() {
        AppState.goToStep(2);
    });
    
    // ================ 2단계 관련 함수 ================
    
    function loadStep2Options() {
        loadClassOptions();
        loadActivityOptions();
    }
    
    function loadClassOptions() {
        if (!AppState.state.selectedGrade) return;
        
        const filteredClasses = papsData.classes.filter(cls => 
            cls.grade === parseInt(AppState.state.selectedGrade)
        );
        
        const classSelect = document.getElementById('class-select');
        let options = '<option value="">학급을 선택하세요</option>';
        
        filteredClasses.forEach(cls => {
            options += `<option value="${cls.id}">${cls.name}</option>`;
        });
        
        classSelect.innerHTML = options;
    }
    
    function loadActivityOptions() {
        if (!AppState.state.selectedSession || !AppState.state.selectedGrade) return;
        
        const sessionActivities = papsData.sessionActivities.filter(sa => 
            sa.session_id === AppState.state.selectedSession && 
            sa.grade === parseInt(AppState.state.selectedGrade)
        );
        
        const activitySelect = document.getElementById('activity-select');
        let options = '<option value="">측정종목을 선택하세요</option>';
        
        const categorizedActivities = {};
        sessionActivities.forEach(sa => {
            const activity = papsData.activities.find(act => act.id === sa.activity_id);
            const category = papsData.categories.find(cat => cat.id === sa.category_id);
            
            if (activity && category) {
                if (!categorizedActivities[category.display_name]) {
                    categorizedActivities[category.display_name] = [];
                }
                categorizedActivities[category.display_name].push({
                    id: activity.id,
                    name: activity.display_name
                });
            }
        });
        
        Object.keys(categorizedActivities).forEach(categoryName => {
            options += `<optgroup label="${categoryName}">`;
            categorizedActivities[categoryName].forEach(activity => {
                options += `<option value="${activity.id}">${activity.name}</option>`;
            });
            options += '</optgroup>';
        });
        
        activitySelect.innerHTML = options;
    }
    
    // ================ 유효성 검사 ================
    
    function validateStep1() {
        const isValid = AppState.state.selectedSchoolYear && 
                       AppState.state.selectedSession && 
                       AppState.state.selectedGrade;
        
        const nextBtn = document.getElementById('next-btn-step1');
        nextBtn.disabled = !isValid;
        
        return isValid;
    }
    
    function validateStep2() {
        const isValid = AppState.state.selectedClass && 
                       AppState.state.selectedActivity;
        
        const nextBtn = document.getElementById('next-btn-step2');
        nextBtn.disabled = !isValid;
        
        return isValid;
    }
    
    // ================ 정보 표시 업데이트 ================
    
    function updateSelectedInfo() {
        const infoElement = document.getElementById('selected-target-info');
        if (AppState.state.selectedSchoolYear && AppState.state.selectedSession && AppState.state.selectedGrade) {
            const selectedSessionData = papsData.sessions.find(s => s.id === AppState.state.selectedSession);
            const gradeDisplay = getGradeDisplay(parseInt(AppState.state.selectedGrade));
            
            if (selectedSessionData) {
                const info = `${AppState.state.selectedSchoolYear}년도 ${selectedSessionData.session_type_display} - ${gradeDisplay}`;
                infoElement.textContent = info;
            }
        }
    }
    
    function updateStep3Info() {
        const targetInfoElement = document.getElementById('selected-target-info-step3');
        if (AppState.state.selectedSchoolYear && AppState.state.selectedSession && AppState.state.selectedGrade) {
            const selectedSessionData = papsData.sessions.find(s => s.id === AppState.state.selectedSession);
            const gradeDisplay = getGradeDisplay(parseInt(AppState.state.selectedGrade));
            
            if (selectedSessionData) {
                const info = `${AppState.state.selectedSchoolYear}년도 ${selectedSessionData.session_type_display} - ${gradeDisplay}`;
                targetInfoElement.textContent = info;
            }
        }
        
        const classInfoElement = document.getElementById('selected-class-info');
        if (AppState.state.selectedClass) {
            const selectedClassData = papsData.classes.find(cls => cls.id === parseInt(AppState.state.selectedClass));
            if (selectedClassData) {
                classInfoElement.textContent = selectedClassData.name;
            }
        }
        
        const activityInfoElement = document.getElementById('selected-activity-info');
        console.log("Selected Activity ID:", AppState.state.selectedActivity);
        console.log("Available Activities:", papsData.activities);
        if (AppState.state.selectedActivity) {
            const selectedActivityData = papsData.activities.find(act => act.id === AppState.state.selectedActivity);
            if (selectedActivityData) {
                activityInfoElement.textContent = selectedActivityData.display_name;
            }
        }
    }
    
    // ================ 유틸리티 함수 ================
    
    function getGradeDisplay(grade) {
        if (grade <= 6) return `초${grade}`;
        else if (grade <= 9) return `중${grade - 6}`;
        else return `고${grade - 9}`;
    }
    
    // ================ 해시 변경 처리 ================
    
    window.addEventListener('hashchange', function() {
        const step = AppState.getStepFromHash();
        if (step !== AppState.state.currentStep) {
            AppState.goToStep(step);
        }
    });
    
    // ================ HTMX 이벤트 처리 ================
    
    // 측정 화면 로드 완료 시
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'measurement-container') {
            console.log('측정 화면 로드 완료');
        }
    });
    
    // 측정 화면 로드 에러 시
    document.body.addEventListener('htmx:responseError', function(evt) {
        if (evt.detail.target.id === 'measurement-container') {
            console.error('측정 화면 로드 실패');
            evt.detail.target.innerHTML = `
                <div class="border-2 border-red-300 bg-red-50 rounded-lg p-8 text-center">
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium mb-2">로드 실패</h3>
                        <p class="text-sm">측정 화면을 불러오는데 실패했습니다.</p>
                    </div>
                </div>
            `;
        }
    });
    
    // ================ 초기화 ================
    
    function initialize() {
        // 상태 복원
        const hasRestoredState = AppState.restore();
        
        // 해시에서 단계 확인
        const hashStep = AppState.getStepFromHash();
        if (hashStep !== AppState.state.currentStep) {
            AppState.setState({ currentStep: hashStep });
        }
        
        // 상태가 복원되었다면 폼 데이터 복원
        if (hasRestoredState) {
            restoreAllForms();
        }
        
        // UI 초기화
        AppState.updateUI();
        
        // 현재 단계에 따른 초기 검증
        if (AppState.state.currentStep === 1) {
            validateStep1();
        } else if (AppState.state.currentStep === 2) {
            updateSelectedInfo();
            loadStep2Options();
            validateStep2();
        } else if (AppState.state.currentStep === 3) {
            updateSelectedInfo();
            loadStep2Options();
            updateStep3Info();
            
            // 3단계로 직접 접근한 경우 측정 화면 로드
            setTimeout(() => {
                document.body.dispatchEvent(new CustomEvent('load-measurement'));
            }, 100);
        }
    }
    
    // 폼 데이터 복원
    function restoreAllForms() {
        // Step 1 폼 복원
        if (AppState.state.selectedSchoolYear) {
            document.getElementById('school-year-select').value = AppState.state.selectedSchoolYear;
            handleSchoolYearChange(AppState.state.selectedSchoolYear);
        }
        
        if (AppState.state.selectedSession) {
            // 옵션이 로드된 후 값 설정
            requestAnimationFrame(() => {
                document.getElementById('session-select').value = AppState.state.selectedSession;
                handleSessionChange(AppState.state.selectedSession);
            });
        }
        
        if (AppState.state.selectedGrade) {
            // 옵션이 로드된 후 값 설정
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    document.getElementById('grade-select').value = AppState.state.selectedGrade;
                });
            });
        }
        
        // Step 2 폼 복원
        if (AppState.state.currentStep >= 2) {
            requestAnimationFrame(() => {
                if (AppState.state.selectedClass) {
                    document.getElementById('class-select').value = AppState.state.selectedClass;
                }
                if (AppState.state.selectedActivity) {
                    document.getElementById('activity-select').value = AppState.state.selectedActivity;
                }
            });
        }
    }
    
    // 초기화 실행
    initialize();
});
</script>
{% endblock %}