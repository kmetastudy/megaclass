{% extends "teacher/base.html" %}

{% block title %}PAPS 필수평가 입력{% endblock %}

{% block content %}
<div class="flex min-h-screen mobile-nav-padding">
    <!-- 공통 사이드바 -->
    {% include "physical_education/teachers/partials/sidebar.html" %}
    
    <!-- 메인 컨텐츠 -->
    <div class="flex-1 lg:ml-64">
        <!-- 페이지 내용 -->
        <div class="p-4 lg:p-6">
            <!-- 페이지 헤더 -->
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-2">PAPS 필수평가 입력</h1>
                <p class="text-gray-600">학급별 필수평가 측정 결과를 입력하세요</p>
            </div>
            
            <!-- 메시지 표시 영역 -->
            <div id="message-area" class="mb-6 hidden">
                <div class="p-4 rounded-lg border">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span id="message-text"></span>
                    </div>
                </div>
            </div>
            
            <!-- 필터 선택 영역 -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- 학년도 선택 -->
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-700 mb-1">
                            <span class="text-red-500">*</span> 학년도
                        </label>
                        <select id="year-select" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    
                    <!-- 학년 선택 -->
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-700 mb-1">
                            <span class="text-red-500">*</span> 학년
                        </label>
                        <select id="grade-select" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="4" selected>4학년</option>
                            <option value="5">5학년</option>
                            <option value="6">6학년</option>
                            <option value="7">중1</option>
                            <option value="8">중2</option>
                            <option value="9">중3</option>
                            <option value="10">고1</option>
                            <option value="11">고2</option>
                            <option value="12">고3</option>
                        </select>
                    </div>
                    
                    <!-- 학급 선택 -->
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-700 mb-1">
                            <span class="text-red-500">*</span> 학급
                        </label>
                        <select id="class-select" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="1" selected>1반</option>
                            <option value="2">2반</option>
                            <option value="3">3반</option>
                            <option value="4">4반</option>
                            <option value="5">5반</option>
                        </select>
                    </div>
                    
                    <!-- 측정회차 선택 -->
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-700 mb-1">
                            <span class="text-red-500">*</span> 측정회차
                        </label>
                        <select id="session-select" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="2025정시1차" selected>2025정시1차</option>
                            <option value="2025수시1차">2025수시1차</option>
                            <option value="2025수시2차">2025수시2차</option>
                        </select>
                    </div>
                </div>
                
                <!-- 조회 버튼 -->
                <div class="mt-4 flex justify-end">
                    <button id="filter-search-btn" class="px-6 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                        <i class="fas fa-search mr-2"></i>조회
                    </button>
                </div>
                
                <!-- 안내 문구 -->
                <div class="mt-3 text-xs text-gray-500 space-y-1">
                    <p>※ 선택한 조건에 따라 해당 학급의 학생 목록이 표시됩니다.</p>
                    <p>※ 필수평가는 5개 체력요인별로 1개씩 선택된 종목의 결과를 입력합니다.</p>
                </div>
            </div>
            
            <!-- 데이터 로딩 상태 표시 -->
            <div id="loading-area" class="text-center py-8 hidden">
                <div class="inline-flex items-center">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <span class="ml-2 text-gray-600">데이터를 불러오는 중...</span>
                </div>
            </div>
            
            <!-- 메인 콘텐츠 영역 (초기에는 숨김) -->
            <div id="main-content" class="hidden">
                <!-- 5개 필수평가 탭 네비게이션 -->
                <div class="mb-6">
                    <nav class="flex flex-wrap gap-1 bg-gray-100 rounded-lg p-1">
                        <button class="tab-btn flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors active" data-tab="cardio">
                            심폐지구력
                        </button>
                        <button class="tab-btn flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors" data-tab="flexibility">
                            유연성
                        </button>
                        <button class="tab-btn flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors" data-tab="strength">
                            근력/근지구력
                        </button>
                        <button class="tab-btn flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors" data-tab="agility">
                            순발력
                        </button>
                        <button class="tab-btn flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors" data-tab="bodyfat">
                            비만
                        </button>
                    </nav>
                </div>
                
                <!-- 현재 선택된 종목 정보 -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        <div>
                            <div class="font-medium text-blue-900">
                                현재 종목: <span id="current-activity-name">왕복오래달리기</span>
                            </div>
                            <div class="text-sm text-blue-700 mt-1">
                                <span id="current-activity-description">완주 횟수를 입력하세요 (0-150회)</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 학생별 측정 입력 영역 -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <!-- 헤더 -->
                    <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-medium text-gray-900">
                                <span id="students-count">15</span>명의 학생
                            </h3>
                            <div class="flex gap-2 text-sm">
                                <button id="save-all-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                                    <i class="fas fa-save mr-2"></i>모두 저장
                                </button>
                                <button id="clear-all-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors">
                                    <i class="fas fa-eraser mr-2"></i>모두 지우기
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 데스크톱: Table 형태 (1024px+) -->
                    <div class="hidden lg:block p-4">
                        <div class="overflow-x-auto">
                            <div id="students-table-container">
                                <!-- Table이 여기에 동적으로 생성됩니다 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 모바일/태블릿: 카드 형태 (< 1024px) -->
                    <div class="lg:hidden p-4">
                        <div id="students-container" class="space-y-4">
                            <!-- 학생 카드들이 여기에 동적으로 생성됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* 탭 버튼 스타일 */
.tab-btn {
    color: #6b7280;
    background: transparent;
}

.tab-btn.active {
    color: #1f2937;
    background: #ffffff;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}

.tab-btn:hover:not(.active) {
    color: #374151;
    background: rgba(255, 255, 255, 0.5);
}

/* 학생 카드 호버 효과 */
.student-card {
    transition: all 0.2s ease;
}

.student-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* 입력 필드 포커스 효과 */
.measurement-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* 등급 색상 */
.grade-1 { color: #dc2626; font-weight: bold; }
.grade-2 { color: #ea580c; font-weight: bold; }
.grade-3 { color: #ca8a04; font-weight: bold; }
.grade-4 { color: #16a34a; font-weight: bold; }
.grade-5 { color: #2563eb; font-weight: bold; }

/* Table 전용 스타일 */
.paps-table {
    font-size: 0.75rem; /* 12px */
    line-height: 1.25rem;
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
}

.paps-table th {
    background-color: #f9fafb;
    font-weight: 600;
    text-align: center;
    padding: 0.5rem 0.25rem;
    border: 1px solid #d1d5db;
    white-space: nowrap;
    vertical-align: middle;
}

.paps-table td {
    padding: 0.25rem;
    border: 1px solid #d1d5db;
    text-align: center;
    vertical-align: middle;
    min-width: 60px;
}

.paps-table td.student-info {
    background-color: #fafafa;
    font-weight: 500;
    white-space: nowrap;
}

.paps-table input {
    width: 100%;
    text-align: center;
    padding: 0.25rem;
    border: none;
    background: transparent;
    font-size: 0.75rem;
}

.paps-table input:focus {
    background: #eff6ff;
    outline: 2px solid #3b82f6;
    border-radius: 2px;
}

.paps-table input:disabled {
    background-color: #f3f4f6;
    color: #6b7280;
    cursor: not-allowed;
}

/* 계산된 필드 스타일 */
.calculated-field {
    background-color: #f3f4f6 !important;
    color: #374151;
    font-weight: 500;
}

/* 등급 색상 (Table용) */
.table-grade-1 { color: #dc2626; font-weight: bold; }
.table-grade-2 { color: #ea580c; font-weight: bold; }
.table-grade-3 { color: #ca8a04; font-weight: bold; }
.table-grade-4 { color: #16a34a; font-weight: bold; }
.table-grade-5 { color: #2563eb; font-weight: bold; }

/* 헤더 그룹 스타일 */
.header-group {
    background-color: #e5e7eb;
    font-weight: 700;
}

/* 입력 필드 너비 조정 */
.input-narrow { min-width: 50px; max-width: 70px; }
.input-medium { min-width: 70px; max-width: 90px; }
.input-wide { min-width: 90px; max-width: 120px; }

/* 반응형 조정 */
@media (max-width: 768px) {
    .tab-btn {
        font-size: 0.75rem;
        padding: 0.5rem 0.25rem;
    }
}

@media (min-width: 1024px) {
    .desktop-table { display: block; }
    .mobile-cards { display: none; }
}

@media (max-width: 1023px) {
    .desktop-table { display: none; }
    .mobile-cards { display: block; }
}
</style>

<script>
// 앱 상태 관리
const appState = {
    selectedYear: 2025,
    selectedGrade: 4,
    selectedClass: 1,
    selectedSession: "2025정시1차",
    activeTab: "cardio",
    activeActivity: "shuttle",
    studentsData: {},
    isDirty: false
};

// 더미 학생 데이터 (4학년 1반 15명)
const mockStudents = [
    { id: 1, name: "김철수", number: 1, gender: "M" },
    { id: 2, name: "이영희", number: 2, gender: "F" },
    { id: 3, name: "박민수", number: 3, gender: "M" },
    { id: 4, name: "최지은", number: 4, gender: "F" },
    { id: 5, name: "정우진", number: 5, gender: "M" },
    { id: 6, name: "한소영", number: 6, gender: "F" },
    { id: 7, name: "김대현", number: 7, gender: "M" },
    { id: 8, name: "이수민", number: 8, gender: "F" },
    { id: 9, name: "조현우", number: 9, gender: "M" },
    { id: 10, name: "윤채은", number: 10, gender: "F" },
    { id: 11, name: "강민호", number: 11, gender: "M" },
    { id: 12, name: "송다은", number: 12, gender: "F" },
    { id: 13, name: "임준혁", number: 13, gender: "M" },
    { id: 14, name: "배서현", number: 14, gender: "F" },
    { id: 15, name: "홍성민", number: 15, gender: "M" }
];

// 5개 필수평가 카테고리와 종목 데이터
const requiredCategories = {
    cardio: {
        name: "심폐지구력",
        description: "심폐지구력 측정 종목",
        activities: {
            shuttle: {
                id: "shuttle",
                name: "왕복오래달리기",
                description: "완주 횟수를 입력하세요 (0-150회)",
                fields: [
                    { name: "shuttles", label: "완주 횟수", type: "number", unit: "회", min: 0, max: 150, placeholder: "예: 85" }
                ]
            }
        }
    },
    flexibility: {
        name: "유연성",
        description: "유연성 측정 종목",
        activities: {
            sitreach: {
                id: "sitreach",
                name: "앉아윗몸앞으로굽히기",
                description: "1차, 2차 측정값을 입력하세요 (-40.0 ~ 50.0cm)",
                fields: [
                    { name: "first", label: "1차", type: "number", unit: "cm", min: -40.0, max: 50.0, step: 0.1, placeholder: "예: 15.5" },
                    { name: "second", label: "2차", type: "number", unit: "cm", min: -40.0, max: 50.0, step: 0.1, placeholder: "예: 16.2" },
                    { name: "max", label: "최댓값", type: "number", unit: "cm", readonly: true, calculated: true }
                ]
            }
        }
    },
    strength: {
        name: "근력/근지구력",
        description: "근력/근지구력 측정 종목",
        activities: {
            grip: {
                id: "grip",
                name: "악력",
                description: "좌우 각 2회씩 측정하세요 (0-80kg)",
                fields: [
                    { name: "left1", label: "좌1차", type: "number", unit: "kg", min: 0, max: 80, step: 0.1, placeholder: "예: 25.5" },
                    { name: "left2", label: "좌2차", type: "number", unit: "kg", min: 0, max: 80, step: 0.1, placeholder: "예: 26.0" },
                    { name: "right1", label: "우1차", type: "number", unit: "kg", min: 0, max: 80, step: 0.1, placeholder: "예: 27.2" },
                    { name: "right2", label: "우2차", type: "number", unit: "kg", min: 0, max: 80, step: 0.1, placeholder: "예: 26.8" },
                    { name: "max", label: "최댓값", type: "number", unit: "kg", readonly: true, calculated: true }
                ]
            }
        }
    },
    agility: {
        name: "순발력",
        description: "순발력 측정 종목",
        activities: {
            longjump: {
                id: "longjump",
                name: "제자리멀리뛰기",
                description: "1차, 2차 측정값을 입력하세요 (0-400cm)",
                fields: [
                    { name: "first", label: "1차", type: "number", unit: "cm", min: 0, max: 400, placeholder: "예: 180" },
                    { name: "second", label: "2차", type: "number", unit: "cm", min: 0, max: 400, placeholder: "예: 185" },
                    { name: "max", label: "최댓값", type: "number", unit: "cm", readonly: true, calculated: true }
                ]
            }
        }
    },
    bodyfat: {
        name: "비만",
        description: "체질량지수(BMI) 측정",
        activities: {
            bmi: {
                id: "bmi",
                name: "체질량지수(BMI) 측정",
                description: "신장과 체중을 입력하세요",
                fields: [
                    { name: "height", label: "신장", type: "number", unit: "cm", min: 100, max: 300, step: 0.1, placeholder: "예: 142.5" },
                    { name: "weight", label: "체중", type: "number", unit: "kg", min: 20, max: 200, step: 0.1, placeholder: "예: 35.2" },
                    { name: "bmi", label: "BMI", type: "number", unit: "kg/m²", readonly: true, calculated: true }
                ]
            }
        }
    }
};

// 5개 필수평가별 Table 헤더 구조 (docs 문서 기반)
const tableHeaders = {
    cardio: {
        title: "심폐지구력 측정 결과표",
        headers: [
            { text: "순번", rowspan: 2, class: "input-narrow" },
            { text: "번호", rowspan: 2, class: "input-narrow" },
            { text: "성명", rowspan: 2, class: "input-medium" },
            { text: "성별", rowspan: 2, class: "input-narrow" },
            { text: "왕복오래달리기(회)", rowspan: 2, class: "input-wide", field: "shuttles" },
            { text: "오래달리기/걷기(분.초)", rowspan: 2, class: "input-wide", field: "longrun" },
            { text: "스텝검사", colspan: 5, class: "header-group" },
            { text: "점수", rowspan: 2, class: "input-narrow", calculated: true },
            { text: "등급", rowspan: 2, class: "input-narrow", calculated: true }
        ],
        subHeaders: [
            { text: "촉진", field: "pulse", class: "input-narrow" },
            { text: "심박수(1)(회/분)", field: "hr1", class: "input-medium" },
            { text: "심박수(2)(회/분)", field: "hr2", class: "input-medium" },
            { text: "심박수(3)(회/분)", field: "hr3", class: "input-medium" },
            { text: "PEI", calculated: true, class: "input-medium" }
        ]
    },
    flexibility: {
        title: "유연성 측정 결과표",
        headers: [
            { text: "순번", rowspan: 3, class: "input-narrow" },
            { text: "번호", rowspan: 3, class: "input-narrow" },
            { text: "성명", rowspan: 3, class: "input-medium" },
            { text: "성별", rowspan: 3, class: "input-narrow" },
            { text: "앉아윗몸앞으로굽히기(cm)", colspan: 3, class: "header-group" },
            { text: "종합유연성평가(0: 실패, 1: 성공)", colspan: 9, class: "header-group" },
            { text: "점수", rowspan: 3, class: "input-narrow", calculated: true },
            { text: "등급", rowspan: 3, class: "input-narrow", calculated: true }
        ],
        subHeaders: [
            { text: "1차", rowspan: 2, field: "first", class: "input-narrow" },
            { text: "2차", rowspan: 2, field: "second", class: "input-narrow" },
            { text: "평가값", rowspan: 2, calculated: true, class: "input-narrow" },
            { text: "어깨", colspan: 2, class: "header-group" },
            { text: "몸통", colspan: 2, class: "header-group" },
            { text: "옆구리", colspan: 2, class: "header-group" },
            { text: "하체", colspan: 2, class: "header-group" },
            { text: "평가값", rowspan: 2, calculated: true, class: "input-narrow" }
        ],
        subSubHeaders: [
            { text: "좌", field: "shoulder_left", class: "input-narrow" },
            { text: "우", field: "shoulder_right", class: "input-narrow" },
            { text: "좌", field: "trunk_left", class: "input-narrow" },
            { text: "우", field: "trunk_right", class: "input-narrow" },
            { text: "좌", field: "side_left", class: "input-narrow" },
            { text: "우", field: "side_right", class: "input-narrow" },
            { text: "좌", field: "lower_left", class: "input-narrow" },
            { text: "우", field: "lower_right", class: "input-narrow" }
        ]
    },
    strength: {
        title: "근력·근지구력 측정 결과표",
        headers: [
            { text: "순번", rowspan: 3, class: "input-narrow" },
            { text: "번호", rowspan: 3, class: "input-narrow" },
            { text: "성명", rowspan: 3, class: "input-medium" },
            { text: "성별", rowspan: 3, class: "input-narrow" },
            { text: "(무릎대고)팔굽혀펴기(회)", rowspan: 3, class: "input-wide", field: "pushup" },
            { text: "윗몸말아올리기(회)", rowspan: 3, class: "input-wide", field: "situp" },
            { text: "악력(kg)", colspan: 5, class: "header-group" },
            { text: "점수", rowspan: 3, class: "input-narrow", calculated: true },
            { text: "등급", rowspan: 3, class: "input-narrow", calculated: true }
        ],
        subHeaders: [
            { text: "1차", colspan: 2, class: "header-group" },
            { text: "2차", colspan: 2, class: "header-group" },
            { text: "악력", rowspan: 2, calculated: true, class: "input-narrow" }
        ],
        subSubHeaders: [
            { text: "오른쪽", field: "right1", class: "input-narrow" },
            { text: "왼쪽", field: "left1", class: "input-narrow" },
            { text: "오른쪽", field: "right2", class: "input-narrow" },
            { text: "왼쪽", field: "left2", class: "input-narrow" }
        ]
    },
    agility: {
        title: "순발력 측정 결과표",
        headers: [
            { text: "순번", rowspan: 2, class: "input-narrow" },
            { text: "번호", rowspan: 2, class: "input-narrow" },
            { text: "성명", rowspan: 2, class: "input-medium" },
            { text: "성별", rowspan: 2, class: "input-narrow" },
            { text: "50m 달리기(초)", rowspan: 2, class: "input-wide", field: "sprint50" },
            { text: "제자리멀리뛰기(cm)", colspan: 3, class: "header-group" },
            { text: "점수", rowspan: 2, class: "input-narrow", calculated: true },
            { text: "등급", rowspan: 2, class: "input-narrow", calculated: true }
        ],
        subHeaders: [
            { text: "1차", field: "first", class: "input-narrow" },
            { text: "2차", field: "second", class: "input-narrow" },
            { text: "평가값", calculated: true, class: "input-narrow" }
        ]
    },
    bodyfat: {
        title: "비만 측정 결과표",
        headers: [
            { text: "순번", class: "input-narrow" },
            { text: "번호", class: "input-narrow" },
            { text: "성명", class: "input-medium" },
            { text: "성별", class: "input-narrow" },
            { text: "신장(cm)", field: "height", class: "input-medium" },
            { text: "체중(kg)", field: "weight", class: "input-medium" },
            { text: "BMI(kg/㎡)", calculated: true, class: "input-medium" },
            { text: "점수", calculated: true, class: "input-narrow" },
            { text: "등급", calculated: true, class: "input-narrow" }
        ]
    }
};

// DOM 요소들
let elements = {};

// 초기화 함수
function init() {
    // DOM 요소 캐싱
    elements = {
        yearSelect: document.getElementById('year-select'),
        gradeSelect: document.getElementById('grade-select'),
        classSelect: document.getElementById('class-select'),
        sessionSelect: document.getElementById('session-select'),
        filterSearchBtn: document.getElementById('filter-search-btn'),
        loadingArea: document.getElementById('loading-area'),
        mainContent: document.getElementById('main-content'),
        messageArea: document.getElementById('message-area'),
        messageText: document.getElementById('message-text'),
        studentsContainer: document.getElementById('students-container'),
        studentsTableContainer: document.getElementById('students-table-container'),
        studentsCount: document.getElementById('students-count'),
        currentActivityName: document.getElementById('current-activity-name'),
        currentActivityDescription: document.getElementById('current-activity-description'),
        saveAllBtn: document.getElementById('save-all-btn'),
        clearAllBtn: document.getElementById('clear-all-btn')
    };

    // 이벤트 리스너 등록
    setupEventListeners();
    
    // 초기 상태 설정
    initializeState();
}

// 이벤트 리스너 설정
function setupEventListeners() {
    // 필터 조회 버튼
    elements.filterSearchBtn.addEventListener('click', handleFilterSearch);
    
    // 탭 버튼들
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const tabName = e.target.dataset.tab;
            switchTab(tabName);
        });
    });
    
    // 저장/지우기 버튼
    elements.saveAllBtn.addEventListener('click', handleSaveAll);
    elements.clearAllBtn.addEventListener('click', handleClearAll);
}

// 초기 상태 설정
function initializeState() {
    // 필터 값들 초기화
    appState.selectedYear = parseInt(elements.yearSelect.value);
    appState.selectedGrade = parseInt(elements.gradeSelect.value);
    appState.selectedClass = parseInt(elements.classSelect.value);
    appState.selectedSession = elements.sessionSelect.value;
    
    // 학생 데이터 초기화
    mockStudents.forEach(student => {
        appState.studentsData[student.id] = {};
    });
    
    console.log('앱 초기화 완료', appState);
}

// 필터 조회 처리
function handleFilterSearch() {
    // 로딩 표시
    showLoading(true);
    elements.mainContent.classList.add('hidden');
    
    // 상태 업데이트
    appState.selectedYear = parseInt(elements.yearSelect.value);
    appState.selectedGrade = parseInt(elements.gradeSelect.value);
    appState.selectedClass = parseInt(elements.classSelect.value);
    appState.selectedSession = elements.sessionSelect.value;
    
    // 시뮬레이션: 1초 후 데이터 로드 완료
    setTimeout(() => {
        showLoading(false);
        elements.mainContent.classList.remove('hidden');
        
        // 현재 활성 탭의 내용 렌더링
        renderCurrentTab();
        
        // 성공 메시지 표시
        showMessage('success', `${appState.selectedGrade}학년 ${appState.selectedClass}반 학생 목록을 불러왔습니다.`);
    }, 1000);
}

// 로딩 상태 표시/숨김
function showLoading(show) {
    if (show) {
        elements.loadingArea.classList.remove('hidden');
    } else {
        elements.loadingArea.classList.add('hidden');
    }
}

// 메시지 표시
function showMessage(type, message) {
    const typeClasses = {
        success: 'bg-green-50 text-green-800 border-green-200',
        error: 'bg-red-50 text-red-800 border-red-200',
        warning: 'bg-yellow-50 text-yellow-800 border-yellow-200',
        info: 'bg-blue-50 text-blue-800 border-blue-200'
    };
    
    const iconClasses = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    elements.messageArea.className = `mb-6 ${typeClasses[type]} p-4 rounded-lg border`;
    elements.messageArea.querySelector('i').className = `fas ${iconClasses[type]} mr-2`;
    elements.messageText.textContent = message;
    elements.messageArea.classList.remove('hidden');
    
    // 3초 후 자동 숨김
    setTimeout(() => {
        elements.messageArea.classList.add('hidden');
    }, 3000);
}

// 탭 전환 함수
function switchTab(tabName) {
    appState.activeTab = tabName;
    
    // 탭 버튼 활성화 상태 업데이트
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tabName) {
            btn.classList.add('active');
        }
    });
    
    // 현재 탭 내용 렌더링
    renderCurrentTab();
}

// 현재 탭 내용 렌더링
function renderCurrentTab() {
    const category = requiredCategories[appState.activeTab];
    const activityKey = Object.keys(category.activities)[0]; // 첫 번째 활동 선택
    const activity = category.activities[activityKey];
    
    appState.activeActivity = activityKey;
    
    // 현재 종목 정보 업데이트
    elements.currentActivityName.textContent = activity.name;
    elements.currentActivityDescription.textContent = activity.description;
    
    // 데스크톱: Table 렌더링
    renderStudentTable();
    
    // 모바일: 카드 렌더링
    renderStudentCards(activity);
    
    // 학생 수 표시 업데이트
    elements.studentsCount.textContent = mockStudents.length;
}

// 학생 Table 렌더링 (데스크톱용)
function renderStudentTable() {
    const tableConfig = tableHeaders[appState.activeTab];
    if (!tableConfig) return;
    
    const tableHTML = generateTableHTML(tableConfig);
    elements.studentsTableContainer.innerHTML = tableHTML;
    
    // Table 이벤트 리스너 설정
    setupTableEventListeners();
}

// Table HTML 생성
function generateTableHTML(config) {
    let html = `<table class="paps-table">`;
    
    // 헤더 생성
    html += generateTableHeaders(config);
    
    // 바디 생성
    html += generateTableBody(config);
    
    html += `</table>`;
    return html;
}

// Table 헤더 생성
function generateTableHeaders(config) {
    let html = '<thead>';
    
    // 첫 번째 헤더 행
    html += '<tr>';
    config.headers.forEach(header => {
        const rowspan = header.rowspan ? ` rowspan="${header.rowspan}"` : '';
        const colspan = header.colspan ? ` colspan="${header.colspan}"` : '';
        const className = header.class ? ` class="${header.class} ${header.class === 'header-group' ? 'header-group' : ''}"` : '';
        html += `<th${rowspan}${colspan}${className}>${header.text}</th>`;
    });
    html += '</tr>';
    
    // 두 번째 헤더 행 (subHeaders가 있는 경우)
    if (config.subHeaders) {
        html += '<tr>';
        config.subHeaders.forEach(header => {
            const rowspan = header.rowspan ? ` rowspan="${header.rowspan}"` : '';
            const colspan = header.colspan ? ` colspan="${header.colspan}"` : '';
            const className = header.class ? ` class="${header.class} ${header.class === 'header-group' ? 'header-group' : ''}"` : '';
            html += `<th${rowspan}${colspan}${className}>${header.text}</th>`;
        });
        html += '</tr>';
    }
    
    // 세 번째 헤더 행 (subSubHeaders가 있는 경우)
    if (config.subSubHeaders) {
        html += '<tr>';
        config.subSubHeaders.forEach(header => {
            const className = header.class ? ` class="${header.class}"` : '';
            html += `<th${className}>${header.text}</th>`;
        });
        html += '</tr>';
    }
    
    html += '</thead>';
    return html;
}

// Table 바디 생성
function generateTableBody(config) {
    let html = '<tbody>';
    
    mockStudents.forEach((student, index) => {
        html += '<tr>';
        
        // 기본 학생 정보 컬럼들
        html += generateStudentInfoCells(student, index + 1);
        
        // 측정 데이터 입력 컬럼들
        html += generateMeasurementCells(student, config);
        
        // 계산된 결과 컬럼들 (점수, 등급)
        html += generateCalculatedCells(student);
        
        html += '</tr>';
    });
    
    html += '</tbody>';
    return html;
}

// 학생 정보 셀 생성 (순번, 번호, 성명, 성별)
function generateStudentInfoCells(student, rowNumber) {
    return `
        <td class="student-info">${rowNumber}</td>
        <td class="student-info">${student.number}</td>
        <td class="student-info">${student.name}</td>
        <td class="student-info">${student.gender === 'M' ? '남' : '여'}</td>
    `;
}

// 측정 데이터 입력 셀 생성
function generateMeasurementCells(student, config) {
    let html = '';
    const studentData = appState.studentsData[student.id][appState.activeActivity] || {};
    
    // 각 탭별로 다른 입력 필드 구조
    switch(appState.activeTab) {
        case 'cardio':
            html += generateCardioInputCells(student, studentData);
            break;
        case 'flexibility':
            html += generateFlexibilityInputCells(student, studentData);
            break;
        case 'strength':
            html += generateStrengthInputCells(student, studentData);
            break;
        case 'agility':
            html += generateAgilityInputCells(student, studentData);
            break;
        case 'bodyfat':
            html += generateBodyfatInputCells(student, studentData);
            break;
    }
    
    return html;
}

// 심폐지구력 입력 셀
function generateCardioInputCells(student, data) {
    return `
        <td>${createTableInput('shuttles', data.shuttles || '', 'number', '0', '150', student.id)}</td>
        <td>${createTableInput('longrun', data.longrun || '', 'text', '', '', student.id, '분.초')}</td>
        <td>${createTableInput('pulse', data.pulse || '', 'text', '', '', student.id)}</td>
        <td>${createTableInput('hr1', data.hr1 || '', 'number', '60', '200', student.id)}</td>
        <td>${createTableInput('hr2', data.hr2 || '', 'number', '60', '200', student.id)}</td>
        <td>${createTableInput('hr3', data.hr3 || '', 'number', '60', '200', student.id)}</td>
        <td class="calculated-field">${data.pei || '-'}</td>
    `;
}

// 유연성 입력 셀
function generateFlexibilityInputCells(student, data) {
    return `
        <td>${createTableInput('first', data.first || '', 'number', '-40', '50', student.id, 'step="0.1"')}</td>
        <td>${createTableInput('second', data.second || '', 'number', '-40', '50', student.id, 'step="0.1"')}</td>
        <td class="calculated-field">${data.max || '-'}</td>
        <td>${createTableCheckbox('shoulder_left', data.shoulder_left, student.id)}</td>
        <td>${createTableCheckbox('shoulder_right', data.shoulder_right, student.id)}</td>
        <td>${createTableCheckbox('trunk_left', data.trunk_left, student.id)}</td>
        <td>${createTableCheckbox('trunk_right', data.trunk_right, student.id)}</td>
        <td>${createTableCheckbox('side_left', data.side_left, student.id)}</td>
        <td>${createTableCheckbox('side_right', data.side_right, student.id)}</td>
        <td>${createTableCheckbox('lower_left', data.lower_left, student.id)}</td>
        <td>${createTableCheckbox('lower_right', data.lower_right, student.id)}</td>
        <td class="calculated-field">${data.flexibility_total || '-'}</td>
    `;
}

// 근력/근지구력 입력 셀
function generateStrengthInputCells(student, data) {
    return `
        <td>${createTableInput('pushup', data.pushup || '', 'number', '0', '200', student.id)}</td>
        <td>${createTableInput('situp', data.situp || '', 'number', '0', '200', student.id)}</td>
        <td>${createTableInput('right1', data.right1 || '', 'number', '0', '80', student.id, 'step="0.1"')}</td>
        <td>${createTableInput('left1', data.left1 || '', 'number', '0', '80', student.id, 'step="0.1"')}</td>
        <td>${createTableInput('right2', data.right2 || '', 'number', '0', '80', student.id, 'step="0.1"')}</td>
        <td>${createTableInput('left2', data.left2 || '', 'number', '0', '80', student.id, 'step="0.1"')}</td>
        <td class="calculated-field">${data.max || '-'}</td>
    `;
}

// 순발력 입력 셀
function generateAgilityInputCells(student, data) {
    return `
        <td>${createTableInput('sprint50', data.sprint50 || '', 'number', '0', '30', student.id, 'step="0.01"')}</td>
        <td>${createTableInput('first', data.first || '', 'number', '0', '400', student.id)}</td>
        <td>${createTableInput('second', data.second || '', 'number', '0', '400', student.id)}</td>
        <td class="calculated-field">${data.max || '-'}</td>
    `;
}

// 비만 입력 셀
function generateBodyfatInputCells(student, data) {
    return `
        <td>${createTableInput('height', data.height || '', 'number', '100', '300', student.id, 'step="0.1"')}</td>
        <td>${createTableInput('weight', data.weight || '', 'number', '20', '200', student.id, 'step="0.1"')}</td>
        <td class="calculated-field">${data.bmi || '-'}</td>
    `;
}

// 계산된 결과 셀 생성 (점수, 등급)
function generateCalculatedCells(student) {
    const studentData = appState.studentsData[student.id][appState.activeActivity] || {};
    const grade = getRandomGrade();
    const score = Math.floor(Math.random() * 20) + 1;
    
    return `
        <td class="calculated-field">${score}</td>
        <td class="calculated-field table-grade-${grade}">${grade}등급</td>
    `;
}

// Table 입력 필드 생성 헬퍼
function createTableInput(fieldName, value, type, min, max, studentId, extra = '') {
    const minAttr = min ? ` min="${min}"` : '';
    const maxAttr = max ? ` max="${max}"` : '';
    const placeholder = type === 'text' ? (fieldName === 'longrun' ? '예: 5.30' : '') : '';
    
    return `
        <input 
            type="${type}" 
            value="${value}"
            ${minAttr}
            ${maxAttr}
            ${extra}
            placeholder="${placeholder}"
            data-student-id="${studentId}"
            data-field="${fieldName}"
            onchange="handleTableFieldChange(this)"
            oninput="handleTableFieldInput(this)"
        >
    `;
}

// Table 체크박스 생성 헬퍼 (종합유연성용)
function createTableCheckbox(fieldName, checked, studentId) {
    return `
        <input 
            type="checkbox" 
            ${checked ? 'checked' : ''}
            data-student-id="${studentId}"
            data-field="${fieldName}"
            onchange="handleTableFieldChange(this)"
        >
    `;
}

// Table 이벤트 리스너 설정
function setupTableEventListeners() {
    // 키보드 네비게이션은 나중에 추가
    console.log('Table 이벤트 리스너 설정 완료');
}

// Table 입력 필드 변경 처리
function handleTableFieldChange(input) {
    const studentId = parseInt(input.dataset.studentId);
    const fieldName = input.dataset.field;
    const value = input.type === 'checkbox' ? input.checked : input.value;
    
    // 데이터 저장
    if (!appState.studentsData[studentId][appState.activeActivity]) {
        appState.studentsData[studentId][appState.activeActivity] = {};
    }
    appState.studentsData[studentId][appState.activeActivity][fieldName] = value;
    
    // 자동 계산 처리
    performTableAutoCalculation(studentId);
    
    // 더티 플래그 설정
    appState.isDirty = true;
    
    console.log('Table 필드 변경:', studentId, fieldName, value);
}

// Table 실시간 입력 처리
function handleTableFieldInput(input) {
    const studentId = parseInt(input.dataset.studentId);
    performTableAutoCalculation(studentId);
}

// Table 자동 계산 수행
function performTableAutoCalculation(studentId) {
    const studentData = appState.studentsData[studentId][appState.activeActivity] || {};
    
    // 활동별 자동 계산 로직
    switch(appState.activeActivity) {
        case 'shuttle':
            // PEI 계산 (스텝검사)
            const hr1 = parseFloat(studentData.hr1) || 0;
            const hr2 = parseFloat(studentData.hr2) || 0;
            const hr3 = parseFloat(studentData.hr3) || 0;
            if (hr1 > 0 && hr2 > 0 && hr3 > 0) {
                const pei = calculatePEI(hr1, hr2, hr3);
                studentData.pei = pei;
                updateTableCalculatedField(studentId, 'pei', pei);
            }
            break;
            
        case 'sitreach':
            // 앉아윗몸앞으로굽히기 최댓값 계산
            const first = parseFloat(studentData.first) || 0;
            const second = parseFloat(studentData.second) || 0;
            if (first > 0 || second > 0) {
                const max = Math.max(first, second);
                studentData.max = max;
                updateTableCalculatedField(studentId, 'max', max);
            }
            
            // 종합유연성평가 총점 계산 (8개 체크박스의 합)
            const flexibilityItems = [
                'shoulder_left', 'shoulder_right', 'trunk_left', 'trunk_right',
                'side_left', 'side_right', 'lower_left', 'lower_right'
            ];
            let flexibilityTotal = 0;
            flexibilityItems.forEach(item => {
                if (studentData[item]) flexibilityTotal++;
            });
            studentData.flexibility_total = flexibilityTotal;
            updateTableCalculatedField(studentId, 'flexibility_total', flexibilityTotal);
            break;
            
        case 'longjump':
            // 제자리멀리뛰기 최댓값 계산
            const jumpFirst = parseFloat(studentData.first) || 0;
            const jumpSecond = parseFloat(studentData.second) || 0;
            if (jumpFirst > 0 || jumpSecond > 0) {
                const jumpMax = Math.max(jumpFirst, jumpSecond);
                studentData.max = jumpMax;
                updateTableCalculatedField(studentId, 'max', jumpMax);
            }
            break;
            
        case 'grip':
            // 악력 최댓값 계산
            const right1 = parseFloat(studentData.right1) || 0;
            const left1 = parseFloat(studentData.left1) || 0;
            const right2 = parseFloat(studentData.right2) || 0;
            const left2 = parseFloat(studentData.left2) || 0;
            if (right1 > 0 || left1 > 0 || right2 > 0 || left2 > 0) {
                const max = Math.max(right1, left1, right2, left2);
                studentData.max = max;
                updateTableCalculatedField(studentId, 'max', max.toFixed(1));
            }
            break;
            
        case 'bmi':
            // BMI 계산
            const height = parseFloat(studentData.height) || 0;
            const weight = parseFloat(studentData.weight) || 0;
            if (height > 0 && weight > 0) {
                const bmi = (weight / Math.pow(height / 100, 2)).toFixed(1);
                studentData.bmi = bmi;
                updateTableCalculatedField(studentId, 'bmi', bmi);
            }
            break;
    }
}

// PEI 계산 함수 (더미 구현)
function calculatePEI(hr1, hr2, hr3, duration = 300) {
    // 실제 PEI 계산 공식: duration * 100 / (2 * (hr1 + hr2 + hr3))
    // 단순화된 더미 계산
    const avgHR = (hr1 + hr2 + hr3) / 3;
    const pei = Math.round((duration * 100) / (2 * (hr1 + hr2 + hr3)));
    return Math.max(0, Math.min(150, pei)); // 0-150 범위로 제한
}

// Table 계산된 필드 업데이트
function updateTableCalculatedField(studentId, fieldName, value) {
    // Table 내의 계산된 필드 찾아서 업데이트
    const row = document.querySelector(`input[data-student-id="${studentId}"]`)?.closest('tr');
    if (row) {
        const calculatedCells = row.querySelectorAll('.calculated-field');
        
        // 필드명과 활동에 따라 적절한 셀 찾아서 업데이트
        let targetIndex = -1;
        
        switch(appState.activeActivity) {
            case 'shuttle':
                if (fieldName === 'pei') targetIndex = 0; // PEI 필드
                break;
            case 'sitreach':
                if (fieldName === 'max') targetIndex = 0; // 앉아윗몸앞으로굽히기 평가값
                if (fieldName === 'flexibility_total') targetIndex = 1; // 종합유연성평가 평가값
                break;
            case 'longjump':
                if (fieldName === 'max') targetIndex = 0; // 제자리멀리뛰기 평가값
                break;
            case 'grip':
                if (fieldName === 'max') targetIndex = 0; // 악력 평가값 필드
                break;
            case 'bmi':
                if (fieldName === 'bmi') targetIndex = 0; // BMI 필드
                break;
        }
        
        if (targetIndex >= 0 && calculatedCells[targetIndex]) {
            calculatedCells[targetIndex].textContent = value;
        }
    }
}

// 학생 카드 렌더링 (모바일용 - 기존 함수 유지)
function renderStudentCards(activity) {
    const container = elements.studentsContainer;
    container.innerHTML = '';
    
    mockStudents.forEach(student => {
        const card = createStudentCard(student, activity);
        container.appendChild(card);
    });
}

// 개별 학생 카드 생성
function createStudentCard(student, activity) {
    const card = document.createElement('div');
    card.className = 'student-card bg-gray-50 border border-gray-200 rounded-lg p-4';
    
    // 학생 정보와 입력 상태
    const studentData = appState.studentsData[student.id][appState.activeActivity] || {};
    const hasData = Object.keys(studentData).length > 0;
    const statusText = hasData ? '입력완료' : '미입력';
    const statusColor = hasData ? 'text-green-600' : 'text-gray-500';
    
    card.innerHTML = `
        <div class="flex justify-between items-center mb-3">
            <div class="font-medium text-gray-900">
                ${student.number}번 ${student.name} <span class="text-sm text-gray-500">(${student.gender === 'M' ? '남' : '여'})</span>
            </div>
            <div class="text-sm ${statusColor}">
                <i class="fas ${hasData ? 'fa-check-circle' : 'fa-circle'} mr-1"></i>
                ${statusText}
            </div>
        </div>
        
        <!-- 입력 필드들 -->
        <div class="space-y-3 measurement-fields">
            ${activity.fields.map(field => createInputField(student, field, studentData)).join('')}
        </div>
        
        <!-- 자동 계산 결과 표시 -->
        <div class="mt-4 pt-3 border-t border-gray-200 text-sm">
            <div class="grid grid-cols-2 gap-2">
                <div class="flex justify-between">
                    <span class="text-gray-600">남학생 등급:</span>
                    <span class="font-medium grade-${getRandomGrade()}" id="male-grade-${student.id}">
                        ${hasData ? getRandomGrade() + '등급' : '-'}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">여학생 등급:</span>
                    <span class="font-medium grade-${getRandomGrade()}" id="female-grade-${student.id}">
                        ${hasData ? getRandomGrade() + '등급' : '-'}
                    </span>
                </div>
            </div>
        </div>
    `;
    
    return card;
}

// 입력 필드 생성
function createInputField(student, field, studentData) {
    const value = studentData[field.name] || '';
    const isReadonly = field.readonly ? 'readonly' : '';
    const isCalculated = field.calculated ? 'bg-gray-100' : 'bg-white';
    const step = field.step ? `step="${field.step}"` : '';
    const min = field.min !== undefined ? `min="${field.min}"` : '';
    const max = field.max !== undefined ? `max="${field.max}"` : '';
    
    return `
        <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-700 w-16 flex-shrink-0">${field.label}</label>
            <input 
                type="${field.type}" 
                class="measurement-input flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${isCalculated}"
                placeholder="${field.placeholder || ''}"
                value="${value}"
                ${isReadonly}
                ${step}
                ${min}
                ${max}
                data-student-id="${student.id}"
                data-field-name="${field.name}"
                onchange="handleFieldChange(this)"
                oninput="handleFieldInput(this)"
            >
            <span class="text-xs text-gray-500 w-8 flex-shrink-0">${field.unit}</span>
        </div>
    `;
}

// 입력 필드 변경 처리
function handleFieldChange(input) {
    const studentId = parseInt(input.dataset.studentId);
    const fieldName = input.dataset.fieldName;
    const value = input.value;
    
    // 데이터 저장
    if (!appState.studentsData[studentId][appState.activeActivity]) {
        appState.studentsData[studentId][appState.activeActivity] = {};
    }
    appState.studentsData[studentId][appState.activeActivity][fieldName] = value;
    
    // 자동 계산 처리
    performAutoCalculation(studentId);
    
    // 더티 플래그 설정
    appState.isDirty = true;
    
    console.log('필드 변경:', studentId, fieldName, value);
}

// 실시간 입력 처리
function handleFieldInput(input) {
    // 실시간 자동 계산 (예: BMI)
    const studentId = parseInt(input.dataset.studentId);
    performAutoCalculation(studentId);
}

// 자동 계산 수행
function performAutoCalculation(studentId) {
    const studentData = appState.studentsData[studentId][appState.activeActivity] || {};
    const activity = requiredCategories[appState.activeTab].activities[appState.activeActivity];
    
    // 활동별 자동 계산 로직
    switch(appState.activeActivity) {
        case 'sitreach':
        case 'longjump':
            // 최댓값 계산
            const first = parseFloat(studentData.first) || 0;
            const second = parseFloat(studentData.second) || 0;
            const max = Math.max(first, second);
            if (first > 0 || second > 0) {
                studentData.max = max;
                updateCalculatedField(studentId, 'max', max);
            }
            break;
            
        case 'grip':
            // 악력 최댓값 계산
            const left1 = parseFloat(studentData.left1) || 0;
            const left2 = parseFloat(studentData.left2) || 0;
            const right1 = parseFloat(studentData.right1) || 0;
            const right2 = parseFloat(studentData.right2) || 0;
            const gripMax = Math.max(left1, left2, right1, right2);
            if (left1 > 0 || left2 > 0 || right1 > 0 || right2 > 0) {
                studentData.max = gripMax;
                updateCalculatedField(studentId, 'max', gripMax);
            }
            break;
            
        case 'bmi':
            // BMI 계산
            const height = parseFloat(studentData.height) || 0;
            const weight = parseFloat(studentData.weight) || 0;
            if (height > 0 && weight > 0) {
                const bmi = (weight / Math.pow(height / 100, 2)).toFixed(1);
                studentData.bmi = bmi;
                updateCalculatedField(studentId, 'bmi', bmi);
            }
            break;
    }
    
    // 등급 업데이트 (더미)
    updateGradeDisplay(studentId);
}

// 계산된 필드 업데이트
function updateCalculatedField(studentId, fieldName, value) {
    const input = document.querySelector(`input[data-student-id="${studentId}"][data-field-name="${fieldName}"]`);
    if (input) {
        input.value = value;
    }
}

// 등급 표시 업데이트
function updateGradeDisplay(studentId) {
    const maleGradeEl = document.getElementById(`male-grade-${studentId}`);
    const femaleGradeEl = document.getElementById(`female-grade-${studentId}`);
    
    if (maleGradeEl && femaleGradeEl) {
        const maleGrade = getRandomGrade();
        const femaleGrade = getRandomGrade();
        
        maleGradeEl.textContent = maleGrade + '등급';
        maleGradeEl.className = `font-medium grade-${maleGrade}`;
        
        femaleGradeEl.textContent = femaleGrade + '등급';
        femaleGradeEl.className = `font-medium grade-${femaleGrade}`;
    }
}

// 랜덤 등급 생성 (더미)
function getRandomGrade() {
    return Math.floor(Math.random() * 5) + 1;
}

// 모두 저장 처리
function handleSaveAll() {
    showMessage('info', '데이터를 저장하는 중...');
    
    // 시뮬레이션: 1초 후 저장 완료
    setTimeout(() => {
        appState.isDirty = false;
        showMessage('success', '모든 데이터가 성공적으로 저장되었습니다.');
    }, 1000);
}

// 모두 지우기 처리
function handleClearAll() {
    if (confirm('현재 탭의 모든 입력 데이터를 지우시겠습니까?')) {
        // 현재 활동의 모든 데이터 지우기
        mockStudents.forEach(student => {
            if (appState.studentsData[student.id][appState.activeActivity]) {
                appState.studentsData[student.id][appState.activeActivity] = {};
            }
        });
        
        // 화면 다시 렌더링
        renderCurrentTab();
        
        appState.isDirty = true;
        showMessage('warning', '현재 탭의 모든 데이터가 지워졌습니다.');
    }
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', init);

// 페이지 이탈 시 경고
window.addEventListener('beforeunload', (e) => {
    if (appState.isDirty) {
        e.preventDefault();
        e.returnValue = '저장하지 않은 변경사항이 있습니다. 정말 페이지를 떠나시겠습니까?';
    }
});

console.log('PAPS 필수평가 입력 페이지 스크립트 로드 완료');
</script>
{% endblock %}