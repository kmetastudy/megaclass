<!-- 왕복오래달리기 측정 화면 -->
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-sm border border-gray-200">
    <header class="bg-teal-600 text-white p-4 text-center rounded-t-lg">
        <h1 class="text-2xl font-bold">PAPS - {{ activity.get_name_display }}</h1>
        <p class="text-sm mt-1">{{ class_info.grade }}학년 {{ class_info.class_number }}반</p>
    </header>

    <div class="p-6">
        <!-- 측정 정보 표시 -->
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="text-blue-800 font-medium">학년도:</span>
                    <span class="text-blue-900">{{ school_year }}년도</span>
                </div>
                <div>
                    <span class="text-blue-800 font-medium">측정회차:</span>
                    <span class="text-blue-900">{{ session.name }}</span>
                </div>
                <div>
                    <span class="text-blue-800 font-medium">전체 학생:</span>
                    <span class="text-blue-900">{{ total_students }}명</span>
                </div>
                <div>
                    <span class="text-blue-800 font-medium">측정 완료:</span>
                    <span id="measured-count" class="text-blue-900">{{ measured_students }}명</span>
                </div>
            </div>
        </div>

        <!-- 모드 전환 버튼 -->
        <div class="mb-6 flex justify-center space-x-4">
            <button id="individual-mode-btn" class="px-6 py-3 bg-teal-500 text-white font-bold rounded-lg hover:bg-teal-600 transition duration-300 shadow-md">
                개별 입력 모드
            </button>
            <button id="live-mode-btn" class="px-6 py-3 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition duration-300 shadow-md">
                실시간 측정 모드
            </button>
        </div>

        <!-- 개별 입력 모드 -->
        <div id="individual-mode" class="mb-6">
            <h2 class="text-lg font-semibold mb-4 text-gray-700 border-b pb-2">학생별 기록 입력</h2>
            
            <!-- 목록 헤더 -->
            <div class="grid grid-cols-4 items-center gap-2 px-3 py-2 bg-gray-100 rounded-t-lg border-b">
                <span class="font-semibold text-gray-600">이름</span>
                <span class="font-semibold text-gray-600 text-center">기록 (회)</span>
                <span class="font-semibold text-gray-600 text-center">등급</span>
                <span class="font-semibold text-gray-600 text-center">관리</span>
            </div>

            <!-- 학생 목록 -->
            <div id="student-list-container" class="border border-t-0 rounded-b-lg">
                {% for student in students %}
                <div class="grid grid-cols-4 items-center gap-2 p-3 {% if forloop.counter0|divisibleby:2 %}bg-white{% else %}bg-gray-50{% endif %}" data-student-id="{{ student.id }}" data-student-gender="{{ student.gender }}" data-student-grade="{{ grade }}">
                    <!-- 학생 이름 -->
                    <span class="font-medium truncate">{{ student.name }}</span>
                    
                    <!-- 기록 표시/입력 -->
                    <div class="text-center">
                        {% if student.record %}
                            <span class="text-lg text-teal-600 font-bold measurement-display">
                                {{ student.measurement_data.shuttle_run|default:"미측정" }} 회
                            </span>
                            <input type="number" class="w-full p-2 border border-teal-500 rounded-md text-center shadow-sm focus:ring-teal-500 focus:border-teal-500 measurement-input hidden" 
                                   value="{{ student.measurement_data.shuttle_run|default:"" }}" 
                                   min="0" max="150" data-field="shuttle_run">
                        {% else %}
                            <span class="text-lg text-gray-500 measurement-display">미측정</span>
                            <input type="number" class="w-full p-2 border border-teal-500 rounded-md text-center shadow-sm focus:ring-teal-500 focus:border-teal-500 measurement-input hidden" 
                                   value="" min="0" max="150" data-field="shuttle_run">
                        {% endif %}
                    </div>
                    
                    <!-- 등급 표시 -->
                    <div class="text-center">
                        <span class="grade-display text-sm px-2 py-1 rounded-md
                            {% if student.evaluation_grade == '1등급' %}bg-red-100 text-red-800
                            {% elif student.evaluation_grade == '2등급' %}bg-orange-100 text-orange-800
                            {% elif student.evaluation_grade == '3등급' %}bg-yellow-100 text-yellow-800
                            {% elif student.evaluation_grade == '4등급' %}bg-green-100 text-green-800
                            {% elif student.evaluation_grade == '5등급' %}bg-blue-100 text-blue-800
                            {% else %}bg-gray-100 text-gray-600{% endif %}">
                            {{ student.evaluation_grade|default:"미평가" }}
                        </span>
                    </div>
                    
                    <!-- 관리 버튼 -->
                    <div class="text-center">
                        <button class="edit-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition text-sm">
                            {% if student.record %}수정{% else %}입력{% endif %}
                        </button>
                        <button class="save-btn bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition text-sm hidden">
                            저장
                        </button>
                        <button class="cancel-btn bg-gray-400 hover:bg-gray-500 text-white font-bold py-1 px-2 rounded transition text-xs ml-1 hidden">
                            취소
                        </button>
                    </div>
                </div>
                {% empty %}
                <div class="p-6 text-center text-gray-500">
                    학생 목록이 없습니다.
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 실시간 측정 모드 -->
        <div id="live-mode" class="hidden">
            <!-- 측정 설정 -->
            <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">측정 설정</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- 측정 인원 선택 -->
                    <div>
                        <label for="participant-count" class="block text-sm font-medium text-gray-700 mb-2">측정 인원</label>
                        <select id="participant-count" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                            <option value="">인원 선택</option>
                            {% for i in "123456789"|make_list %}
                                <option value="{{ forloop.counter }}">{{ forloop.counter }}명</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- 측정 시작 버튼 -->
                    <div class="flex items-end">
                        <button id="start-measurement-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            측정 시작
                        </button>
                    </div>
                </div>
                
                <!-- 학생 선택 -->
                <div id="student-selectors-container" class="mt-4 space-y-3 hidden">
                    <!-- 동적으로 생성됨 -->
                </div>
            </div>

            <!-- 실시간 측정 진행 화면 -->
            <div id="measurement-progress" class="hidden">
                <!-- 현재 횟수 표시 -->
                <div class="text-center mb-6 p-6 bg-gray-50 rounded-lg">
                    <p class="text-lg text-gray-600 mb-2">현재 횟수</p>
                    <p id="current-count" class="text-6xl font-bold text-red-500">0</p>
                </div>

                <!-- 측정 중인 학생 카드 -->
                <div id="participants-container" class="space-y-3 mb-6">
                    <!-- 동적으로 생성됨 -->
                </div>

                <!-- 컨트롤 버튼 -->
                <div class="flex justify-center">
                    <button id="increment-btn" class="w-full bg-red-500 hover:bg-red-600 text-white text-2xl font-bold py-8 rounded-lg transition duration-300">
                        +1 회
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- 저장 확인 모달 -->
<div id="save-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
        <h2 class="text-xl font-bold mb-2">측정 완료</h2>
        <p class="text-gray-600 mb-4">측정된 기록을 저장하시겠습니까?</p>
        <div id="modal-results-summary" class="text-left bg-gray-50 p-3 rounded-md mb-6 space-y-1">
            <!-- 측정 결과 요약이 동적으로 추가됨 -->
        </div>
        <div class="flex gap-4">
            <button id="cancel-save-btn" class="w-1/2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition">취소</button>
            <button id="confirm-save-btn" class="w-1/2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">저장</button>
        </div>
    </div>
</div>

<!-- 저장 완료 토스트 -->
<div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

<script>
(function() {
    // DOM 요소 참조
    const individualModeBtn = document.getElementById('individual-mode-btn');
    const liveModeBtn = document.getElementById('live-mode-btn');
    const individualMode = document.getElementById('individual-mode');
    const liveMode = document.getElementById('live-mode');
    const studentContainer = document.getElementById('student-list-container');
    const toastContainer = document.getElementById('toast-container');
    
    // DOM 요소 체크
    if (!individualModeBtn) {
        console.error('PAPS shuttle_run template not properly loaded');
        return;
    }
    
    // 실시간 측정 관련 요소
    const participantCountSelect = document.getElementById('participant-count');
    const studentSelectorsContainer = document.getElementById('student-selectors-container');
    const startMeasurementBtn = document.getElementById('start-measurement-btn');
    const measurementProgress = document.getElementById('measurement-progress');
    const currentCountDisplay = document.getElementById('current-count');
    const participantsContainer = document.getElementById('participants-container');
    const incrementBtn = document.getElementById('increment-btn');
    const saveModal = document.getElementById('save-modal');
    const modalResultsSummary = document.getElementById('modal-results-summary');
    
    // 측정 데이터 (Django 컨텍스트에서 전달)
    const measurementData = {
        sessionId: '{{ session_id }}',
        activityId: '{{ activity_id }}',
        schoolYear: {{ school_year }},
        grade: {{ grade }},
        classId: {{ class_id }},
        csrfToken: '{{ csrf_token }}'
    };
    
    // 학생 데이터
    const studentsData = {{ students_json|safe }};
    
    // 평가 기준 데이터
    const evaluationCriteria = {{ evaluation_criteria_json|safe }};
    
    // 실시간 측정 상태
    let liveMeasurementState = {
        participants: [],
        currentCount: 0,
        isActive: false
    };
    
    // 마지막 측정 상태 기억
    let lastMeasurementSetup = null;

    // 초기화
    init();

    function init() {
        // 기본적으로 개별 입력 모드로 시작
        showIndividualMode();
        
        // 이벤트 리스너 등록
        setupEventListeners();
    }

    function setupEventListeners() {
        // 모드 전환 버튼
        individualModeBtn.addEventListener('click', showIndividualMode);
        liveModeBtn.addEventListener('click', showLiveMode);
        
        // 개별 입력 모드 이벤트
        studentContainer.addEventListener('click', handleStudentContainerClick);
        studentContainer.addEventListener('keydown', handleStudentContainerKeydown);
        
        // 실시간 측정 모드 이벤트
        participantCountSelect.addEventListener('change', handleParticipantCountChange);
        startMeasurementBtn.addEventListener('click', startLiveMeasurement);
        incrementBtn.addEventListener('click', incrementCount);
        
        // 모달 이벤트
        document.getElementById('cancel-save-btn').addEventListener('click', closeSaveModal);
        document.getElementById('confirm-save-btn').addEventListener('click', confirmSave);
    }

    // 모드 전환 함수
    function showIndividualMode() {
        individualModeBtn.classList.add('bg-teal-500', 'hover:bg-teal-600');
        individualModeBtn.classList.remove('bg-gray-300', 'hover:bg-gray-400');
        liveModeBtn.classList.add('bg-gray-300', 'hover:bg-gray-400');
        liveModeBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
        
        individualMode.classList.remove('hidden');
        liveMode.classList.add('hidden');
    }

    function showLiveMode() {
        liveModeBtn.classList.add('bg-red-500', 'hover:bg-red-600');
        liveModeBtn.classList.remove('bg-gray-300', 'hover:bg-gray-400');
        individualModeBtn.classList.add('bg-gray-300', 'hover:bg-gray-400');
        individualModeBtn.classList.remove('bg-teal-500', 'hover:bg-teal-600');
        
        liveMode.classList.remove('hidden');
        individualMode.classList.add('hidden');
        
        // 실시간 측정 초기화 및 마지막 설정 복원
        resetLiveMeasurement();
        
        // 마지막 측정 설정 복원
        if (lastMeasurementSetup) {
            participantCountSelect.value = lastMeasurementSetup.count;
            renderStudentSelectors(lastMeasurementSetup.count);
            
            // 이전에 선택한 학생들 자동 선택
            const selectors = studentSelectorsContainer.querySelectorAll('.student-selector');
            lastMeasurementSetup.selectedIds.forEach((id, index) => {
                if (selectors[index]) {
                    selectors[index].value = id;
                    selectors[index].dispatchEvent(new Event('change'));
                }
            });
        }
    }

    // 토스트 메시지 표시
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `px-4 py-2 rounded-lg text-white text-sm mb-2 transform transition-all duration-300 translate-x-full ${
            type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        toast.textContent = message;
        
        toastContainer.appendChild(toast);
        
        // 애니메이션
        setTimeout(() => toast.classList.remove('translate-x-full'), 100);
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                if (toastContainer.contains(toast)) {
                    toastContainer.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }

    // 학년 형식 변환 함수
    function convertGradeFormat(gradeNum) {
        const num = parseInt(gradeNum);
        if (num >= 4 && num <= 6) return `초${num}`;
        else if (num >= 7 && num <= 9) return `중${num - 6}`;
        else if (num >= 10 && num <= 12) return `고${num - 9}`;
        return null;
    }

    // 등급 계산 함수
    function calculateGrade(shuttleRuns, gender, grade) {
        if (!evaluationCriteria || !evaluationCriteria.criteria) {
            return null;
        }
        
        const criteria = evaluationCriteria.criteria[gender];
        if (!criteria) return null;
        
        const gradeCriteria = criteria[grade];
        if (!gradeCriteria) return null;
        
        // 등급별로 확인 (1등급부터 5등급까지)
        for (let i = 1; i <= 5; i++) {
            const gradeKey = `grade_${i}`;
            const range = gradeCriteria[gradeKey];
            if (range && shuttleRuns >= range.min && shuttleRuns <= range.max) {
                return `${i}등급`;
            }
        }
        
        return null;
    }

    // 등급 표시 업데이트
    function updateGradeDisplay(studentElement, shuttleRuns) {
        const gender = studentElement.dataset.studentGender;
        const grade = convertGradeFormat(studentElement.dataset.studentGrade);
        
        if (!grade) {
            console.error('Invalid grade format:', studentElement.dataset.studentGrade);
            return;
        }
        
        const gradeResult = calculateGrade(shuttleRuns, gender, grade);
        const gradeDisplay = studentElement.querySelector('.grade-display');
        
        if (gradeResult) {
            gradeDisplay.textContent = gradeResult;
            
            // 등급별 색상 적용
            gradeDisplay.className = 'grade-display text-sm px-2 py-1 rounded-md ';
            switch(gradeResult) {
                case '1등급': gradeDisplay.className += 'bg-red-100 text-red-800'; break;
                case '2등급': gradeDisplay.className += 'bg-orange-100 text-orange-800'; break;
                case '3등급': gradeDisplay.className += 'bg-yellow-100 text-yellow-800'; break;
                case '4등급': gradeDisplay.className += 'bg-green-100 text-green-800'; break;
                case '5등급': gradeDisplay.className += 'bg-blue-100 text-blue-800'; break;
                default: gradeDisplay.className += 'bg-gray-100 text-gray-600';
            }
        } else {
            gradeDisplay.textContent = '미평가';
            gradeDisplay.className = 'grade-display text-sm px-2 py-1 rounded-md bg-gray-100 text-gray-600';
        }
    }

    // 개별 학생 기록 저장
    async function saveStudentRecord(studentElement, studentId) {
        const input = studentElement.querySelector('.measurement-input');
        const value = input.value;
        
        if (!value || value === '') {
            showToast('기록을 입력해주세요.', 'error');
            return false;
        }

        const measurementValue = parseInt(value);
        if (isNaN(measurementValue) || measurementValue < 0 || measurementValue > 150) {
            showToast('올바른 기록을 입력해주세요. (0-150회)', 'error');
            return false;
        }

        try {
            const response = await fetch('/physical_education/api/paps/save-measurement/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': measurementData.csrfToken
                },
                body: JSON.stringify({
                    session_id: measurementData.sessionId,
                    student_id: studentId,
                    activity_id: measurementData.activityId,
                    measurement_data: {
                        shuttle_run: measurementValue
                    }
                })
            });

            const result = await response.json();
            
            if (result.success) {
                // UI 업데이트
                const display = studentElement.querySelector('.measurement-display');
                display.textContent = `${measurementValue} 회`;
                display.classList.remove('text-gray-500');
                display.classList.add('text-teal-600', 'font-bold');
                
                // 등급 표시 업데이트
                updateGradeDisplay(studentElement, measurementValue);
                
                // 버튼 텍스트 변경
                const editBtn = studentElement.querySelector('.edit-btn');
                editBtn.textContent = '수정';
                editBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                editBtn.classList.add('bg-yellow-400', 'hover:bg-yellow-500');
                
                // studentsData 업데이트
                const studentData = studentsData.find(s => s.id == studentId);
                if (studentData) {
                    if (!studentData.measurement_data) {
                        studentData.measurement_data = {};
                    }
                    studentData.measurement_data.shuttle_run = measurementValue;
                    studentData.record = true;
                }
                
                // 측정 완료 카운터 업데이트
                updateMeasuredCount();
                
                showToast(`${studentElement.querySelector('span').textContent} 학생 기록이 저장되었습니다.`);
                return true;
            } else {
                showToast(result.error || '저장에 실패했습니다.', 'error');
                return false;
            }
        } catch (error) {
            console.error('Save error:', error);
            showToast('저장 중 오류가 발생했습니다.', 'error');
            return false;
        }
    }

    // 편집 모드 전환
    function toggleEditMode(studentElement, isEditing) {
        const display = studentElement.querySelector('.measurement-display');
        const input = studentElement.querySelector('.measurement-input');
        const editBtn = studentElement.querySelector('.edit-btn');
        const saveBtn = studentElement.querySelector('.save-btn');
        const cancelBtn = studentElement.querySelector('.cancel-btn');

        if (isEditing) {
            display.classList.add('hidden');
            input.classList.remove('hidden');
            input.focus();
            input.select();
            
            editBtn.classList.add('hidden');
            saveBtn.classList.remove('hidden');
            cancelBtn.classList.remove('hidden');
        } else {
            display.classList.remove('hidden');
            input.classList.add('hidden');
            
            editBtn.classList.remove('hidden');
            saveBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
        }
    }

    // 개별 입력 모드 이벤트 처리
    async function handleStudentContainerClick(e) {
        const studentElement = e.target.closest('[data-student-id]');
        if (!studentElement) return;

        const studentId = studentElement.dataset.studentId;

        if (e.target.classList.contains('edit-btn')) {
            toggleEditMode(studentElement, true);
        } 
        else if (e.target.classList.contains('save-btn')) {
            const success = await saveStudentRecord(studentElement, studentId);
            if (success) {
                toggleEditMode(studentElement, false);
            }
        }
        else if (e.target.classList.contains('cancel-btn')) {
            // 원래 값으로 복원
            const input = studentElement.querySelector('.measurement-input');
            const originalValue = studentElement.querySelector('.measurement-display').textContent;
            if (originalValue !== '미측정') {
                input.value = originalValue.replace(' 회', '');
            } else {
                input.value = '';
            }
            toggleEditMode(studentElement, false);
        }
    }

    function handleStudentContainerKeydown(e) {
        if (e.key === 'Enter' && e.target.classList.contains('measurement-input')) {
            const studentElement = e.target.closest('[data-student-id]');
            const saveBtn = studentElement.querySelector('.save-btn');
            saveBtn.click();
        }
    }

    // 실시간 측정 관련 함수들
    function handleParticipantCountChange() {
        const count = parseInt(participantCountSelect.value);
        if (count > 0) {
            renderStudentSelectors(count);
            studentSelectorsContainer.classList.remove('hidden');
            updateStartButtonState();
        } else {
            studentSelectorsContainer.classList.add('hidden');
            startMeasurementBtn.disabled = true;
        }
    }
    
    // 학생 선택 중복 방지 함수
    function updateDuplicatePrevention() {
        const allSelectors = studentSelectorsContainer.querySelectorAll('.student-selector');
        const selectedValues = new Set();
        
        allSelectors.forEach(sel => {
            if (sel.value !== '') selectedValues.add(sel.value);
        });
        
        allSelectors.forEach(sel => {
            const currentValue = sel.value;
            Array.from(sel.options).forEach(opt => {
                opt.disabled = (opt.value !== '' && opt.value !== currentValue && selectedValues.has(opt.value));
            });
        });
    }

    function renderStudentSelectors(count) {
        studentSelectorsContainer.innerHTML = '';
        
        const titleLabel = document.createElement('label');
        titleLabel.className = 'block text-sm font-medium text-gray-700 mb-2';
        titleLabel.textContent = '측정 학생 선택';
        studentSelectorsContainer.appendChild(titleLabel);

        for (let i = 0; i < count; i++) {
            const selectorDiv = document.createElement('div');
            selectorDiv.className = 'grid grid-cols-3 items-center gap-2 bg-white p-3 rounded-lg border';

            const select = document.createElement('select');
            select.className = 'student-selector w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500';
            select.innerHTML = '<option value="">학생 선택</option>';
            
            // 미측정 학생 우선으로 옵션 추가
            studentsData.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name}${student.measurement_data.shuttle_run ? ` (기록: ${student.measurement_data.shuttle_run}회)` : ' (미측정)'}`;
                select.appendChild(option);
            });

            const statusSpan = document.createElement('span');
            statusSpan.className = 'text-center text-gray-500';
            statusSpan.textContent = '—';

            const removeBtn = document.createElement('button');
            removeBtn.className = 'text-red-500 hover:text-red-700 text-sm font-bold';
            removeBtn.textContent = '제거';
            removeBtn.onclick = () => {
                selectorDiv.remove();
                updateStartButtonState();
                updateDuplicatePrevention();
            };

            select.onchange = (e) => {
                if (e.target.value) {
                    const student = studentsData.find(s => s.id == e.target.value);
                    statusSpan.textContent = student.measurement_data.shuttle_run ? `기록: ${student.measurement_data.shuttle_run}회` : '미측정';
                    statusSpan.className = 'text-center text-sm ' + (student.measurement_data.shuttle_run ? 'text-teal-600 font-semibold' : 'text-gray-600');
                } else {
                    statusSpan.textContent = '—';
                    statusSpan.className = 'text-center text-gray-500';
                }
                updateStartButtonState();
                updateDuplicatePrevention();
            };

            selectorDiv.appendChild(select);
            selectorDiv.appendChild(statusSpan);
            selectorDiv.appendChild(removeBtn);
            studentSelectorsContainer.appendChild(selectorDiv);
        }
        
        // 초기 중복 방지 설정
        updateDuplicatePrevention();
    }

    function updateStartButtonState() {
        const selectors = studentSelectorsContainer.querySelectorAll('.student-selector');
        let allSelected = true;
        
        selectors.forEach(selector => {
            if (!selector.value) allSelected = false;
        });
        
        startMeasurementBtn.disabled = !allSelected;
    }

    function startLiveMeasurement() {
        const selectors = studentSelectorsContainer.querySelectorAll('.student-selector');
        const selectedStudents = [];
        
        selectors.forEach(selector => {
            if (selector.value) {
                const student = studentsData.find(s => s.id == selector.value);
                if (student) {
                    selectedStudents.push({
                        ...student,
                        finished: false,
                        currentRecord: 0
                    });
                }
            }
        });

        // 재측정 경고
        const studentsWithRecords = selectedStudents.filter(s => 
            s.measurement_data && s.measurement_data.shuttle_run
        );
        
        if (studentsWithRecords.length > 0) {
            const studentNames = studentsWithRecords.map(s => s.name).join(', ');
            if (!confirm(`다음 학생들은 이미 기록이 있습니다:\n${studentNames}\n\n계속 측정하시겠습니까?`)) {
                return;
            }
        }

        liveMeasurementState = {
            participants: selectedStudents,
            currentCount: 0,
            isActive: true
        };

        renderParticipantCards();
        measurementProgress.classList.remove('hidden');
        currentCountDisplay.textContent = '0';
        
        showToast('실시간 측정이 시작되었습니다!', 'info');
    }

    function renderParticipantCards() {
        participantsContainer.innerHTML = '';
        
        liveMeasurementState.participants.forEach(participant => {
            const card = document.createElement('div');
            card.className = 'p-4 bg-white rounded-lg shadow border flex items-center justify-between';
            card.id = `participant-${participant.id}`;
            
            const infoDiv = document.createElement('div');
            const nameP = document.createElement('p');
            nameP.className = 'text-lg font-bold';
            nameP.textContent = participant.name;
            
            const recordP = document.createElement('p');
            recordP.className = 'text-sm text-gray-600';
            recordP.id = `record-${participant.id}`;
            recordP.textContent = participant.finished ? `완료: ${participant.currentRecord}회` : '진행 중...';
            
            infoDiv.appendChild(nameP);
            infoDiv.appendChild(recordP);
            
            const finishBtn = document.createElement('button');
            finishBtn.className = `finish-btn px-4 py-2 rounded-lg font-bold text-white transition ${
                participant.finished ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600'
            }`;
            finishBtn.textContent = participant.finished ? '완료됨' : '완료';
            finishBtn.disabled = participant.finished;
            finishBtn.onclick = () => finishParticipant(participant.id);
            
            card.appendChild(infoDiv);
            card.appendChild(finishBtn);
            participantsContainer.appendChild(card);
        });
    }

    function incrementCount() {
        if (!liveMeasurementState.isActive) return;
        
        liveMeasurementState.currentCount++;
        currentCountDisplay.textContent = liveMeasurementState.currentCount;
        
        // 완료되지 않은 참가자들의 기록 업데이트
        liveMeasurementState.participants.forEach(participant => {
            if (!participant.finished) {
                participant.currentRecord = liveMeasurementState.currentCount;
            }
        });
    }

    function finishParticipant(studentId) {
        const participant = liveMeasurementState.participants.find(p => p.id == studentId);
        if (!participant || participant.finished) return;
        
        participant.finished = true;
        participant.currentRecord = liveMeasurementState.currentCount;
        
        // UI 업데이트
        const card = document.getElementById(`participant-${studentId}`);
        card.classList.add('bg-gray-50', 'opacity-75');
        
        const recordElement = document.getElementById(`record-${studentId}`);
        recordElement.textContent = `완료: ${participant.currentRecord}회`;
        recordElement.className = 'text-sm text-green-600 font-bold';
        
        const finishBtn = card.querySelector('.finish-btn');
        finishBtn.textContent = '완료됨';
        finishBtn.disabled = true;
        finishBtn.className = 'finish-btn px-4 py-2 rounded-lg font-bold text-white bg-gray-400 cursor-not-allowed';
        
        showToast(`${participant.name} 학생 측정 완료!`, 'success');
        
        // 모든 참가자가 완료되었는지 확인
        const allFinished = liveMeasurementState.participants.every(p => p.finished);
        if (allFinished) {
            showToast('모든 학생의 측정이 완료되었습니다!', 'success');
            // 0.5초 후 자동으로 저장 모달 표시
            setTimeout(() => {
                showSaveModal();
            }, 500);
        }
    }

    function showSaveModal() {
        modalResultsSummary.innerHTML = '';
        
        liveMeasurementState.participants.forEach(participant => {
            const resultItem = document.createElement('div');
            resultItem.className = 'flex justify-between items-center';
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = participant.name;
            
            const recordSpan = document.createElement('span');
            recordSpan.className = 'font-bold text-teal-600';
            recordSpan.textContent = `${participant.currentRecord}회`;
            
            resultItem.appendChild(nameSpan);
            resultItem.appendChild(recordSpan);
            modalResultsSummary.appendChild(resultItem);
        });
        
        saveModal.classList.remove('hidden');
    }

    function closeSaveModal() {
        saveModal.classList.add('hidden');
    }
    
    // 개별 학생의 DOM 행 업데이트 함수
    function updateStudentRow(studentId, shuttleRuns) {
        const studentElement = document.querySelector(`[data-student-id="${studentId}"]`);
        if (!studentElement) return;
        
        // 기록 표시 업데이트
        const display = studentElement.querySelector('.measurement-display');
        if (display) {
            display.textContent = `${shuttleRuns} 회`;
            display.classList.remove('text-gray-500');
            display.classList.add('text-teal-600', 'font-bold');
        }
        
        // 입력 필드 값 업데이트
        const input = studentElement.querySelector('.measurement-input');
        if (input) {
            input.value = shuttleRuns;
        }
        
        // 등급 업데이트
        updateGradeDisplay(studentElement, shuttleRuns);
        
        // 버튼 텍스트 및 스타일 변경
        const editBtn = studentElement.querySelector('.edit-btn');
        if (editBtn) {
            editBtn.textContent = '수정';
            // 기존 클래스 모두 제거하고 새로 설정
            editBtn.className = 'edit-btn bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg transition text-sm';
        }
    }
    
    // 측정 완료 카운터 업데이트 함수
    function updateMeasuredCount() {
        const measuredCount = studentsData.filter(s => s.measurement_data && s.measurement_data.shuttle_run).length;
        const measuredCountElement = document.getElementById('measured-count');
        if (measuredCountElement) {
            measuredCountElement.textContent = `${measuredCount}명`;
        }
    }

    async function confirmSave() {
        const savePromises = liveMeasurementState.participants.map(async (participant, index) => {
            try {
                const response = await fetch('/physical_education/api/paps/save-measurement/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': measurementData.csrfToken
                    },
                    body: JSON.stringify({
                        session_id: measurementData.sessionId,
                        student_id: participant.id,
                        activity_id: measurementData.activityId,
                        measurement_data: {
                            shuttle_run: participant.currentRecord
                        }
                    })
                });
                
                const result = await response.json();
                return { 
                    success: result.success, 
                    name: participant.name, 
                    error: result.error,
                    studentId: participant.id,
                    record: participant.currentRecord
                };
            } catch (error) {
                return { 
                    success: false, 
                    name: participant.name, 
                    error: '네트워크 오류',
                    studentId: participant.id,
                    record: participant.currentRecord
                };
            }
        });
        
        const results = await Promise.all(savePromises);
        const successCount = results.filter(r => r.success).length;
        const failedResults = results.filter(r => !r.success);
        
        // 성공한 저장에 대해 UI와 데이터 업데이트
        results.forEach(result => {
            if (result.success) {
                // studentsData 배열 업데이트
                const studentData = studentsData.find(s => s.id == result.studentId);
                if (studentData) {
                    if (!studentData.measurement_data) {
                        studentData.measurement_data = {};
                    }
                    studentData.measurement_data.shuttle_run = result.record;
                    studentData.record = true;
                }
                
                // DOM 요소 업데이트
                updateStudentRow(result.studentId, result.record);
            }
        });
        
        // 측정 완료 카운터 업데이트
        updateMeasuredCount();
        
        // 마지막 측정 상태 저장
        lastMeasurementSetup = {
            count: liveMeasurementState.participants.length,
            selectedIds: liveMeasurementState.participants.map(p => p.id)
        };
        
        if (successCount === results.length) {
            showToast(`모든 학생의 기록이 저장되었습니다! (${successCount}명)`, 'success');
        } else {
            showToast(`${successCount}명 저장, ${failedResults.length}명 실패`, 'error');
            failedResults.forEach(result => {
                showToast(`${result.name}: ${result.error}`, 'error');
            });
        }
        
        closeSaveModal();
        resetLiveMeasurement();
        
        // 개별 입력 모드로 전환하여 결과 확인 가능하도록
        showIndividualMode();
    }

    function resetLiveMeasurement() {
        liveMeasurementState = {
            participants: [],
            currentCount: 0,
            isActive: false
        };
        
        participantCountSelect.value = '';
        studentSelectorsContainer.classList.add('hidden');
        studentSelectorsContainer.innerHTML = '';
        measurementProgress.classList.add('hidden');
        startMeasurementBtn.disabled = true;
        currentCountDisplay.textContent = '0';
    }
})();
</script>