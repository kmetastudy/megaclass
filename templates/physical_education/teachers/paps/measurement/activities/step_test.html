<!-- 스텝검사 측정 화면 -->
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-sm border border-gray-200">
    <header class="bg-blue-600 text-white p-4 text-center rounded-t-lg">
        <h1 class="text-2xl font-bold">PAPS - {{ activity.get_name_display }}</h1>
        <p class="text-sm mt-1">{{ class_info.grade }}학년 {{ class_info.class_number }}반</p>
    </header>

    <div class="p-6">
        <!-- 측정 정보 표시 -->
        <div class="mb-6 p-4 bg-slate-50 border border-slate-200 rounded-lg">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="text-slate-800 font-medium">학년도:</span>
                    <span class="text-slate-900">{{ school_year }}년도</span>
                </div>
                <div>
                    <span class="text-slate-800 font-medium">측정회차:</span>
                    <span class="text-slate-900">{{ session.name }}</span>
                </div>
                <div>
                    <span class="text-slate-800 font-medium">전체 학생:</span>
                    <span class="text-slate-900">{{ total_students }}명</span>
                </div>
                <div>
                    <span class="text-slate-800 font-medium">측정 완료:</span>
                    <span id="measured-count" class="text-slate-900">{{ measured_students }}명</span>
                </div>
            </div>
        </div>

        <!-- 학생별 기록 입력 -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold mb-4 text-slate-700 border-b pb-2">학생별 기록 입력</h2>
            
            <div id="student-list-container" class="space-y-4">
                {% for student in students %}
                <div class="bg-slate-100 p-4 rounded-xl border border-slate-200 transition-shadow hover:shadow-md" data-student-id="{{ student.id }}">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-slate-800 text-lg">{{ student.name }}</p>
                            <p class="text-sm text-slate-500">{{ class_info.grade }}학년 {{ class_info.class_number }}반</p>
                        </div>
                        <div class="flex items-end space-x-3">
                            <!-- Individual palpation toggle -->
                            <div class="flex items-center mb-1">
                                <input type="checkbox" id="palpation-{{ student.id }}" 
                                       class="student-palpation-toggle hidden"
                                       data-original="{{ student.measurement_data.is_palpation|default:'false' }}"
                                       {% if student.measurement_data.is_palpation %}checked{% endif %}>
                                <label for="palpation-{{ student.id }}" class="mini-toggle-label">
                                    <span class="mini-toggle-text toggle-text-left">비촉진</span>
                                    <span class="mini-toggle-text toggle-text-right">촉진</span>
                                </label>
                            </div>
                            <!-- Heart rate dropdowns -->
                            <div class="flex items-end space-x-2 md:space-x-3">

                            <div class="text-center">
                                <label for="hr1-{{ student.id }}" class="text-xs font-medium text-slate-500 mb-1 block">1회</label>
                                <select id="hr1-{{ student.id }}" class="heart-rate-select w-16 md:w-20 bg-white border border-slate-300 rounded-md shadow-sm py-1.5 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" data-field="step_test_heart_rate_1" data-original="{{ student.measurement_data.step_test_heart_rate_1|default:"" }}">
                                    <option value="">--</option>
                                </select>
                            </div>
                            <div class="text-center">
                                <label for="hr2-{{ student.id }}" class="text-xs font-medium text-slate-500 mb-1 block">2회</label>
                                <select id="hr2-{{ student.id }}" class="heart-rate-select w-16 md:w-20 bg-white border border-slate-300 rounded-md shadow-sm py-1.5 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" data-field="step_test_heart_rate_2" data-original="{{ student.measurement_data.step_test_heart_rate_2|default:"" }}">
                                    <option value="">--</option>
                                </select>
                            </div>
                            <div class="text-center">
                                <label for="hr3-{{ student.id }}" class="text-xs font-medium text-slate-500 mb-1 block">3회</label>
                                <select id="hr3-{{ student.id }}" class="heart-rate-select w-16 md:w-20 bg-white border border-slate-300 rounded-md shadow-sm py-1.5 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" data-field="step_test_heart_rate_3" data-original="{{ student.measurement_data.step_test_heart_rate_3|default:"" }}">
                                    <option value="">--</option>
                                </select>
                            </div>
                            </div>
                        </div>
                    </div>

                </div>
                {% empty %}
                <div class="p-6 text-center text-slate-500">
                    학생 목록이 없습니다.
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- 전체 저장 버튼 -->
        <div class="p-4 md:p-6 bg-slate-50 border-t border-slate-200">
            <button id="batch-save-btn" class="w-full bg-gray-400 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 cursor-not-allowed" disabled>
                전체 저장하기
            </button>
        </div>
    </div>
</div>

<!-- 저장 완료 토스트 -->
<div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

<style>
/* Mini toggle switch styles for individual students */
.mini-toggle-label {
    width: 80px;
    height: 28px;
    position: relative;
    display: inline-block;
    background: #e2e8f0;
    border-radius: 9999px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.mini-toggle-label:before {
    content: '';
    position: absolute;
    width: 36px;
    height: 20px;
    border-radius: 9999px;
    top: 4px;
    left: 4px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

input:checked + .mini-toggle-label {
    background: #3b82f6;
}

input:checked + .mini-toggle-label:before {
    transform: translateX(36px);
}

.mini-toggle-text {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    font-weight: 500;
    user-select: none;
    transition: color 0.2s ease-in-out;
}

.toggle-text-left {
    left: 8px;
    color: #1f2937;
}

.toggle-text-right {
    right: 8px;
    color: #6b7280;
}

input:checked + .mini-toggle-label .toggle-text-left {
    color: #6b7280;
}

input:checked + .mini-toggle-label .toggle-text-right {
    color: #1f2937;
}
</style>

{% load static %}
<script type="module">
import { showToast, saveStudentRecord } from '{% static "js/physical_education/measure/common.js" %}';

(function() {
    // DOM elements
    const studentContainer = document.getElementById('student-list-container');
    const batchSaveBtn = document.getElementById('batch-save-btn');
    const measuredCountElement = document.getElementById('measured-count');
    
    if (!studentContainer || !batchSaveBtn) {
        console.error('PAPS step test template not properly loaded');
        return;
    }

    // Context data from Django
    const contextData = {
        sessionId: '{{ session_id }}',
        activityId: '{{ activity_id }}',
        csrfToken: '{{ csrf_token }}'
    };

    // Data tracking - now includes individual palpation per student
    let originalData = {
        students: {}
    };
    
    let currentData = {
        students: {}
    };

    // Initialize
    init();

    function init() {
        setupInitialData();
        setupDropdownOptions();
        setupEventListeners();
        updateSaveButtonState();
    }

    function setupInitialData() {
        // Initialize student data with individual palpation states
        const students = document.querySelectorAll('[data-student-id]');
        students.forEach(studentElement => {
            const studentId = studentElement.dataset.studentId;
            const palpationToggle = studentElement.querySelector('.student-palpation-toggle');
            const hr1 = studentElement.querySelector('[data-field="step_test_heart_rate_1"]')?.dataset.original || '';
            const hr2 = studentElement.querySelector('[data-field="step_test_heart_rate_2"]')?.dataset.original || '';
            const hr3 = studentElement.querySelector('[data-field="step_test_heart_rate_3"]')?.dataset.original || '';
            
            // Parse palpation from data-original attribute (handles 'true'/'false' strings)
            const palpationOriginal = palpationToggle?.dataset.original;
            const palpation = palpationOriginal === 'True' || palpationOriginal === 'true';
            
            const studentData = {
                palpation: palpation,
                hr1: hr1 ? parseInt(hr1) : null,
                hr2: hr2 ? parseInt(hr2) : null,
                hr3: hr3 ? parseInt(hr3) : null
            };
            
            originalData.students[studentId] = { ...studentData };
            currentData.students[studentId] = { ...studentData };
        });
    }

    function createDropdownOptions(isPalpation) {
        let options = '<option value="">--</option>';
        const min = isPalpation ? 20 : 40;
        const max = isPalpation ? 125 : 250;
        
        for (let i = min; i <= max; i++) {
            options += `<option value="${i}">${i}</option>`;
        }
        return options;
    }

    function setupDropdownOptions() {
        // Setup options for each student based on their individual palpation state
        const students = document.querySelectorAll('[data-student-id]');
        students.forEach(studentElement => {
            const studentId = studentElement.dataset.studentId;
            const isPalpation = currentData.students[studentId].palpation;
            updateStudentDropdowns(studentId, isPalpation);
        });
    }

    function updateStudentDropdowns(studentId, isPalpation) {
        const studentElement = document.querySelector(`[data-student-id="${studentId}"]`);
        if (!studentElement) return;
        
        const optionsHtml = createDropdownOptions(isPalpation);
        const selects = studentElement.querySelectorAll('.heart-rate-select');
        
        selects.forEach(select => {
            const field = select.dataset.field;
            const fieldKey = field === 'step_test_heart_rate_1' ? 'hr1' : 
                            field === 'step_test_heart_rate_2' ? 'hr2' : 'hr3';
            
            // Get the actual value from currentData, not from select.value
            const dataValue = currentData.students[studentId][fieldKey];
            
            select.innerHTML = optionsHtml;
            
            // Set the value from data
            if (dataValue !== null && select.querySelector(`option[value="${dataValue}"]`)) {
                select.value = dataValue;
            } else {
                select.value = '';
                // If value is not in range, clear it from data too
                if (dataValue !== null) {
                    currentData.students[studentId][fieldKey] = null;
                }
            }
        });
    }

    function setupEventListeners() {
        // Individual palpation toggle changes
        studentContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('student-palpation-toggle')) {
                const studentId = e.target.closest('[data-student-id]').dataset.studentId;
                const isPalpation = e.target.checked;
                
                // Update data
                currentData.students[studentId].palpation = isPalpation;
                
                // Update that student's dropdowns
                updateStudentDropdowns(studentId, isPalpation);
                
                // Check save button state
                updateSaveButtonState();
            }
            else if (e.target.classList.contains('heart-rate-select')) {
                const studentId = e.target.closest('[data-student-id]').dataset.studentId;
                const field = e.target.dataset.field;
                const value = e.target.value ? parseInt(e.target.value) : null;
                
                const fieldKey = field === 'step_test_heart_rate_1' ? 'hr1' : 
                                field === 'step_test_heart_rate_2' ? 'hr2' : 'hr3';
                
                currentData.students[studentId][fieldKey] = value;
                updateSaveButtonState();
                updateMeasuredCount();
            }
        });

        // Batch save button
        batchSaveBtn.addEventListener('click', handleBatchSave);
    }

    function hasChanges() {
        // Check individual student changes
        for (const studentId in currentData.students) {
            const original = originalData.students[studentId];
            const current = currentData.students[studentId];
            
            if (JSON.stringify(original) !== JSON.stringify(current)) {
                return true;
            }
        }
        
        return false;
    }

    function getChangedStudents() {
        const changed = [];
        
        for (const studentId in currentData.students) {
            const original = originalData.students[studentId];
            const current = currentData.students[studentId];
            
            if (JSON.stringify(original) !== JSON.stringify(current)) {
                // Check if this is a palpation-only change
                const palpationChanged = original.palpation !== current.palpation;
                
                // If palpation changed but no heart rates exist, still allow save
                if (palpationChanged && 
                    original.hr1 === null && original.hr2 === null && original.hr3 === null &&
                    current.hr1 === null && current.hr2 === null && current.hr3 === null) {
                    // Save with empty heart rates but updated palpation
                    changed.push({
                        student_id: studentId,
                        measurement_data: {
                            is_palpation: current.palpation,
                            step_test_heart_rate_1: null,
                            step_test_heart_rate_2: null,
                            step_test_heart_rate_3: null
                        }
                    });
                } 
                // If heart rates exist, require all 3 to be filled
                else if (current.hr1 !== null && current.hr2 !== null && current.hr3 !== null) {
                    changed.push({
                        student_id: studentId,
                        measurement_data: {
                            is_palpation: current.palpation,
                            step_test_heart_rate_1: current.hr1,
                            step_test_heart_rate_2: current.hr2,
                            step_test_heart_rate_3: current.hr3
                        }
                    });
                }
            }
        }
        
        return changed;
    }

    function updateSaveButtonState() {
        const hasAnyChanges = hasChanges();
        const changedStudents = getChangedStudents();
        
        if (hasAnyChanges && changedStudents.length > 0) {
            batchSaveBtn.disabled = false;
            batchSaveBtn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50';
        } else {
            batchSaveBtn.disabled = true;
            batchSaveBtn.className = 'w-full bg-gray-400 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 cursor-not-allowed';
        }
    }

    async function handleBatchSave() {
        const changedStudents = getChangedStudents();
        
        if (changedStudents.length === 0) {
            showToast('저장할 변경사항이 없습니다.', 'info');
            return;
        }

        batchSaveBtn.disabled = true;
        batchSaveBtn.textContent = '저장 중...';

        let successCount = 0;
        let errorCount = 0;

        // Save each student
        for (const studentData of changedStudents) {
            try {
                const result = await saveStudentRecord(
                    studentData.student_id,
                    studentData.measurement_data,
                    contextData.sessionId,
                    contextData.activityId,
                    contextData.csrfToken
                );
                
                if (result.success) {
                    successCount++;
                } else {
                    errorCount++;
                    console.error(`Failed to save student ${studentData.student_id}:`, result.error);
                }
            } catch (error) {
                errorCount++;
                console.error(`Error saving student ${studentData.student_id}:`, error);
            }
        }

        // Update UI and original data after successful saves
        if (successCount > 0) {
            // Update original data to current state
            originalData = JSON.parse(JSON.stringify(currentData));
            
            // Update measured count
            updateMeasuredCount();
            
            showToast(`저장 완료: 성공 ${successCount}건${errorCount > 0 ? `, 오류 ${errorCount}건` : ''}`);
        } else {
            showToast('저장에 실패했습니다.', 'error');
        }

        batchSaveBtn.textContent = '전체 저장하기';
        updateSaveButtonState();
    }

    function updateMeasuredCount() {
        let measuredCount = 0;
        
        for (const studentId in currentData.students) {
            const student = currentData.students[studentId];
            if (student.hr1 !== null && student.hr2 !== null && student.hr3 !== null) {
                measuredCount++;
            }
        }
        
        if (measuredCountElement) {
            measuredCountElement.textContent = `${measuredCount}명`;
        }
    }

})();
</script>