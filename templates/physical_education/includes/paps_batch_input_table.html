<!-- PAPS 일괄입력 Tabulator 테이블 컴포넌트 -->

<!-- Tabulator CSS -->
<link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">

<!-- 테이블 컨테이너 -->
<div id="batch-input-table-container" class="bg-white rounded-lg shadow-sm border border-gray-200 hidden">
    <!-- 헤더 (고정 높이) -->
    <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 rounded-t-lg" style="min-height: 80px;">
        <div class="flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">
                <span id="table-students-count">0</span>명의 학생 측정 데이터
            </h3>
            <div class="flex gap-2 text-sm">
                <button id="clear-modified-btn" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-eraser mr-2"></i>변경사항 초기화
                </button>
            </div>
        </div>
        
        <!-- 테이블 정보 -->
        <div class="mt-2 text-sm text-gray-600">
            <span id="table-info-text">측정 항목을 선택하면 테이블이 표시됩니다.</span>
        </div>
    </div>
    
    <!-- Tabulator Table -->
    <div class="p-4">
        <div class="table-scroll-container">
            <div id="batch-input-tabulator-table">
                <!-- Tabulator 테이블이 여기에 동적으로 생성됩니다 -->
            </div>
        </div>
    </div>
</div>

<!-- Tabulator JS -->
<script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>

<script>
// PAPS 일괄입력 Tabulator 컴포넌트
const BatchInputTable = {
    table: null,
    currentData: [],
    originalData: [],
    modifiedRows: new Set(),
    
    // 초기화
    init() {
        this.setupEventListeners();
        console.log('PAPS 일괄입력 테이블 컴포넌트 초기화 완료');
    },
    
    // 이벤트 리스너 설정
    setupEventListeners() {
        const clearBtn = document.getElementById('clear-modified-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => this.clearModifications());
        }
    },
    
    // 테이블 생성
    async createTable(sessionId, activityIds, grade) {
        try {
            // 데이터 로딩
            const data = await this.loadTableData(sessionId, activityIds, grade);
            
            if (!data.success) {
                this.showError(data.error);
                return;
            }
            
            // 기존 테이블 제거
            if (this.table) {
                this.table.destroy();
                this.table = null;
            }
            
            // 컬럼 생성
            const columns = this.buildColumns(data.columns, data.activity_info);
            
            // Tabulator 테이블 생성
            this.table = new Tabulator("#batch-input-tabulator-table", {
                data: data.students,
                columns: columns,
                height: "60vh",
                maxHeight: "60vh",
                layout: "fitData",
                virtualDom: true,
                editTriggerEvent: "click",
                validationMode: "blocking",
                locale: "ko-kr",
                langs: {
                    "ko-kr": {
                        "columns": {
                            "name": "이름",
                        },
                        "ajax": {
                            "loading": "로딩중...",
                            "error": "오류",
                        },
                        "pagination": {
                            "page_size": "페이지 크기",
                            "first": "처음",
                            "last": "마지막",
                            "prev": "이전",
                            "next": "다음",
                        }
                    }
                },
                cellEdited: (cell) => this.onCellEdited(cell),
                validationFailed: (cell, value, validators) => this.onValidationFailed(cell, value, validators),
                tableBuilt: () => this.onTableBuilt(),
            });
            
            // 데이터 저장
            this.currentData = data.students;
            this.originalData = JSON.parse(JSON.stringify(data.students));
            this.modifiedRows.clear();
            
            // UI 업데이트
            this.updateTableInfo(data);
            this.showTableContainer();
            
            console.log('테이블 생성 완료:', data.total_students, '명,', data.total_columns, '개 컬럼');
            
        } catch (error) {
            console.error('테이블 생성 오류:', error);
            this.showError('테이블을 생성하는 중 오류가 발생했습니다.');
        }
    },
    
    // 테이블 데이터 로딩
    async loadTableData(sessionId, activityIds, grade) {
        const response = await fetch('/physical_education/api/paps/get-batch-records/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': djangoData.csrfToken
            },
            body: JSON.stringify({
                session_id: sessionId,
                activity_ids: activityIds,
                grade: grade
            })
        });
        
        return await response.json();
    },
    
    // 컬럼 생성
    buildColumns(columns, activityInfo) {
        // 기본 컬럼들 (Frozen Columns)
        const baseColumns = [
            {
                title: "학년도",
                field: "school_year",
                width: 80,
                headerSort: false,
                cssClass: "text-center",
                frozen: true
            },
            {
                title: "학년",
                field: "grade_display", 
                width: 60,
                headerSort: false,
                cssClass: "text-center",
                frozen: true
            },
            {
                title: "반명",
                field: "class_name",
                width: 60,
                headerSort: false,
                cssClass: "text-center",
                frozen: true
            },
            {
                title: "번호",
                field: "student_number",
                width: 60,
                headerSort: false,
                cssClass: "text-center",
                frozen: true
            },
            {
                title: "성명",
                field: "student_name",
                width: 100,
                headerSort: false,
                cssClass: "text-center font-medium",
                frozen: true
            }
        ];
        
        // 측정 항목별 컬럼 그룹 생성
        const measurementColumns = this.buildMeasurementColumns(columns, activityInfo);
        
        return [...baseColumns, ...measurementColumns];
    },
    
    // 측정항목별 컬럼 생성 (평면 구조)
    buildMeasurementColumns(columns, activityInfo) {
        const measurementColumns = [];
        
        // 각 컬럼을 평면 구조로 생성
        columns.forEach(col => {
            const fieldKey = `${col.activity_id}_${col.field}`;
            const columnDef = {
                title: `${col.name}`,
                field: fieldKey,
                width: Math.max(150, (col.activity_name + col.name).length * 8 + 60),
                headerSort: false,
                cssClass: "text-center editable-cell",
                editable: true,
                editor: this.getEditorType(col.type),
                editorParams: this.getEditorParams(col),
                validator: this.getValidators(col),
                formatter: (cell) => this.formatCell(cell, col)
            };
            
            measurementColumns.push(columnDef);
        });
        
        return measurementColumns;
    },
    
    // 에디터 타입 결정
    getEditorType(type) {
        switch (type) {
            case 'decimal':
            case 'integer':
                return "number";
            case 'boolean':
                return "tickCross";
            default:
                return "input";
        }
    },
    
    // 에디터 파라미터 설정
    getEditorParams(col) {
        const params = {};
        
        if (col.type === 'decimal' || col.type === 'integer') {
            if (col.validation.min !== null) params.min = col.validation.min;
            if (col.validation.max !== null) params.max = col.validation.max;
            if (col.type === 'decimal' && col.validation.decimal_places) {
                params.step = Math.pow(10, -col.validation.decimal_places);
            }
        }
        
        return params;
    },
    
    // 유효성 검증 설정
    getValidators(col) {
        const validators = [];
        
        if (col.validation.required) {
            validators.push("required");
        }
        
        if (col.type === 'decimal' || col.type === 'integer') {
            validators.push("numeric");
            if (col.validation.min !== null) {
                validators.push({type: "min", parameters: col.validation.min});
            }
            if (col.validation.max !== null) {
                validators.push({type: "max", parameters: col.validation.max});
            }
        }
        
        return validators;
    },
    
    // 셀 포맷팅
    formatCell(cell, col) {
        const value = cell.getValue();
        if (value === null || value === undefined || value === '') {
            return '';
        }
        
        if (col.type === 'decimal' && col.validation.decimal_places) {
            const num = parseFloat(value);
            return isNaN(num) ? value : num.toFixed(col.validation.decimal_places);
        }
        
        return value;
    },
    
    // 셀 편집 이벤트 처리
    onCellEdited(cell, columnInfo = null) {
        const row = cell.getRow();
        const studentId = row.getData().student_id;
        
        // 변경된 행 추적
        this.modifiedRows.add(studentId);
        
        // 행 스타일 업데이트
        row.getElement().classList.add('row-modified');
        
        // 저장 버튼 활성화
        this.updateSaveButtonState();
        
        // 변경사항 초기화 버튼 활성화
        const clearBtn = document.getElementById('clear-modified-btn');
        if (clearBtn) {
            clearBtn.disabled = false;
        }
        
        console.log('셀 편집됨:', {
            student: studentId,
            field: cell.getField(),
            value: cell.getValue(),
            totalModified: this.modifiedRows.size
        });
    },
    
    // 유효성 검증 실패 처리
    onValidationFailed(cell, value, validators) {
        const field = cell.getField();
        const errorMessage = `유효하지 않은 값: ${value}`;
        
        // 에러 표시
        cell.getElement().style.backgroundColor = '#fee2e2';
        cell.getElement().title = errorMessage;
        
        console.warn('유효성 검증 실패:', {
            field: field,
            value: value,
            validators: validators
        });
        
        // 일정 시간 후 스타일 제거
        setTimeout(() => {
            cell.getElement().style.backgroundColor = '';
            cell.getElement().title = '';
        }, 3000);
    },
    
    // 테이블 빌드 완료 처리
    onTableBuilt() {
        console.log('테이블 빌드 완료');
        this.updateTableInfo();
    },
    
    // 변경사항 초기화
    clearModifications() {
        if (this.modifiedRows.size === 0) return;
        
        if (!confirm('모든 변경사항을 초기화하시겠습니까?')) return;
        
        // 데이터 복원
        this.table.setData(JSON.parse(JSON.stringify(this.originalData)));
        
        // 변경 추적 초기화
        this.modifiedRows.clear();
        
        // UI 업데이트
        this.updateSaveButtonState();
        const clearBtn = document.getElementById('clear-modified-btn');
        if (clearBtn) {
            clearBtn.disabled = true;
        }
        
        console.log('변경사항 초기화됨');
        
        if (typeof showMessage === 'function') {
            showMessage('success', '변경사항이 초기화되었습니다.');
        }
    },
    
    // 변경된 데이터 가져오기
    getModifiedData() {
        const allData = this.table.getData();
        const modifiedData = [];
        
        this.modifiedRows.forEach(studentId => {
            const studentData = allData.find(row => row.student_id === studentId);
            if (studentData) {
                modifiedData.push(studentData);
            }
        });
        
        return modifiedData;
    },
    
    // 저장 버튼 상태 업데이트
    updateSaveButtonState() {
        const saveBtn = document.getElementById('save-btn');
        if (saveBtn) {
            saveBtn.disabled = this.modifiedRows.size === 0;
        }
    },
    
    // 테이블 정보 업데이트
    updateTableInfo(data = null) {
        const countEl = document.getElementById('table-students-count');
        const infoEl = document.getElementById('table-info-text');
        
        if (data) {
            if (countEl) countEl.textContent = data.total_students;
            if (infoEl) {
                infoEl.textContent = `${data.total_columns}개 측정 항목 표시 중`;
            }
        }
    },
    
    // 테이블 컨테이너 표시
    showTableContainer() {
        const container = document.getElementById('batch-input-table-container');
        if (container) {
            container.classList.remove('hidden');
        }
    },
    
    // 테이블 컨테이너 숨김
    hideTableContainer() {
        const container = document.getElementById('batch-input-table-container');
        if (container) {
            container.classList.add('hidden');
        }
    },
    
    // 에러 표시
    showError(message) {
        if (typeof showMessage === 'function') {
            showMessage('error', message);
        } else {
            console.error('테이블 오류:', message);
        }
    }
};

// 전역 함수들 (기존 코드와의 호환성)
function createBatchInputTable(sessionId, activityIds, grade) {
    return BatchInputTable.createTable(sessionId, activityIds, grade);
}

function getBatchModifiedData() {
    return BatchInputTable.getModifiedData();
}

function clearBatchModifications() {
    return BatchInputTable.clearModifications();
}

// DOM 로드 후 초기화
document.addEventListener('DOMContentLoaded', () => {
    BatchInputTable.init();
});

console.log('PAPS 일괄입력 Tabulator 컴포넌트 로드 완료');
</script>

<style>
/* 일괄입력 테이블 스타일 */
.table-scroll-container {
    width: 100%;
    max-width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    position: relative;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    /* 스크롤바가 나타나도록 강제 */
    white-space: nowrap;
}

/* Tabulator 컶테이너 내 제약 */
.table-scroll-container .tabulator {
    border: none;
    border-radius: 0;
    min-width: max-content;
}

.table-scroll-container .tabulator .tabulator-tableholder {
    overflow: visible;
}

.table-scroll-container .tabulator .tabulator-table {
    min-width: max-content;
}

/* Removed .activity-group-header as we no longer use column groups */

.editable-cell {
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-size: 12px !important;
}

.editable-cell:hover {
    background-color: #f1f5f9 !important;
}

.row-modified {
    background-color: #fef3c7 !important;
}

.row-modified td {
    border-left: 3px solid #f59e0b !important;
}

/* Tabulator 스타일 개선 */
.tabulator {
    font-size: 12px !important;
}

.tabulator-col-title {
    font-size: 12px !important;
    padding: 0.5rem;
}

.tabulator-cell {
    padding: 0.5rem;
    font-size: 12px !important;
}

.tabulator-row:hover {
    background-color: #e7f3ff !important;
}

.tabulator-row.tabulator-selected {
    background-color: #d1e7fd !important;
}

/* 유효성 검증 실패 스타일 */
.tabulator-validation-fail {
    border: 2px solid #dc2626 !important;
    background-color: #fef2f2 !important;
}

/* 편집 중 스타일 */
.tabulator-editing {
    border: 2px solid #3b82f6 !important;
    background-color: #eff6ff !important;
}

/* Frozen columns 스타일 개선 */
.tabulator-frozen {
    background-color: #f8f9fa !important;
    position: sticky !important;
    z-index: 10;
}

.tabulator-frozen-left {
    border-right: 3px solid #dee2e6 !important;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

.tabulator-col.tabulator-frozen {
    background-color: #f8f9fa !important;
}

/* 반응형 조정 */
@media (max-width: 768px) {
    .tabulator {
        font-size: 0.875rem;
    }
    
    .tabulator-cell {
        padding: 6px 8px;
    }
}
</style>