{% extends 'points/teacher/base.html' %} {% block title %}정책 관리 - 포인트
관리 시스템{% endblock %} {% block page_content %}
<!-- Toast Container -->
<div id="toaster" class="toaster"></div>
{% csrf_token %}

<div class="max-w-7xl mx-auto">
  <!-- 페이지 헤더 -->
  <div class="mb-8 flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">정책 관리</h1>
      <p class="mt-2 text-gray-600">포인트 정책을 생성하고 관리하세요.</p>
    </div>
    <button
      type="button"
      class="btn-primary"
      data-action="open-create-dialog"
    >
      <i data-lucide="plus" class="w-4 h-4"></i>
      <span>새 정책 추가</span>
    </button>
  </div>

  <!-- 정책 카드 그리드 -->
  <div class="policy-card-container grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for policy in policies %}
    <div class="card"
         data-policy-id="{{ policy.id }}"
         data-policy-name="{{ policy.name }}"
         data-policy-value="{{ policy.default_point_value }}"
         data-policy-description="{{ policy.description|default:"" }}"
         data-policy-active="{{ policy.is_active|lower }}">
      <header>
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">{{ policy.name }}</h3>
          {% if policy.is_active %}
          <span class="badge badge-primary">활성</span>
          {% else %}
          <span class="badge badge-secondary">비활성</span>
          {% endif %}
        </div>
      </header>
      <section>
        <div class="mb-4">
          <p class="text-3xl font-bold text-gray-900">
            {% if policy.default_point_value > 0 %}
            <span class="text-emerald-600"
              >+{{ policy.default_point_value }}P</span
            >
            {% elif policy.default_point_value < 0 %}
            <span class="text-red-600">{{ policy.default_point_value }}P</span>
            {% else %}
            <span class="text-gray-600">{{ policy.default_point_value }}P</span>
            {% endif %}
          </p>
        </div>
        <p class="text-sm text-gray-600">
          {{ policy.description|default:"설명 없음" }}
        </p>
      </section>
      <footer class="flex gap-2">
        <button
          type="button"
          class="btn-outline flex-1"
          data-action="edit-policy"
          data-policy-id="{{ policy.id }}"
        >
          <i data-lucide="edit" class="w-4 h-4"></i>
          <span>수정</span>
        </button>
        <button
          type="button"
          class="btn-destructive flex-1"
          data-action="delete-policy"
          data-policy-id="{{ policy.id }}"
          data-policy-name="{{ policy.name|escapejs }}"
        >
          <i data-lucide="trash-2" class="w-4 h-4"></i>
          <span>삭제</span>
        </button>
      </footer>
    </div>
    {% empty %}
    <div class="col-span-full text-center py-12">
      <i data-lucide="inbox" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i>
      <p class="text-gray-500 text-lg">아직 정책이 없습니다</p>
      <p class="text-gray-400 text-sm mt-2">새 정책을 추가하여 시작하세요.</p>
    </div>
    {% endfor %}
  </div>
</div>

<!-- 정책 생성 Dialog -->
<dialog
  id="create-policy-dialog"
  class="dialog"
  aria-labelledby="create-dialog-title"
  onclick="if (event.target === this) this.close()"
>
  <article>
    <header>
      <h2 id="create-dialog-title">새 정책 추가</h2>
      <p class="text-sm text-gray-600">포인트 정책 정보를 입력하세요.</p>
    </header>
    <section>
      <form id="create-policy-form" class="space-y-4">
        <!-- 활동명 -->
        <div>
          <label
            for="create-name"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            활동명 <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="create-name"
            name="name"
            required
            placeholder="예: 출석 체크, 숙제 제출"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <!-- 포인트 값 -->
        <div>
          <label
            for="create-point-value"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            포인트 값 <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            id="create-point-value"
            name="default_point_value"
            required
            placeholder="양수는 적립, 음수는 차감"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <p class="text-xs text-gray-500 mt-1">💡 양수는 적립, 음수는 차감</p>
        </div>

        <!-- 설명 -->
        <div>
          <label
            for="create-description"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            설명 (선택)
          </label>
          <textarea
            id="create-description"
            name="description"
            rows="3"
            placeholder="정책에 대한 상세 설명을 입력하세요"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          ></textarea>
        </div>

        <!-- 활성화 여부 -->
        <div class="flex items-center gap-2">
          <input
            type="checkbox"
            id="create-is-active"
            name="is_active"
            checked
            class="w-4 h-4"
          />
          <label for="create-is-active" class="text-sm text-gray-700">
            이 정책을 활성화합니다
          </label>
        </div>
      </form>
    </section>
    <footer class="flex gap-2">
      <button
        type="button"
        class="btn-outline flex-1"
        onclick="this.closest('dialog').close()"
      >
        취소
      </button>
      <button
        type="button"
        class="btn-primary flex-1"
        data-action="save-create"
      >
        저장
      </button>
    </footer>
  </article>
</dialog>

<!-- 정책 수정 Dialog -->
<dialog
  id="edit-policy-dialog"
  class="dialog"
  aria-labelledby="edit-dialog-title"
  onclick="if (event.target === this) this.close()"
>
  <article>
    <header>
      <h2 id="edit-dialog-title">정책 수정</h2>
      <p class="text-sm text-gray-600">포인트 정책 정보를 수정하세요.</p>
    </header>
    <section>
      <form id="edit-policy-form" class="space-y-4">
        <input type="hidden" id="edit-policy-id" name="policy_id" />

        <!-- 활동명 -->
        <div>
          <label
            for="edit-name"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            활동명 <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="edit-name"
            name="name"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <!-- 포인트 값 -->
        <div>
          <label
            for="edit-point-value"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            포인트 값 <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            id="edit-point-value"
            name="default_point_value"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <p class="text-xs text-gray-500 mt-1">💡 양수는 적립, 음수는 차감</p>
        </div>

        <!-- 설명 -->
        <div>
          <label
            for="edit-description"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            설명 (선택)
          </label>
          <textarea
            id="edit-description"
            name="description"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          ></textarea>
        </div>

        <!-- 활성화 여부 -->
        <div class="flex items-center gap-2">
          <input
            type="checkbox"
            id="edit-is-active"
            name="is_active"
            class="w-4 h-4"
          />
          <label for="edit-is-active" class="text-sm text-gray-700">
            이 정책을 활성화합니다
          </label>
        </div>
      </form>
    </section>
    <footer class="flex gap-2">
      <button
        type="button"
        class="btn-outline flex-1"
        onclick="this.closest('dialog').close()"
      >
        취소
      </button>
      <button
        type="button"
        class="btn-primary flex-1"
        data-action="save-edit"
      >
        저장
      </button>
    </footer>
  </article>
</dialog>

<!-- 정책 삭제 Alert Dialog -->
<dialog
  id="delete-policy-dialog"
  class="dialog"
  aria-labelledby="delete-dialog-title"
>
  <article>
    <header>
      <h2 id="delete-dialog-title" class="text-lg font-semibold text-red-600">
        정책 삭제 확인
      </h2>
    </header>
    <section>
      <input type="hidden" id="delete-policy-id" />
      <p id="delete-policy-message" class="text-gray-700"></p>
      <p class="text-sm text-gray-500 mt-2">
        이 정책과 관련된 거래 내역은 유지되지만, 앞으로 이 정책을 사용할 수
        없습니다.
      </p>
    </section>
    <footer class="flex gap-2">
      <button
        type="button"
        class="btn-outline flex-1"
        onclick="this.closest('dialog').close()"
      >
        취소
      </button>
      <button
        type="button"
        class="btn-destructive flex-1"
        data-action="confirm-delete"
      >
        삭제
      </button>
    </footer>
  </article>
</dialog>
{% endblock %}

{% block extra_js %}
<script type="module">
  import { initPolicyManagement } from '/static/js/pages/points/teacher/policy-management.js';

  document.addEventListener('DOMContentLoaded', () => {
    initPolicyManagement();
  });
</script>
{% endblock %}
