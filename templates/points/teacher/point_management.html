{% extends 'points/teacher/base.html' %}

{% block title %}포인트 부여/차감 - 포인트 관리 시스템{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css">
{% endblock %}

{% block page_content %}
<!-- Toast Container -->
<div id="toaster" class="toaster"></div>

<div class="max-w-7xl mx-auto">
  <!-- 페이지 헤더 -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">포인트 부여/차감</h1>
    <p class="mt-2 text-gray-600">학생들의 포인트를 관리하세요</p>
  </div>

  <!-- 액션 버튼 영역 -->
  <div class="flex justify-end mb-4">
    <button class="btn" id="manage-points-btn" disabled>
      <i data-lucide="plus-circle"></i>
      포인트 부여/차감
    </button>
  </div>

  <!-- 학생 목록 테이블 -->
  <div class="bg-white rounded-lg shadow p-6">
    <table id="students-table"></table>
  </div>
</div>

<!-- 포인트 부여/차감 Dialog -->
<dialog
  id="manage-points-dialog"
  class="dialog"
  aria-labelledby="manage-points-title"
  onclick="if (event.target === this) this.close()"
>
  <article>
    <header>
      <h2 id="manage-points-title">포인트 부여/차감</h2>
      <p class="text-sm text-gray-600">선택한 <span id="selected-student-count">0</span>명의 학생에게 포인트를 처리합니다.</p>
    </header>
    <section>
      <form id="manage-points-form" class="space-y-4">
        <!-- 포인트 정책 선택 -->
        <div>
          <label
            for="policy-select"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            포인트 정책 <span class="text-red-500">*</span>
          </label>
          <select
            id="policy-select"
            name="policy_id"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="">정책을 선택하세요</option>
            {% for policy in policies %}
            <option
              value="{{ policy.id }}"
              data-point-value="{{ policy.default_point_value }}"
            >
              {{ policy.name }} ({{ policy.default_point_value|stringformat:"+d" }}P)
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- 포인트 값 -->
        <div>
          <label
            for="point-value-input"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            포인트 값 <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            id="point-value-input"
            name="point_value"
            required
            placeholder="정책을 선택하면 자동으로 입력됩니다"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <p class="text-xs text-gray-500 mt-1">💡 양수는 부여, 음수는 차감</p>
        </div>

        <!-- 사유 -->
        <div>
          <label
            for="reason-input"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            사유 (선택)
          </label>
          <textarea
            id="reason-input"
            name="reason"
            rows="3"
            placeholder="포인트 부여/차감 사유를 입력하세요 (예: 출석 체크, 숙제 미제출)"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          ></textarea>
        </div>

        <!-- 학생 ID 저장 (hidden) -->
        <input type="hidden" id="selected-student-ids" name="student_ids" />
      </form>
    </section>
    <footer class="flex gap-2">
      <button
        type="button"
        class="btn-outline flex-1"
        onclick="this.closest('dialog').close()"
      >
        취소
      </button>
      <button
        type="button"
        id="save-points-btn"
        class="btn-primary flex-1"
        disabled
      >
        저장
      </button>
    </footer>
  </article>
</dialog>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" type="text/javascript"></script>
{% include 'points/scripts/teacher/point_management_script.html' %}
{% endblock %}
